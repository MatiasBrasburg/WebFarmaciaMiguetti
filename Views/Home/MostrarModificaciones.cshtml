@using System.Text.Json
@using WebFarmaciaMiguetti.Models

@{
    ViewData["Title"] = "Gesti√≥n de Liquidaciones";
    var listaMandatarias = (ViewBag.Mandatarias as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var listaObrasSociales = (ViewBag.ObrasSociales as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();

    if (listaObrasSociales.Any())
    {
        try { listaObrasSociales = listaObrasSociales.OrderBy(x => x.Nombre).ToList(); } catch { }
    }
}

<style>
    body { font-family: 'Verdana', sans-serif; background-color: #f4f6f9; color: #000; }
    h1 { font-size: 2.5rem; font-weight: 900; color: #000; margin-bottom: 20px; text-transform: uppercase; }
    
    .form-control, .form-select {
        border: 3px solid #6c757d; font-size: 1.2rem; padding: 10px; color: #000; font-weight: 500;
    }
    .form-control:focus, .form-select:focus {
        border-color: #ffc107; box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.5); background-color: #fff3cd;
    }
    .form-label { font-weight: 900; font-size: 1.1rem; text-transform: uppercase; }
    .btn-super { font-size: 1.1rem; font-weight: 800; padding: 10px 20px; border: 3px solid rgba(0,0,0,0.2); text-transform: uppercase; }
    
    .table-bordered { border: 2px solid #000; }
    .table thead th { background-color: #343a40; color: white; font-size: 1.1rem; vertical-align: middle; }
    .table tbody td { font-size: 1.1rem; vertical-align: middle; font-weight: 500; }

    .total-display { font-size: 1.8rem; font-weight: 900; color: #198754; text-align: right; padding: 15px; background: #d1e7dd; border: 4px solid #198754; border-radius: 8px; }

    /* ESTILO VISOR */
    .visor-header { background-color: #0dcaf0; color: #000; padding: 15px; border-bottom: 4px solid #000; font-size: 1.3rem; font-weight: bold; }
    
    /* ESTILO MINI-MODAL (ITEM) */
    .modal-item-header { background-color: #ffc107; color: #000; border-bottom: 3px solid #000; }
</style>

<div class="container-fluid mt-4">
    <h1>üìö GESTI√ìN DE PRESENTACIONES (LIQUIDACIONES)</h1>

    <div class="card mb-4" style="border: 3px solid #6c757d; background-color: #e2e3e5;">
        <div class="card-body">
            <h4 class="mb-3 fw-bold">üîç BUSCAR LIQUIDACIONES ANTERIORES</h4>
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">N¬∞ Liquidaci√≥n</label>
                    <input type="number" id="filtroId" class="form-control" placeholder="Ej: 105">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Fecha Desde</label>
                    <input type="date" id="filtroFechaDesde" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Fecha Hasta</label>
                    <input type="date" id="filtroFechaHasta" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Mandataria</label>
                    <select id="filtroMandataria" class="form-select">
                        <option value="0">-- TODAS --</option>
                        @foreach (var m in listaMandatarias)
                        {
                            <option value="@m.IdMandatarias">@m.RazonSocial</option>
                        }
                    </select>
                </div>
                <div class="col-md-2 d-grid align-items-end">
                    <button class="btn btn-primary btn-super" onclick="buscarLiquidaciones()">üîç BUSCAR</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card" style="border: 3px solid #000;">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center p-3">
            <h3 class="m-0 fw-bold">üìã LISTADO</h3>
            <button class="btn btn-success btn-super text-white" onclick="abrirModalNueva()">‚ûï NUEVA PRESENTACI√ìN</button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="tablaResultados">
                    <thead>
                        <tr><th>N¬∞</th><th>FECHA</th><th>MANDATARIA</th><th>OBSERVACIONES</th><th>ACCIONES</th></tr>
                    </thead>
                    <tbody id="tbodyResultados">
                        <tr><td colspan="5" class="text-center p-4 text-muted fs-4">Use los filtros para buscar...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalABM" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable"> 
        <div class="modal-content border-4 border-primary">
            <div class="modal-header bg-primary text-white">
                <h3 class="modal-title fw-bold" id="tituloModal">NUEVA LIQUIDACI√ìN</h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="row g-3 mb-4 p-3 border border-2 border-secondary rounded bg-white">
                    <input type="hidden" id="liqId" value="0"> 
                    <div class="col-md-3"><label class="form-label">üìÖ FECHA</label><input type="date" id="liqFecha" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")"></div>
                    <div class="col-md-5">
                        <label class="form-label">üè¢ MANDATARIA</label>
                        <select id="liqMandataria" class="form-select fw-bold">
                            <option value="0" disabled selected>-- SELECCIONE --</option>
                            @foreach (var m in listaMandatarias) { <option value="@m.IdMandatarias">@m.RazonSocial</option> }
                        </select>
                    </div>
                    <div class="col-md-4"><label class="form-label">üìù OBS</label><input type="text" id="liqObs" class="form-control"></div>
                </div>
                <div class="card border-info mb-4" style="border: 3px solid #0dcaf0;">
                    <div class="card-header bg-info text-dark fw-bold fs-5">‚ûï AGREGAR ITEMS</div>
                    <div class="card-body bg-white">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">Obra Social</label>
                                <select id="inputOS" class="form-select" onchange="cargarPlanesDeOS(this.value, 'inputPlan')">
                                    <option value="0">-- Seleccione O.S. --</option>
                                    @foreach (var os in listaObrasSociales) { <option value="@os.IdObrasSociales">@os.Nombre</option> }
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Plan</label>
                                <select id="inputPlan" class="form-select" disabled onchange="recalcularNeto('inputTotal', 'inputPlan', 'inputNeto', 'lblPorcentajeAplicado')">
                                    <option value="0">- Primero elija OS -</option>
                                </select>
                            </div>
                            <div class="col-md-2"><label class="form-label">Recetas</label><input type="number" id="inputRecetas" class="form-control" value="0"></div>
                        </div>
                        <div class="row g-3 mt-1 align-items-end">
                            <div class="col-md-3"><label class="form-label">Total ($)</label><input type="number" id="inputTotal" class="form-control" step="0.01" value="0.00" oninput="recalcularNeto('inputTotal', 'inputPlan', 'inputNeto', 'lblPorcentajeAplicado')"></div>
                            <div class="col-md-3"><label class="form-label">Cargo O.S.</label><input type="number" id="inputCargoOS" class="form-control" step="0.01" value="0.00"></div>
                            <div class="col-md-3">
                                <label class="form-label text-success">NETO ($)</label>
                                <input type="number" id="inputNeto" class="form-control fw-bold text-success border-success bg-light" readonly value="0.00">
                                <small class="text-muted" id="lblPorcentajeAplicado">Plan: 0%</small>
                            </div>
                            <div class="col-md-3"><button type="button" class="btn btn-success btn-super w-100" id="btnAgregarFila">‚¨áÔ∏è AGREGAR</button></div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive border border-2 border-dark rounded bg-white" style="min-height: 200px;">
                    <table class="table table-bordered mb-0">
                        <thead><tr><th>OS</th><th>PLAN</th><th>RECETAS</th><th>TOTAL</th><th>CARGO OS</th><th>NETO</th><th>ACCION</th></tr></thead>
                        <tbody id="tbodyDetalle"></tbody>
                    </table>
                </div>
                <div class="row mt-4 justify-content-end">
                    <div class="col-md-5"><div class="total-display">TOTAL: $<span id="spanTotalFinal">0.00</span></div></div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary btn-super" data-bs-dismiss="modal">‚ùå CANCELAR</button>
                <button type="button" class="btn btn-primary btn-super" id="btnGuardarTodo">üíæ GUARDAR TODO</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVerDetalle" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-4 border-info">
            <div class="modal-header bg-info text-white">
                <h3 class="modal-title fw-bold text-dark">üëÅÔ∏è CONSULTA Y EDICI√ìN</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-white p-0">
                <div class="visor-header">
                    <div class="row">
                        <div class="col-md-2">N¬∞: <span id="verId" class="fw-black text-danger">---</span></div>
                        <div class="col-md-3">FECHA: <span id="verFecha" class="fw-normal">---</span></div>
                        <div class="col-md-7">MANDATARIA: <span id="verMandataria" class="fw-black text-primary">---</span></div>
                    </div>
                </div>
                
                <div class="p-3 bg-light border-bottom border-2 border-dark d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2" style="flex: 1;">
                        <span class="fs-4">üîç</span>
                        <input type="text" id="buscadorDetalles" class="form-control" placeholder="Escriba nombre de Obra Social para filtrar..." onkeyup="filtrarDetalles()">
                    </div>
                    <button class="btn btn-success btn-super ms-3" onclick="abrirItemABM(0)">
                        ‚ûï AGREGAR √çTEM
                    </button>
                </div>

                <div class="table-responsive p-3">
                    <table class="table table-bordered table-striped mb-0">
                        <thead class="bg-dark text-white">
                            <tr><th>OBRA SOCIAL</th><th>PLAN</th><th>RECETAS</th><th>TOTAL BRUTO</th><th>CARGO O.S.</th><th>BONIFICACI√ìN</th><th>ACCIONES</th></tr>
                        </thead>
                        <tbody id="tbodyVerDetalle"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-lg btn-dark fw-bold px-5" data-bs-dismiss="modal">CERRAR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalItemIndividual" tabindex="-1" data-bs-backdrop="static" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-3 border-warning">
            <div class="modal-header modal-item-header">
                <h4 class="modal-title fw-bold" id="tituloModalItem">EDITAR √çTEM</h4>
                <button type="button" class="btn-close" onclick="cerrarModalItem()"></button>
            </div>
            <div class="modal-body bg-light">
                <input type="hidden" id="item_Id" value="0">
                <input type="hidden" id="item_IdLiquidacionPadre" value="0">
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Obra Social</label>
                        <select id="item_IdOS" class="form-select" onchange="cargarPlanesDeOS(this.value, 'item_IdPlan')">
                            <option value="0">-- Seleccione --</option>
                            @foreach (var os in listaObrasSociales) { <option value="@os.IdObrasSociales">@os.Nombre</option> }
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Plan</label>
                        <select id="item_IdPlan" class="form-select" disabled onchange="recalcularNeto('item_Total', 'item_IdPlan', 'item_Neto', 'item_lblPorc')">
                            <option value="0">- Primero OS -</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cant. Recetas</label>
                        <input type="number" id="item_Recetas" class="form-control" value="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Total ($)</label>
                        <input type="number" id="item_Total" class="form-control" step="0.01" value="0.00" oninput="recalcularNeto('item_Total', 'item_IdPlan', 'item_Neto', 'item_lblPorc')">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cargo O.S.</label>
                        <input type="number" id="item_CargoOS" class="form-control" step="0.01" value="0.00">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-success">Neto ($)</label>
                        <input type="number" id="item_Neto" class="form-control fw-bold bg-white" readonly value="0.00">
                        <small id="item_lblPorc">0%</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary fw-bold" onclick="cerrarModalItem()">CANCELAR</button>
                <button type="button" class="btn btn-warning fw-bold px-4" onclick="guardarItemIndividual()">üíæ GUARDAR CAMBIOS</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // =========================================================================
    // 1. VARIABLES & CONFIGURACI√ìN
    // =========================================================================
    let detallesTemporales = []; 
    let indiceTemporal = 0;      
    const modalABM = new bootstrap.Modal(document.getElementById('modalABM'));
    const modalVer = new bootstrap.Modal(document.getElementById('modalVerDetalle'));
    const modalItem = new bootstrap.Modal(document.getElementById('modalItemIndividual'));

    const mapaMandatarias = {};
    @foreach (var m in listaMandatarias) { @:mapaMandatarias["@m.IdMandatarias"] = "@Html.Raw(m.RazonSocial)";
    }

    // =========================================================================
    // 2. L√ìGICA COM√öN (PLANES & C√ÅLCULOS)
    // =========================================================================
    // Modificado para aceptar el ID del select destino (as√≠ sirve para ambos modales)
    async function cargarPlanesDeOS(idOS, idSelectDestino) {
        const selectPlan = document.getElementById(idSelectDestino);
        selectPlan.innerHTML = '<option value="0">Cargando...</option>';
        selectPlan.disabled = true;

        if (idOS == "0") { selectPlan.innerHTML = '<option value="0">- Primero OS -</option>'; return; }

        try {
            const url = `@Url.Action("ObtenerPlanesPorObrasSociales", "Home")?idObraSocial=${idOS}`;
            const response = await fetch(url);
            const data = await response.json();

            selectPlan.innerHTML = '<option value="0">-- Seleccione Plan --</option>';
            if (data.success && data.data.length > 0) {
                data.data.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.idPlanBonificacion;
                    option.text = plan.nombrePlan; 
                    option.setAttribute('data-bonif', plan.bonificacion); 
                    selectPlan.appendChild(option);
                });
                selectPlan.disabled = false;
            } else { selectPlan.innerHTML = '<option value="0">Sin planes</option>'; }
        } catch (error) { alert("Error cargando planes."); }
    }

    // Modificado para calcular en cualquier formulario (Alta o Edici√≥n)
    function recalcularNeto(idInputTotal, idSelectPlan, idInputNeto, idLbl) {
        const total = parseFloat(document.getElementById(idInputTotal).value) || 0;
        const select = document.getElementById(idSelectPlan);
        let porcentaje = 0;

        if (select.selectedIndex > 0) {
            porcentaje = parseFloat(select.options[select.selectedIndex].getAttribute('data-bonif')) || 0;
        }

        if(document.getElementById(idLbl)) document.getElementById(idLbl).textContent = `Plan: ${porcentaje}%`;
        const neto = total * (porcentaje / 100.0);
        document.getElementById(idInputNeto).value = neto.toFixed(2);
    }

    // =========================================================================
    // 3. L√ìGICA DE ALTA (TABLA TEMPORAL)
    // =========================================================================
    document.getElementById('btnAgregarFila').addEventListener('click', function() {
        const idOS = document.getElementById('inputOS').value;
        const nombreOS = document.getElementById('inputOS').options[document.getElementById('inputOS').selectedIndex].text;
        const idPlan = document.getElementById('inputPlan').value;
        const nombrePlan = document.getElementById('inputPlan').options[document.getElementById('inputPlan').selectedIndex]?.text || "-";
        const recetas = parseInt(document.getElementById('inputRecetas').value) || 0;
        const total = parseFloat(document.getElementById('inputTotal').value) || 0;
        const cargoOS = parseFloat(document.getElementById('inputCargoOS').value) || 0;
        const neto = parseFloat(document.getElementById('inputNeto').value) || 0;

        if (idOS == "0" || idPlan == "0") { alert("‚ö†Ô∏è Faltan datos."); return; }
        if (total <= 0) { alert("‚ö†Ô∏è Total debe ser mayor a 0."); return; }

        const nuevoDetalle = {
            idTemp: ++indiceTemporal,
            IdObrasSociales: parseInt(idOS),     
            IdPlanBonificacion: parseInt(idPlan), 
            CantidadRecetas: recetas,
            TotalBruto: total,
            MontoCargoOS: cargoOS,
            MontoBonificacion: neto,
            nombreOSVisual: nombreOS,
            nombrePlanVisual: nombrePlan
        };
        detallesTemporales.push(nuevoDetalle);
        dibujarTablaDetalles();
        
        // Reset Inputs
        document.getElementById('inputOS').value = "0";
        document.getElementById('inputPlan').innerHTML = '<option value="0">- Primero OS -</option>';
        document.getElementById('inputPlan').disabled = true;
        document.getElementById('inputRecetas').value = "0";
        document.getElementById('inputTotal').value = "0.00";
        document.getElementById('inputCargoOS').value = "0.00";
        document.getElementById('inputNeto').value = "0.00";
    });

    function dibujarTablaDetalles() {
        const tbody = document.getElementById('tbodyDetalle');
        tbody.innerHTML = '';
        let sumaTotal = 0;
        detallesTemporales.forEach(d => {
            sumaTotal += d.TotalBruto; 
            tbody.innerHTML += `<tr>
                <td>${d.nombreOSVisual}</td><td>${d.nombrePlanVisual}</td><td class="text-center">${d.CantidadRecetas}</td>
                <td class="text-end">$${d.TotalBruto.toFixed(2)}</td><td class="text-end">$${d.MontoCargoOS.toFixed(2)}</td>
                <td class="text-end fw-bold text-success">$${d.MontoBonificacion.toFixed(2)}</td>
                <td class="text-center"><button class="btn btn-sm btn-danger" onclick="quitarDetalle(${d.idTemp})">üóëÔ∏è</button></td>
            </tr>`;
        });
        document.getElementById('spanTotalFinal').textContent = sumaTotal.toFixed(2);
    }
    function quitarDetalle(idTemp) { detallesTemporales = detallesTemporales.filter(d => d.idTemp !== idTemp); dibujarTablaDetalles(); }

    document.getElementById('btnGuardarTodo').addEventListener('click', async function() {
        const btn = this;
        const idLiq = document.getElementById('liqId').value;
        const fecha = document.getElementById('liqFecha').value;
        const idMand = document.getElementById('liqMandataria').value;
        const obs = document.getElementById('liqObs').value;

        if (idMand == "0") { alert("‚ö†Ô∏è Falta Mandataria."); return; }
        if (detallesTemporales.length === 0) { alert("‚ö†Ô∏è Lista vac√≠a."); return; }
        if(!confirm("¬øConfirmar Guardado?")) return;

        btn.disabled = true; btn.innerHTML = "‚åõ GUARDANDO...";
        const formData = new FormData();
        formData.append("QueToco", "Guardar");
        formData.append("IdLiquidacion", idLiq);
        formData.append("IdMandatarias", idMand);
        formData.append("Fecha", fecha);
        formData.append("Observaciones", obs);
        formData.append("DetallesJson", JSON.stringify(detallesTemporales));

        try {
            const response = await fetch('@Url.Action("MostrarModificaciones", "Home")', { method: 'POST', body: formData });
            const result = await response.json();
            if (result.success) { alert("‚úÖ Guardado."); modalABM.hide(); buscarLiquidaciones(); } 
            else { alert("‚ùå " + result.message); }
        } catch (e) { alert("Error conexi√≥n."); } finally { btn.disabled = false; btn.innerHTML = "üíæ GUARDAR TODO"; }
    });

    // =========================================================================
    // 4. FUNCIONES PRINCIPALES (VISOR, ELIMINAR, BUSCAR)
    // =========================================================================
    function abrirModalNueva() {
        document.getElementById('tituloModal').textContent = "NUEVA LIQUIDACI√ìN";
        document.getElementById('liqId').value = "0";
        document.getElementById('liqMandataria').value = "0";
        detallesTemporales = []; dibujarTablaDetalles(); modalABM.show();
    }

    async function buscarLiquidaciones() {
        const id = document.getElementById('filtroId').value;
        const desde = document.getElementById('filtroFechaDesde').value;
        const hasta = document.getElementById('filtroFechaHasta').value;
        const mand = document.getElementById('filtroMandataria').value;
        const tbody = document.getElementById('tbodyResultados');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center p-3"><div class="spinner-border"></div> Buscando...</td></tr>';

        try {
            const url = `@Url.Action("BuscarLiquidacionesAjax", "Home")?id=${id}&desde=${desde}&hasta=${hasta}&mandataria=${mand}`;
            const response = await fetch(url);
            const res = await response.json();
            if (res.success && res.data.length > 0) {
                tbody.innerHTML = ''; 
                res.data.forEach(liq => {
                    const fecha = new Date(liq.fechaPresentacion).toLocaleDateString('es-AR');
                    const nomMand = mapaMandatarias[liq.idMandatarias] || "---";
                    tbody.innerHTML += `<tr>
                        <td class="fw-bold fs-5">${liq.idLiquidaciones}</td><td>${fecha}</td><td class="fw-bold">${nomMand}</td><td>${liq.observaciones||'-'}</td>
                        <td>
                            <button class="btn btn-info btn-sm text-white fw-bold" onclick="verLiquidacion(${liq.idLiquidaciones}, '${fecha}', '${nomMand}')">üëÅÔ∏è VER</button>
                            <button class="btn btn-danger btn-sm fw-bold" onclick="eliminarLiquidacion(${liq.idLiquidaciones})">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
            } else { tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">No hay resultados.</td></tr>'; }
        } catch (e) { tbody.innerHTML = '<tr><td colspan="5" class="text-danger text-center">Error.</td></tr>'; }
    }

    async function eliminarLiquidacion(id) {
        if (!confirm(`¬øEliminar liquidaci√≥n N¬∞ ${id}?`)) return;
        const fd = new FormData(); fd.append("QueToco", "Eliminar"); fd.append("IdLiquidacion", id);
        try {
            const r = await fetch('@Url.Action("MostrarModificaciones", "Home")', { method: 'POST', body: fd });
            const res = await r.json();
            if(res.success) { alert("Eliminado."); buscarLiquidaciones(); } else { alert(res.message); }
        } catch(e) { alert("Error."); }
    }

    // =========================================================================
    // 5. VISOR DETALLADO Y SU L√ìGICA
    // =========================================================================
    
    // Variables para saber qu√© liquidaci√≥n estamos viendo
    let idLiquidacionActualVisor = 0; 

    async function verLiquidacion(idLiq, fechaStr, nomMand) {
        idLiquidacionActualVisor = idLiq; // Guardamos el ID globalmente para usarlo al agregar
        document.getElementById('verId').textContent = idLiq;
        document.getElementById('verFecha').textContent = fechaStr;
        document.getElementById('verMandataria').textContent = nomMand;
        document.getElementById('buscadorDetalles').value = ""; // Limpiar buscador

        const tbody = document.getElementById('tbodyVerDetalle');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-3"><div class="spinner-border"></div></td></tr>';
        modalVer.show();
        recargarTablaVisor();
    }

    async function recargarTablaVisor() {
        const tbody = document.getElementById('tbodyVerDetalle');
        try {
            const res = await fetch(`@Url.Action("ObtenerDetallesDeLiquidacion", "Home")?idLiquidacion=${idLiquidacionActualVisor}`);
            const data = await res.json();
            
            if (data.success) {
                tbody.innerHTML = '';
                if(data.data.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center p-3">Sin detalles.</td></tr>'; return; }

                data.data.forEach(d => {
                    const nomOS = document.querySelector(`#inputOS option[value="${d.idObrasSociales}"]`)?.text || `ID ${d.idObrasSociales}`;
                    tbody.innerHTML += `<tr>
                        <td class="nombre-os">${nomOS}</td>
                        <td class="text-center">${d.idPlanBonificacion}</td>
                        <td class="text-center">${d.cantidadRecetas}</td>
                        <td class="text-end">$${d.totalBruto.toFixed(2)}</td>
                        <td class="text-end">$${d.montoCargoOS.toFixed(2)}</td>
                        <td class="text-end fw-bold">$${d.montoBonificacion.toFixed(2)}</td>
                        <td class="text-center">
                            <button class="btn btn-warning btn-sm" onclick="abrirItemABM(${d.idLiquidacionDetalle})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarItemIndividual(${d.idLiquidacionDetalle})">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
            } else { tbody.innerHTML = `<tr><td colspan="7" class="text-danger">${data.message}</td></tr>`; }
        } catch(e) { tbody.innerHTML = '<tr><td colspan="7" class="text-danger">Error carga.</td></tr>'; }
    }

    // BUSCADOR EN CLIENTE
    function filtrarDetalles() {
        const texto = document.getElementById('buscadorDetalles').value.toLowerCase();
        const filas = document.querySelectorAll('#tbodyVerDetalle tr');
        filas.forEach(fila => {
            const celdaNombre = fila.querySelector('.nombre-os');
            if (celdaNombre) {
                const nombre = celdaNombre.textContent.toLowerCase();
                fila.style.display = nombre.includes(texto) ? '' : 'none';
            }
        });
    }

    // =========================================================================
    // 6. MINI-MODAL DE EDICI√ìN DE √çTEM
    // =========================================================================
    
    async function abrirItemABM(idItem) {
        // Resetear form
        document.getElementById('item_Id').value = idItem;
        document.getElementById('item_IdLiquidacionPadre').value = idLiquidacionActualVisor;
        document.getElementById('tituloModalItem').textContent = (idItem === 0) ? "NUEVO √çTEM" : "EDITAR √çTEM";
        
        // Valores por defecto
        document.getElementById('item_IdOS').value = "0";
        document.getElementById('item_IdPlan').innerHTML = '<option value="0">- Primero OS -</option>';
        document.getElementById('item_IdPlan').disabled = true;
        document.getElementById('item_Recetas').value = "0";
        document.getElementById('item_Total').value = "0.00";
        document.getElementById('item_CargoOS').value = "0.00";
        document.getElementById('item_Neto').value = "0.00";

        if (idItem > 0) {
            // Modo Edici√≥n: Cargar datos
            try {
                const res = await fetch(`@Url.Action("ObtenerItemPorId", "Home")?idDetalle=${idItem}`);
                const r = await res.json();
                if(r.success) {
                    const d = r.data;
                    document.getElementById('item_IdOS').value = d.idObrasSociales;
                    // Cargar planes y esperar a que termine para seleccionar
                    await cargarPlanesDeOS(d.idObrasSociales, 'item_IdPlan'); 
                    document.getElementById('item_IdPlan').value = d.idPlanBonificacion;
                    document.getElementById('item_Recetas').value = d.cantidadRecetas;
                    document.getElementById('item_Total').value = d.totalBruto;
                    document.getElementById('item_CargoOS').value = d.montoCargoOS;
                    document.getElementById('item_Neto').value = d.montoBonificacion;
                } else { alert(r.message); return; }
            } catch(e) { alert("Error cargando √≠tem."); return; }
        }

        modalItem.show();
    }

    function cerrarModalItem() {
        modalItem.hide();
        // Al cerrar, nos aseguramos que el modal de abajo (Ver) siga scrolleable
        document.body.classList.add('modal-open'); 
    }

    async function guardarItemIndividual() {
        const fd = new FormData();
        fd.append("IdLiquidacionPadre", document.getElementById('item_IdLiquidacionPadre').value);
        fd.append("IdItem", document.getElementById('item_Id').value);
        fd.append("IdOS", document.getElementById('item_IdOS').value);
        fd.append("IdPlan", document.getElementById('item_IdPlan').value);
        fd.append("Recetas", document.getElementById('item_Recetas').value);
        fd.append("Total", document.getElementById('item_Total').value.replace('.', ',')); // Fix cultura
        fd.append("CargoOS", document.getElementById('item_CargoOS').value.replace('.', ','));
        fd.append("Bonificacion", document.getElementById('item_Neto').value.replace('.', ','));

        try {
            const r = await fetch('@Url.Action("GuardarItemIndividual", "Home")', { method: 'POST', body: fd });
            const res = await r.json();
            if(res.success) {
                alert("‚úÖ Guardado.");
                cerrarModalItem();
                recargarTablaVisor(); // Refrescar la tabla de atr√°s
            } else { alert("‚ùå " + res.message); }
        } catch(e) { alert("Error guardando."); }
    }

    async function eliminarItemIndividual(idItem) {
        if(!confirm("¬øBorrar este rengl√≥n?")) return;
        const fd = new FormData();
        fd.append("idItem", idItem);
        fd.append("idLiquidacionPadre", idLiquidacionActualVisor);

        try {
            const r = await fetch('@Url.Action("EliminarItemIndividual", "Home")', { method: 'POST', body: fd });
            const res = await r.json();
            if(res.success) { recargarTablaVisor(); } else { alert(res.message); }
        } catch(e) { alert("Error eliminando."); }
    }

    document.addEventListener("DOMContentLoaded", () => { buscarLiquidaciones(); });
</script>
}