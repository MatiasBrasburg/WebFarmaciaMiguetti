@using System.Text.Json
@using WebFarmaciaMiguetti.Models
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Gesti√≥n de Liquidaciones";
    var listaMandatarias = (ViewBag.Mandatarias as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var listaObrasSociales = (ViewBag.ObrasSociales as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();

    if (listaObrasSociales.Any())
    {
        try { listaObrasSociales = listaObrasSociales.OrderBy(x => x.Nombre).ToList(); } catch { }
    }
    
    // --- CORRECCI√ìN CLAVE: Definimos AMBAS variables JSON ---
    var jsonObrasSociales = JsonSerializer.Serialize(listaObrasSociales.Select(x => new { id = x.IdObrasSociales, nombre = x.Nombre, idMandataria = x.IdMandataria }));
    // Esta variable faltaba y romp√≠a la p√°gina:
    var jsonMandatarias = JsonSerializer.Serialize(listaMandatarias.Select(x => new { id = x.IdMandatarias, nombre = x.RazonSocial }));

    // --- RECUPERAR DATOS DE LA FARMACIA DESDE SESI√ìN ---
    string nombreFarmacia = "FARMACIA";
    string direccionFarmacia = "Domicilio no configurado";
    string cuitFarmacia = "---";
    string ivaFarmacia = "Consumidor Final";

    var usuarioJson = HttpContextAccessor.HttpContext.Session.GetString("Usuario");
    if (!string.IsNullOrEmpty(usuarioJson))
    {
        try {
            var usuarioObj = JsonSerializer.Deserialize<Usuario>(usuarioJson);
            if(usuarioObj != null) {
                nombreFarmacia = usuarioObj.RazonSocial ?? "FARMACIA MIGUETTI";
                direccionFarmacia = usuarioObj.Domicilio ?? "";
                cuitFarmacia = usuarioObj.Cuit.ToString() ?? "";
                ivaFarmacia = usuarioObj.Iva ?? "";
            }
        } catch { }
    }
}

<style>
    /* ESTILOS DE ALTO IMPACTO (UX 85 A√ëOS) */
    body { font-family: 'Verdana', sans-serif; background-color: #f4f6f9; color: #000; }
    h1 { font-size: 2.2rem; font-weight: 900; color: #000; margin-bottom: 20px; text-transform: uppercase; border-bottom: 5px solid #000; display: inline-block; }
    
    .form-control, .form-select {
        border: 2px solid #6c757d; font-size: 1.1rem; padding: 8px 12px; color: #000; font-weight: 700; height: 45px;
    }
    .form-control:focus, .form-select:focus {
        border-color: #ffc107; box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.5); background-color: #fff3cd;
    }
    .form-label { font-weight: 900; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 5px; display: block; }
    .btn-super { font-size: 1.1rem; font-weight: 800; padding: 10px 20px; border: 2px solid rgba(0,0,0,0.2); text-transform: uppercase; letter-spacing: 1px; }
    
    .table-bordered { border: 2px solid #000; }
    .table thead th { background-color: #343a40; color: white; font-size: 1.1rem; vertical-align: middle; padding: 15px; text-align: center; }
    .table tbody td { font-size: 1.05rem; vertical-align: middle; font-weight: 600; padding: 10px; }

    .total-display { font-size: 1.8rem; font-weight: 900; color: #198754; text-align: right; padding: 15px; background: #d1e7dd; border: 4px solid #198754; border-radius: 8px; }

    .visor-header { background-color: #0dcaf0; color: #000; padding: 15px; border-bottom: 4px solid #000; font-size: 1.3rem; font-weight: bold; }
    .modal-warning-header { background-color: #ffc107; color: #000; border-bottom: 3px solid #000; }
    .modal-edit-header { background-color: #6610f2; color: #fff; border-bottom: 3px solid #000; }

    .view-toggle { display: flex; border: 3px solid #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px; background: white; }
    .view-toggle .btn-toggle { flex: 1; padding: 15px; font-weight: 900; font-size: 1.1rem; text-transform: uppercase; border: none; background: #e9ecef; color: #6c757d; transition: all 0.2s; }
    .view-toggle .btn-toggle.active { background: #0d6efd; color: white; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }
    .view-toggle .btn-toggle:hover:not(.active) { background: #dee2e6; }

    .buscador-wrapper { position: relative; width: 100%; }
    .lista-sugerencias { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 4px solid #000; border-top: none; z-index: 10000; display: none; max-height: 300px; overflow-y: auto; box-shadow: 0px 10px 20px rgba(0,0,0,0.4); }
    .item-sugerencia { padding: 15px; cursor: pointer; border-bottom: 2px solid #ccc; font-weight: 800; font-size: 1.1rem; color: #333; }
    .item-sugerencia:hover { background-color: #0d6efd; color: white; }
    .active-sugerencia { background-color: #0d6efd; color: white; } /* Resaltado para flechas */
</style>

<div class="container-fluid mt-4">
    <h1>üìö GESTI√ìN DE PRESENTACIONES (LIQUIDACIONES)</h1>

    <div class="view-toggle">
        <button class="btn-toggle active" id="btnModeMandataria" onclick="cambiarModo('Mandataria')">
            üìÅ AGRUPADO POR MANDATARIA (CABECERAS)
        </button>
        <button class="btn-toggle" id="btnModeOS" onclick="cambiarModo('OS')">
            üíä DETALLADO POR OBRA SOCIAL (S√ÅBANA)
        </button>
    </div>

    <div class="card mb-4" style="border: 3px solid #6c757d; background-color: #e2e3e5;">
        <div class="card-body">
            <h4 class="mb-3 fw-bold">üîç FILTROS DE B√öSQUEDA</h4>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Desde</label>
                    <input type="date" id="filtroFechaDesde" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Hasta</label>
                    <input type="date" id="filtroFechaHasta" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Mandataria</label>
                    <select id="filtroMandataria" class="form-select">
                        <option value="0">-- TODAS --</option>
                        @foreach (var m in listaMandatarias) { <option value="@m.IdMandatarias">@m.RazonSocial</option> }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Obra Social</label>
                    <div class="buscador-wrapper">
                        <input type="text" id="txtFiltroOS" class="form-control" placeholder="Buscar..." autocomplete="off">
                        <input type="hidden" id="filtroOS" value="0">
                        <div id="listaFiltroOS" class="lista-sugerencias"></div>
                    </div>
                </div>
                
                <div class="col-md-12 d-flex justify-content-end gap-2 mt-3">
                    <button class="btn btn-primary btn-super px-5" onclick="buscarLiquidaciones()">üîç BUSCAR</button>
                    <button class="btn btn-secondary btn-super" onclick="limpiarFiltros()" title="Borrar filtros">üîÑ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card" style="border: 3px solid #000;">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center p-3">
            <h3 class="m-0 fw-bold" id="tituloTabla">üìã LISTADO</h3>
            <button class="btn btn-success btn-super text-white" onclick="abrirModalNueva()">‚ûï NUEVA PRESENTACI√ìN</button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="tablaResultados">
                    <thead id="theadResultados"></thead>
                    <tbody id="tbodyResultados">
                        <tr><td colspan="6" class="text-center p-4 text-muted fs-4">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalABM" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable"> 
        <div class="modal-content border-4 border-primary">
            <div class="modal-header bg-primary text-white">
                <h3 class="modal-title fw-bold" id="tituloModal">NUEVA LIQUIDACI√ìN</h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="row g-3 mb-4 p-3 border border-2 border-secondary rounded bg-white">
                    <input type="hidden" id="liqId" value="0"> 
                    <div class="col-md-3"><label class="form-label">üìÖ FECHA</label><input type="date" id="liqFecha" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")"></div>
                    <div class="col-md-5">
                        <label class="form-label">üè¢ MANDATARIA</label>
                        <select id="liqMandataria" class="form-select fw-bold">
                            <option value="0" disabled selected>-- SELECCIONE --</option>
                            @foreach (var m in listaMandatarias) { <option value="@m.IdMandatarias">@m.RazonSocial</option> }
                        </select>
                    </div>
                    <div class="col-md-4"><label class="form-label">üìù OBS</label><input type="text" id="liqObs" class="form-control"></div>
                </div>
                <div class="card border-info mb-4" style="border: 3px solid #0dcaf0;">
                    <div class="card-header bg-info text-dark fw-bold fs-5">‚ûï AGREGAR ITEMS</div>
                    <div class="card-body bg-white">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">Obra Social</label>
                                <select id="inputOS" class="form-select" onchange="cargarPlanesDeOS(this.value, 'inputPlan')">
                                    <option value="0">-- Seleccione O.S. --</option>
                                    @foreach (var os in listaObrasSociales) { <option value="@os.IdObrasSociales">@os.Nombre</option> }
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Plan</label>
                                <select id="inputPlan" class="form-select" disabled onchange="recalcularNeto('inputTotal', 'inputPlan', 'inputNeto', 'lblPorcentajeAplicado')">
                                    <option value="0">- Primero elija OS -</option>
                                </select>
                            </div>
                            <div class="col-md-2"><label class="form-label">Recetas</label><input type="number" id="inputRecetas" class="form-control" value="0"></div>
                        </div>
                        <div class="row g-3 mt-1 align-items-end">
                            <div class="col-md-3"><label class="form-label">Total ($)</label><input type="number" id="inputTotal" class="form-control" step="0.01" value="0.00" oninput="recalcularNeto('inputTotal', 'inputPlan', 'inputNeto', 'lblPorcentajeAplicado')"></div>
                            <div class="col-md-3"><label class="form-label">Cargo O.S.</label><input type="number" id="inputCargoOS" class="form-control" step="0.01" value="0.00"></div>
                            <div class="col-md-3">
                                <label class="form-label text-success">Bonif ($)</label>
                                <input type="number" id="inputNeto" class="form-control fw-bold text-success border-success bg-light" readonly value="0.00">
                                <small class="text-muted" id="lblPorcentajeAplicado">Plan: 0%</small>
                            </div>
                            <div class="col-md-3"><button type="button" class="btn btn-success btn-super w-100" id="btnAgregarFila">‚¨áÔ∏è AGREGAR</button></div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive border border-2 border-dark rounded bg-white" style="min-height: 200px;">
                    <table class="table table-bordered mb-0">
                        <thead><tr><th>OS</th><th>PLAN</th><th>RECETAS</th><th>TOTAL</th><th>CARGO OS</th><th>BONIF</th><th>ACCION</th></tr></thead>
                        <tbody id="tbodyDetalle"></tbody>
                    </table>
                </div>
                <div class="row mt-4 justify-content-end">
                    <div class="col-md-5"><div class="total-display">TOTAL: $<span id="spanTotalFinal">0.00</span></div></div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary btn-super" data-bs-dismiss="modal">‚ùå CANCELAR</button>
                <button type="button" class="btn btn-primary btn-super" id="btnGuardarTodo">üíæ GUARDAR TODO</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVerDetalle" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-4 border-info">
            <div class="modal-header bg-info text-white">
                <h3 class="modal-title fw-bold text-dark">üëÅÔ∏è CONSULTA Y EDICI√ìN</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-white p-0">
                <div class="visor-header">
                    <div class="row">
                        <div class="col-md-2">N¬∞: <span id="verId" class="fw-black text-danger">---</span></div>
                        <div class="col-md-3">FECHA: <span id="verFecha" class="fw-normal">---</span></div>
                        <div class="col-md-7">MANDATARIA: <span id="verMandataria" class="fw-black text-primary">---</span></div>
                    </div>
                </div>
                
                <div class="p-3 bg-light border-bottom border-2 border-dark d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2" style="flex: 1;">
                        <span class="fs-4">üîç</span>
                        <input type="text" id="buscadorDetalles" class="form-control" placeholder="Escriba nombre de Obra Social..." onkeyup="filtrarDetalles()">
                    </div>
                    <button class="btn btn-success btn-super ms-3" onclick="abrirItemABM(0)">‚ûï AGREGAR √çTEM</button>
                </div>

                <div class="table-responsive p-3">
                    <table class="table table-bordered table-striped mb-0">
                        <thead class="bg-dark text-white">
                            <tr>
                                <th>OBRA SOCIAL</th><th>PLAN</th><th>RECETAS</th><th>TOTAL BRUTO</th><th>CARGO O.S.</th><th>BONIFICACI√ìN</th>
                                <th class="text-end">A PAGAR (REAL)</th> <th>ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyVerDetalle"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light d-flex justify-content-between">
                <button type="button" class="btn btn-primary btn-lg fw-bold" onclick="imprimirReporteGlobal()">
                    üñ®Ô∏è IMPRIMIR REPORTE
                </button>
                <button type="button" class="btn btn-lg btn-dark fw-bold px-5" data-bs-dismiss="modal">CERRAR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVerCobrosLiq" tabindex="-1" style="z-index: 1080;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-success">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">üí∞ COBROS ASOCIADOS</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover bg-white mb-0">
                        <thead class="table-secondary">
                            <tr>
                                <th>FECHA</th>
                                <th>COMPROBANTE</th>
                                <th class="text-end">IMPORTE</th>
                                <th class="text-end">D√âBITO</th>
                                <th class="text-end">NETO</th>
                                <th>MOTIVO</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyVerCobrosLiq"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalItemIndividual" tabindex="-1" data-bs-backdrop="static" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-3 border-warning">
            <div class="modal-header modal-warning-header">
                <h4 class="modal-title fw-bold" id="tituloModalItem">EDITAR √çTEM</h4>
                <button type="button" class="btn-close" onclick="cerrarModalItem()"></button>
            </div>
            <div class="modal-body bg-light">
                <input type="hidden" id="item_Id" value="0">
                <input type="hidden" id="item_IdLiquidacionPadre" value="0">
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Obra Social</label>
                        <select id="item_IdOS" class="form-select" onchange="cargarPlanesDeOS(this.value, 'item_IdPlan')">
                            <option value="0">-- Seleccione --</option>
                            @foreach (var os in listaObrasSociales) { <option value="@os.IdObrasSociales">@os.Nombre</option> }
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Plan</label>
                        <select id="item_IdPlan" class="form-select" disabled onchange="recalcularNeto('item_Total', 'item_IdPlan', 'item_Neto', 'item_lblPorc')">
                            <option value="0">- Primero OS -</option>
                        </select>
                    </div>
                    <div class="col-md-3"><label class="form-label">Recetas</label><input type="number" id="item_Recetas" class="form-control" value="0"></div>
                    <div class="col-md-3"><label class="form-label">Total ($)</label><input type="number" id="item_Total" class="form-control" step="0.01" value="0.00" oninput="recalcularNeto('item_Total', 'item_IdPlan', 'item_Neto', 'item_lblPorc')"></div>
                    <div class="col-md-3"><label class="form-label">Cargo O.S.</label><input type="number" id="item_CargoOS" class="form-control" step="0.01" value="0.00"></div>
                    <div class="col-md-3"><label class="form-label text-success">Bonif ($)</label><input type="number" id="item_Neto" class="form-control fw-bold bg-white" readonly value="0.00"><small id="item_lblPorc">0%</small></div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary fw-bold" onclick="cerrarModalItem()">CANCELAR</button>
                <button type="button" class="btn btn-warning fw-bold px-4" onclick="guardarItemIndividual()">üíæ GUARDAR CAMBIOS</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarCabecera" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-3 border-dark">
            <div class="modal-header modal-edit-header">
                <h4 class="modal-title fw-bold text-white">‚úèÔ∏è EDITAR DATOS GENERALES</h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <input type="hidden" id="edit_Id" value="0">
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">üìÖ FECHA</label><input type="date" id="edit_Fecha" class="form-control"></div>
                    <div class="col-md-6">
                        <label class="form-label">üè¢ MANDATARIA</label>
                        <select id="edit_Mandataria" class="form-select fw-bold">
                            @foreach (var m in listaMandatarias) { <option value="@m.IdMandatarias">@m.RazonSocial</option> }
                        </select>
                    </div>
                    <div class="col-12"><label class="form-label">üìù OBSERVACIONES</label><input type="text" id="edit_Obs" class="form-control"></div>
                </div>
                <div class="alert alert-info mt-3 fw-bold">
                    ‚ÑπÔ∏è Para editar los √≠tems (recetas, montos), utilice el bot√≥n "VER" del listado principal.
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary fw-bold" data-bs-dismiss="modal">CANCELAR</button>
                <button type="button" class="btn btn-primary fw-bold px-4" onclick="guardarEdicionCabecera()">üíæ ACTUALIZAR DATOS</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const farmaciaInfo = {
        nombre: "@Html.Raw(nombreFarmacia)",
        domicilio: "@Html.Raw(direccionFarmacia)",
        cuit: "@Html.Raw(cuitFarmacia)",
        iva: "@Html.Raw(ivaFarmacia)"
    };

    let detallesTemporales = []; 
    let indiceTemporal = 0;      
    const modalABM = new bootstrap.Modal(document.getElementById('modalABM'));
    const modalVer = new bootstrap.Modal(document.getElementById('modalVerDetalle'));
    const modalItem = new bootstrap.Modal(document.getElementById('modalItemIndividual'));
    const modalEditCab = new bootstrap.Modal(document.getElementById('modalEditarCabecera'));
    const modalCobros = new bootstrap.Modal(document.getElementById('modalVerCobrosLiq'));

    var datosOS = @Html.Raw(jsonObrasSociales);
    // ESTA VARIABLE AHORA S√ç EST√Å DEFINIDA ARRIBA
    var datosMand = @Html.Raw(jsonMandatarias ?? "[]"); 
    
    var modoActual = 'Mandataria'; 
    var currentFocus = -1;

    // Mapa de mandatarias para mostrar nombres en grilla
    const mapaMandatarias = {};
    if(datosMand) datosMand.forEach(m => mapaMandatarias[m.id] = m.nombre);

    document.addEventListener("DOMContentLoaded", () => {
        setupAuto('txtFiltroOS', 'listaFiltroOS', 'filtroOS', datosOS);
        
        // --- NAVEGACI√ìN MEJORADA (ENTER Y FLECHAS) ---
        document.getElementById('modalABM').addEventListener('shown.bs.modal', function () { document.getElementById('liqFecha').focus(); });
        document.getElementById('modalVerDetalle').addEventListener('shown.bs.modal', function () { document.getElementById('buscadorDetalles').focus(); });

        setupEnterNavigation('inputRecetas', 'inputTotal');
        setupEnterNavigation('inputTotal', 'inputCargoOS');
        setupEnterNavigation('inputCargoOS', 'inputNeto');
        
        document.getElementById('inputNeto').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') { e.preventDefault(); document.getElementById('btnAgregarFila').click(); }
        });
        document.getElementById('inputCargoOS').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') { e.preventDefault(); document.getElementById('inputNeto').focus(); }
        });

        document.getElementById('filtroFechaHasta').addEventListener('keypress', function(e){
            if(e.key==='Enter') { e.preventDefault(); buscarLiquidaciones(); }
        });

        cambiarModo('Mandataria');
    });

    // Helper para mover foco
    function setupEnterNavigation(curr, next) {
        const el = document.getElementById(curr);
        if(el) {
            el.addEventListener('keypress', function(e) {
                if(e.key === 'Enter') {
                    e.preventDefault();
                    const n = document.getElementById(next);
                    if(n) { n.focus(); if(n.select) n.select(); }
                }
            });
        }
    }

    function cambiarModo(modo) {
        modoActual = modo;
        if(modo === 'Mandataria') {
            document.getElementById('btnModeMandataria').classList.add('active');
            document.getElementById('btnModeOS').classList.remove('active');
            document.getElementById('tituloTabla').textContent = "üìã LISTADO POR MANDATARIA";
        } else {
            document.getElementById('btnModeMandataria').classList.remove('active');
            document.getElementById('btnModeOS').classList.add('active');
            document.getElementById('tituloTabla').textContent = "üíä DETALLE GLOBAL POR OBRA SOCIAL (SOLO DEUDAS)";
        }
        const thead = document.getElementById('theadResultados');
        if(modo === 'Mandataria') {
            thead.innerHTML = `<tr><th>N¬∞</th><th>FECHA</th><th>PERIODO</th><th>MANDATARIA</th><th>OBSERVACIONES</th><th class="text-end">TOTAL</th><th class="text-center">ACCIONES</th></tr>`;
        } else {
            thead.innerHTML = `<tr><th>FECHA</th><th>PERIODO</th><th>MANDATARIA</th><th>OBRA SOCIAL</th><th class="text-center">RECETAS</th><th class="text-end">A COBRAR</th><th class="text-end">SALDO PEND.</th><th class="text-center">ACCIONES</th></tr>`;
        }
        buscarLiquidaciones();
    }

    async function buscarLiquidaciones() {
        const desde = document.getElementById('filtroFechaDesde').value;
        const hasta = document.getElementById('filtroFechaHasta').value;
        const mand = document.getElementById('filtroMandataria').value;
        const idOS = document.getElementById('filtroOS').value; 

        const tbody = document.getElementById('tbodyResultados');
        const cols = modoActual === 'Mandataria' ? 7 : 8;
        tbody.innerHTML = `<tr><td colspan="${cols}" class="text-center p-4"><div class="spinner-border text-primary"></div></td></tr>`;

        let url = "";
        if (modoActual === 'Mandataria') {
            url = `@Url.Action("BuscarLiquidacionesAjax", "Home")?desde=${desde}&hasta=${hasta}&mandataria=${mand}`; 
        } else {
            url = `@Url.Action("BuscarDetallesGlobalesAjax", "Home")?desde=${desde}&hasta=${hasta}&idMandataria=${mand}&idOS=${idOS}`;
        }

        try {
            const r = await fetch(url);
            const res = await r.json();
            
            if (res.success && res.data.length > 0) {
                tbody.innerHTML = ''; 
                
                if (modoActual === 'Mandataria') {
                    res.data.forEach(l => {
                        const f = new Date(l.FechaPresentacion || l.fechaPresentacion).toLocaleDateString('es-AR');
                        const nm = l.NombreMandataria || mapaMandatarias[l.IdMandatarias || l.idMandatarias] || "---";
                        const idLiq = l.IdLiquidaciones || l.idLiquidaciones;
                        const total = parseFloat(l.TotalReal || l.totalReal || 0);
                        
                        tbody.innerHTML += `<tr>
                            <td class="fw-bold fs-5">${idLiq}</td>
                            <td>${f}</td>
                            <td class="fw-bold text-muted">${l.Periodo||l.periodo||'-'}</td>
                            <td class="fw-bold text-primary">${nm}</td>
                            <td>${l.Observaciones || l.observaciones || '-'}</td>
                            <td class="text-end fw-bold">$${total.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                            <td class="text-center">
                                <button class="btn btn-warning btn-sm fw-bold me-1" onclick="editarCabecera(${idLiq})">‚úèÔ∏è</button>
                                <button class="btn btn-info btn-sm text-white fw-bold me-1" onclick="verLiquidacion(${idLiq}, '${f}', '${nm}')">üëÅÔ∏è VER</button>
                                <button class="btn btn-danger btn-sm fw-bold" onclick="eliminarLiquidacion(${idLiq})">üóëÔ∏è</button>
                            </td></tr>`;
                    });
                } else {
                    let contadorVisibles = 0;
                    res.data.forEach(x => {
                        const pagado = (x.Pagado === true || x.Pagado === 1);
                        if (pagado) return; 

                        contadorVisibles++;
                        const f = (x.FechaPresentacion||x.fechaPresentacion||'').split('T')[0];
                        const neto = parseFloat(x.TotalBruto||x.totalBruto||0); 
                        const saldo = parseFloat(x.SaldoPendiente);
                        const visualSaldo = isNaN(saldo) ? neto : saldo; 
                        
                        const idDet = x.IdLiquidacionDetalle || x.idLiquidacionDetalle;
                        const idPadre = x.IdLiquidaciones || x.idLiquidaciones;

                        const datosPrint = JSON.stringify({
                            os: x.NombreObraSocial || x.nombreObraSocial,
                            periodo: x.Periodo || x.periodo,
                            plan: x.NombrePlan || "---",
                            recetas: x.CantidadRecetas || 0,
                            bruto: parseFloat(x.BrutoOriginal || 0), 
                            cargo: parseFloat(x.MontoCargoOS || 0),
                            bonif: parseFloat(x.MontoBonificacion || 0),
                            neto: neto,
                            deuda: visualSaldo
                        }).replace(/"/g, '&quot;');

                        tbody.innerHTML += `<tr>
                            <td class="text-center small">${f}</td>
                            <td class="text-center fw-bold">${x.Periodo||x.periodo}</td>
                            <td class="small text-muted">${x.NombreMandataria||x.nombreMandataria}</td>
                            <td class="fw-bold text-primary fs-5">${x.NombreObraSocial||x.nombreObraSocial}</td>
                            <td class="text-center fw-bold">${x.CantidadRecetas||x.cantidadRecetas}</td>
                            <td class="text-end text-muted">$${neto.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                            <td class="text-end fw-black text-danger">$${visualSaldo.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-info text-white me-1" onclick="verCobrosDeLiquidacion(${idDet})" title="Ver Cobros">üëÅÔ∏è</button>
                                <button class="btn btn-sm btn-warning me-1" onclick="abrirItemABM(${idDet}, ${idPadre})">‚úèÔ∏è</button>
                                <button class="btn btn-sm btn-danger me-1" onclick="eliminarItemIndividual(${idDet})">üóëÔ∏è</button>
                                <button class="btn btn-sm btn-primary" onclick="imprimirItemIndividual(${datosPrint})">üñ®Ô∏è</button>
                            </td>
                        </tr>`;
                    });

                    if(contadorVisibles === 0) {
                        tbody.innerHTML = `<tr><td colspan="${cols}" class="text-center p-4 fs-4 text-success fw-bold">üëè ¬°No hay deudas pendientes con estos filtros!</td></tr>`;
                    }
                }
            } else { tbody.innerHTML = `<tr><td colspan="${cols}" class="text-center p-4 fs-4 text-muted">Sin resultados.</td></tr>`; }
        } catch (e) { console.error(e); tbody.innerHTML = `<tr><td colspan="${cols}" class="text-danger text-center">Error de conexi√≥n.</td></tr>`; }
    }

    function limpiarFiltros() {
        document.getElementById('filtroFechaDesde').value = "";
        document.getElementById('filtroFechaHasta').value = "";
        document.getElementById('filtroMandataria').value = "0";
        document.getElementById('txtFiltroOS').value = ""; document.getElementById('filtroOS').value = "0";
        buscarLiquidaciones(); 
    }

    // --- AUTOCOMPLETADO (Flechas + Enter) ---
    function setupAuto(inpId, listId, hidId, fuenteDatos) {
        const inp = document.getElementById(inpId);
        const list = document.getElementById(listId);
        const hid = document.getElementById(hidId);
        
        inp.addEventListener("input", function() {
            const t = this.value.toLowerCase();
            list.innerHTML = '';
            currentFocus = -1;
            if (t.length < 1) { list.style.display = 'none'; hid.value="0"; return; }
            
            const f = fuenteDatos.filter(x => x.nombre.toLowerCase().includes(t)).slice(0, 50); // LIMITAMOS
            if (f.length === 0) { list.innerHTML = '<div class="item-sugerencia text-muted">üö´ NO EXISTE</div>'; list.style.display = 'block'; return; }
            
            f.forEach(x => {
                const item = document.createElement('div');
                item.className = 'item-sugerencia'; 
                item.textContent = x.nombre;
                item.dataset.id = x.id; item.dataset.nombre = x.nombre;
                item.addEventListener("click", function() {
                    inp.value = this.dataset.nombre;
                    hid.value = this.dataset.id;
                    list.style.display = 'none';
                });
                list.appendChild(item);
            });
            list.style.display = 'block';
        });

        inp.addEventListener("keydown", function(e) {
            let x = list.getElementsByTagName("div");
            if (e.key === "ArrowDown") {
                currentFocus++;
                addActive(x);
            } else if (e.key === "ArrowUp") {
                currentFocus--;
                addActive(x);
            } else if (e.key === "Enter") {
                e.preventDefault();
                if (currentFocus > -1) {
                    if (x) x[currentFocus].click();
                } else if (list.style.display === "block" && x.length > 0) {
                     x[0].click();
                } else {
                    if(inpId === 'txtFiltroOS') buscarLiquidaciones();
                }
            }
        });

        inp.addEventListener("blur", function() { setTimeout(() => { list.style.display = 'none'; }, 200); });
    }

    function addActive(x) {
        if (!x) return false;
        removeActive(x);
        if (currentFocus >= x.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (x.length - 1);
        x[currentFocus].classList.add("active-sugerencia");
        x[currentFocus].scrollIntoView({ block: "nearest" });
    }
    function removeActive(x) {
        for (let i = 0; i < x.length; i++) x[i].classList.remove("active-sugerencia");
    }

    async function cargarPlanesDeOS(idOS, idSelectDestino) {
        const selectPlan = document.getElementById(idSelectDestino);
        selectPlan.innerHTML = '<option value="0">Cargando...</option>'; selectPlan.disabled = true;
        if (idOS == "0") { selectPlan.innerHTML = '<option value="0">- Primero OS -</option>'; return; }
        try {
            const r = await fetch(`@Url.Action("ObtenerPlanesPorObrasSociales", "Home")?idObraSocial=${idOS}`);
            const d = await r.json();
            selectPlan.innerHTML = '<option value="0">-- Seleccione Plan --</option>';
            if (d.success && d.data.length > 0) {
                d.data.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.idPlanBonificacion; opt.text = p.nombrePlan; 
                    opt.setAttribute('data-bonif', p.bonificacion); selectPlan.appendChild(opt);
                });
                selectPlan.disabled = false;
            } else { selectPlan.innerHTML = '<option value="0">Sin planes</option>'; }
        } catch (e) { alert("Error cargando planes."); }
    }

    function recalcularNeto(idInTot, idSel, idInNet, idLbl) {
        const total = parseFloat(document.getElementById(idInTot).value) || 0;
        const sel = document.getElementById(idSel);
        let porc = (sel.selectedIndex > 0) ? parseFloat(sel.options[sel.selectedIndex].getAttribute('data-bonif')) : 0;
        if(document.getElementById(idLbl)) document.getElementById(idLbl).textContent = `Plan: ${porc}%`;
        document.getElementById(idInNet).value = (total * (porc / 100.0)).toFixed(2);
    }

    document.getElementById('btnAgregarFila').addEventListener('click', function() {
        const os = document.getElementById('inputOS'); const plan = document.getElementById('inputPlan');
        if (os.value == "0" || plan.value == "0") { alert("‚ö†Ô∏è Faltan datos."); return; }
        
        const nuevo = {
            idTemp: ++indiceTemporal,
            IdObrasSociales: parseInt(os.value), IdPlanBonificacion: parseInt(plan.value), 
            CantidadRecetas: parseInt(document.getElementById('inputRecetas').value)||0,
            TotalBruto: parseFloat(document.getElementById('inputTotal').value)||0,
            MontoCargoOS: parseFloat(document.getElementById('inputCargoOS').value)||0,
            MontoBonificacion: parseFloat(document.getElementById('inputNeto').value)||0,
            nombreOSVisual: os.options[os.selectedIndex].text,
            nombrePlanVisual: plan.options[plan.selectedIndex].text
        };
        detallesTemporales.push(nuevo); dibujarTablaDetalles();
        
        document.getElementById('inputRecetas').value="0"; document.getElementById('inputTotal').value="0.00";
        document.getElementById('inputCargoOS').value="0.00"; document.getElementById('inputNeto').value="0.00";
        document.getElementById('inputTotal').focus();
    });

    function dibujarTablaDetalles() {
        const tbody = document.getElementById('tbodyDetalle'); tbody.innerHTML = '';
        let suma = 0;
        detallesTemporales.forEach(d => {
            suma += d.TotalBruto; 
            tbody.innerHTML += `<tr><td>${d.nombreOSVisual}</td><td>${d.nombrePlanVisual}</td><td class="text-center">${d.CantidadRecetas}</td>
                <td class="text-end">$${d.TotalBruto.toFixed(2)}</td><td class="text-end">$${d.MontoCargoOS.toFixed(2)}</td>
                <td class="text-end fw-bold text-success">$${d.MontoBonificacion.toFixed(2)}</td>
                <td class="text-center"><button class="btn btn-sm btn-danger" onclick="quitarDetalle(${d.idTemp})">üóëÔ∏è</button></td></tr>`;
        });
        document.getElementById('spanTotalFinal').textContent = suma.toFixed(2);
    }
    function quitarDetalle(id) { detallesTemporales = detallesTemporales.filter(d => d.idTemp !== id); dibujarTablaDetalles(); }

    document.getElementById('btnGuardarTodo').addEventListener('click', async function() {
        const btn = this; const idMand = document.getElementById('liqMandataria').value;
        if (idMand == "0") { alert("‚ö†Ô∏è Falta Mandataria."); return; }
        if (detallesTemporales.length === 0) { alert("‚ö†Ô∏è Lista vac√≠a."); return; }
        if(!confirm("¬øConfirmar?")) return;

        btn.disabled = true; btn.innerHTML = "‚åõ...";
        const fd = new FormData();
        fd.append("QueToco", "Guardar"); fd.append("IdLiquidacion", "0");
        fd.append("IdMandatarias", idMand); fd.append("Fecha", document.getElementById('liqFecha').value);
        fd.append("Observaciones", document.getElementById('liqObs').value);
        fd.append("DetallesJson", JSON.stringify(detallesTemporales));

        try {
            const r = await fetch('@Url.Action("MostrarModificaciones", "Home")', { method: 'POST', body: fd });
            const res = await r.json();
            if (res.success) { alert("‚úÖ Guardado."); modalABM.hide(); buscarLiquidaciones(); } else { alert("‚ùå " + res.message); }
        } catch (e) { alert("Error."); } finally { btn.disabled = false; btn.innerHTML = "üíæ GUARDAR TODO"; }
    });

    function abrirModalNueva() {
        document.getElementById('tituloModal').textContent = "NUEVA LIQUIDACI√ìN";
        document.getElementById('liqId').value = "0"; document.getElementById('liqMandataria').value = "0";
        detallesTemporales = []; dibujarTablaDetalles(); modalABM.show();
    }

    let idLiquidacionActualVisor = 0; 
    async function verLiquidacion(id, f, nm) {
        idLiquidacionActualVisor = id;
        document.getElementById('verId').textContent = id; document.getElementById('verFecha').textContent = f;
        document.getElementById('verMandataria').textContent = nm;
        document.getElementById('buscadorDetalles').value = "";
        modalVer.show(); recargarTablaVisor();
    }

    async function recargarTablaVisor() {
        const tbody = document.getElementById('tbodyVerDetalle');
        try {
            const r = await fetch(`@Url.Action("ObtenerDetallesDeLiquidacion", "Home")?idLiquidacion=${idLiquidacionActualVisor}`);
            const d = await r.json();
            if (d.success) {
                tbody.innerHTML = '';
                if(d.data.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="text-center p-3">Sin detalles.</td></tr>'; return; }
                
                d.data.forEach(x => {
                    const nomOS = document.querySelector(`#inputOS option[value="${x.idObrasSociales}"]`)?.text || `ID ${x.idObrasSociales}`;
                    const aPagarReal = x.montoCargoOS - x.montoBonificacion;
                    
                    // --- BOT√ìN OJITO EN MODAL VISOR ---
                    tbody.innerHTML += `<tr>
                        <td class="nombre-os">${nomOS}</td><td class="text-center">${x.idPlanBonificacion}</td><td class="text-center">${x.cantidadRecetas}</td>
                        <td class="text-end">$${x.totalBruto.toFixed(2)}</td><td class="text-end">$${x.montoCargoOS.toFixed(2)}</td>
                        <td class="text-end">$${x.montoBonificacion.toFixed(2)}</td>
                        <td class="text-end fw-bold border border-secondary">$${aPagarReal.toFixed(2)}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-info text-white me-1" onclick="verCobrosDeLiquidacion(${x.idLiquidacionDetalle})" title="Ver Pagos">üëÅÔ∏è</button>
                            <button class="btn btn-warning btn-sm" onclick="abrirItemABM(${x.idLiquidacionDetalle}, ${idLiquidacionActualVisor})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarItemIndividual(${x.idLiquidacionDetalle})">üóëÔ∏è</button>
                        </td></tr>`;
                });
            } else { tbody.innerHTML = `<tr><td colspan="8" class="text-danger">${d.message}</td></tr>`; }
        } catch(e) { tbody.innerHTML = '<tr><td colspan="8" class="text-danger">Error.</td></tr>'; }
    }

    async function verCobrosDeLiquidacion(idDet) {
        const tbody = document.getElementById('tbodyVerCobrosLiq');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-3">Cargando...</td></tr>';
        modalCobros.show();
        
        try {
            const r = await fetch(`@Url.Action("ObtenerCobrosPorLiquidacionDetalle", "Home")?idDetalle=${idDet}`);
            const res = await r.json();
            tbody.innerHTML = '';
            
            if(res.success && res.data.length > 0) {
                res.data.forEach(c => {
                    const imp = parseFloat(c.ImporteCobrado||0);
                    const deb = parseFloat(c.MontoDebito||0);
                    const motivo = c.MotivoDebito || '-';
                    const fecha = (c.FechaCobro||'').split('T')[0];
                    
                    tbody.innerHTML += `<tr>
                        <td>${fecha}</td>
                        <td>${c.NumeroComprobante}</td>
                        <td class="text-end fw-bold">$${imp.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                        <td class="text-end text-danger">$${deb.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                        <td class="text-end fw-black text-success">$${(imp-deb).toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                        <td class="small text-muted fst-italic">${motivo}</td>
                    </tr>`;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted p-3">üö´ A√∫n no se han registrado cobros para este √≠tem.</td></tr>';
            }
        } catch(e) { 
            tbody.innerHTML = '<tr><td colspan="6" class="text-danger text-center">Error al conectar con el servidor.</td></tr>'; 
        }
    }

    async function editarCabecera(id) {
        try {
            const r = await fetch(`@Url.Action("ObtenerCabeceraLiquidacion", "Home")?id=${id}`);
            const res = await r.json();
            if (res.success) {
                const d = res.data;
                document.getElementById('edit_Id').value = d.idLiquidaciones;
                document.getElementById('edit_Fecha').value = d.fechaPresentacion.split('T')[0];
                document.getElementById('edit_Mandataria').value = d.idMandatarias;
                document.getElementById('edit_Obs').value = d.observaciones;
                modalEditCab.show();
            } else { alert(res.message); }
        } catch (e) { alert("Error al cargar datos."); }
    }

    async function guardarEdicionCabecera() {
        const fd = new FormData();
        fd.append("IdLiquidacion", document.getElementById('edit_Id').value);
        fd.append("Fecha", document.getElementById('edit_Fecha').value);
        fd.append("IdMandataria", document.getElementById('edit_Mandataria').value);
        fd.append("Observaciones", document.getElementById('edit_Obs').value);
        try {
            const r = await fetch('@Url.Action("GuardarEdicionCabecera", "Home")', { method: 'POST', body: fd });
            const res = await r.json();
            if (res.success) { alert("‚úÖ Actualizado."); modalEditCab.hide(); buscarLiquidaciones(); }
            else { alert("‚ùå " + res.message); }
        } catch(e) { alert("Error al guardar."); }
    }

    function filtrarDetalles() {
        const txt = document.getElementById('buscadorDetalles').value.toLowerCase();
        document.querySelectorAll('#tbodyVerDetalle tr').forEach(r => {
            const c = r.querySelector('.nombre-os');
            if(c) r.style.display = c.textContent.toLowerCase().includes(txt) ? '' : 'none';
        });
    }
    
    async function eliminarLiquidacion(id) {
        if (!confirm(`¬øBorrar liquidaci√≥n N¬∞ ${id}?`)) return;
        const fd = new FormData(); fd.append("QueToco", "Eliminar"); fd.append("IdLiquidacion", id);
        try { const r = await fetch('@Url.Action("MostrarModificaciones", "Home")', { method: 'POST', body: fd }); 
        if((await r.json()).success) { alert("Borrado."); buscarLiquidaciones(); } else alert("Error."); } catch(e){}
    }
    
    // ABM ITEM INDIVIDUAL (MINI MODAL)
    async function abrirItemABM(idItem, idPadre = 0) {
        document.getElementById('item_Id').value = idItem;
        document.getElementById('item_IdLiquidacionPadre').value = (idPadre > 0) ? idPadre : idLiquidacionActualVisor;
        
        document.getElementById('tituloModalItem').textContent = (idItem === 0) ? "NUEVO √çTEM" : "EDITAR √çTEM";
        document.getElementById('item_IdOS').value="0"; document.getElementById('item_IdPlan').innerHTML='<option value="0">- Primero OS -</option>';
        document.getElementById('item_IdPlan').disabled=true;
        document.getElementById('item_Recetas').value="0"; document.getElementById('item_Total').value="0.00";
        document.getElementById('item_CargoOS').value="0.00"; document.getElementById('item_Neto').value="0.00";

        if (idItem > 0) {
            try {
                const r = await fetch(`@Url.Action("ObtenerItemPorId", "Home")?idDetalle=${idItem}`);
                const res = await r.json();
                if(res.success) {
                    const d = res.data;
                    document.getElementById('item_IdOS').value = d.idObrasSociales;
                    await cargarPlanesDeOS(d.idObrasSociales, 'item_IdPlan');
                    document.getElementById('item_IdPlan').value = d.idPlanBonificacion;
                    document.getElementById('item_Recetas').value = d.cantidadRecetas;
                    document.getElementById('item_Total').value = d.totalBruto;
                    document.getElementById('item_CargoOS').value = d.montoCargoOS;
                    document.getElementById('item_Neto').value = d.montoBonificacion;
                }
            } catch(e) { alert("Error cargando √≠tem."); return; }
        }
        modalItem.show();
    }
    function cerrarModalItem() { modalItem.hide(); document.body.classList.add('modal-open'); }
    
    async function guardarItemIndividual() {
        const fd = new FormData();
        fd.append("IdLiquidacionPadre", document.getElementById('item_IdLiquidacionPadre').value);
        fd.append("IdItem", document.getElementById('item_Id').value);
        fd.append("IdOS", document.getElementById('item_IdOS').value);
        fd.append("IdPlan", document.getElementById('item_IdPlan').value);
        fd.append("Recetas", document.getElementById('item_Recetas').value);
        fd.append("Total", document.getElementById('item_Total').value.replace('.', ','));
        fd.append("CargoOS", document.getElementById('item_CargoOS').value.replace('.', ','));
        fd.append("Bonificacion", document.getElementById('item_Neto').value.replace('.', ','));

        try {
            const r = await fetch('@Url.Action("GuardarItemIndividual", "Home")', { method: 'POST', body: fd });
            if((await r.json()).success) { 
                alert("‚úÖ Guardado."); 
                cerrarModalItem(); 
                if(modoActual === 'OS') buscarLiquidaciones(); 
                else recargarTablaVisor(); 
            }
            else alert("Error.");
        } catch(e) { alert("Error."); }
    }
    
    async function eliminarItemIndividual(id) {
        if(!confirm("¬øBorrar √≠tem?")) return;
        const fd = new FormData(); fd.append("idItem", id); fd.append("idLiquidacionPadre", 0);
        try { 
            if((await (await fetch('@Url.Action("EliminarItemIndividual", "Home")', { method: 'POST', body: fd })).json()).success) {
                if(modoActual === 'OS') buscarLiquidaciones();
                else recargarTablaVisor();
            }
        } catch(e){}
    }

    // IMPRESI√ìN (AHORA CON TOTALES)
    function imprimirReporteGlobal() {
        const idLiq = document.getElementById('verId').textContent;
        const fecha = document.getElementById('verFecha').textContent;
        const mandataria = document.getElementById('verMandataria').textContent;
        
        let filasHTML = "";
        let tRec = 0, tBruto = 0, tCargo = 0, tBonif = 0, tNet = 0;

        document.querySelectorAll('#tbodyVerDetalle tr').forEach(tr => {
            const celdas = tr.querySelectorAll('td');
            if(celdas.length > 1) { 
                const rec = parseInt(celdas[2].textContent) || 0;
                const bruto = parseFloat(celdas[3].textContent.replace('$','').replace('.','').replace(',','.')) || 0; 
                const cargo = parseFloat(celdas[4].textContent.replace('$','').replace('.','').replace(',','.')) || 0; 
                const bonif = parseFloat(celdas[5].textContent.replace('$','').replace('.','').replace(',','.')) || 0; 
                const neto  = parseFloat(celdas[6].textContent.replace('$','').replace('.','').replace(',','.')) || 0;

                tRec += rec; tBruto += bruto; tCargo += cargo; tBonif += bonif; tNet += neto;

                filasHTML += `<tr>
                    <td style="text-align:left; padding:5px;">${celdas[0].textContent}</td>
                    <td style="text-align:center;">${celdas[1].textContent}</td>
                    <td style="text-align:center;">${rec}</td>
                    <td style="text-align:right;">$${bruto.toFixed(2)}</td>
                    <td style="text-align:right;">$${cargo.toFixed(2)}</td>
                    <td style="text-align:right;">$${bonif.toFixed(2)}</td>
                    <td style="text-align:right; font-weight:bold;">$${neto.toFixed(2)}</td>
                </tr>`;
            }
        });

        filasHTML += `<tr style="background-color:#e9ecef; font-weight:bold;">
            <td colspan="2" style="text-align:right; padding:8px;">TOTALES:</td>
            <td style="text-align:center;">${tRec}</td>
            <td style="text-align:right;">$${tBruto.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
            <td style="text-align:right;">$${tCargo.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
            <td style="text-align:right;">$${tBonif.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
            <td style="text-align:right;">$${tNeto.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
        </tr>`;

        abrirVentanaImpresion(idLiq, mandataria, fecha, filasHTML);
    }

    function imprimirItemIndividual(datos) {
        const filasHTML = `<tr>
            <td style="text-align:left; padding:5px;">${datos.os}</td>
            <td style="text-align:center;">${datos.plan}</td>
            <td style="text-align:center;">${datos.recetas}</td>
            <td style="text-align:right;">$${datos.bruto.toFixed(2)}</td>
            <td style="text-align:right;">$${datos.cargo.toFixed(2)}</td>
            <td style="text-align:right;">$${datos.bonif.toFixed(2)}</td>
            <td style="text-align:right; font-weight:bold;">$${datos.neto.toFixed(2)}</td>
        </tr>`;
        
        abrirVentanaImpresion(datos.periodo, "IMPRESI√ìN INDIVIDUAL", new Date().toLocaleDateString('es-AR'), filasHTML, datos.deuda);
    }

    function abrirVentanaImpresion(ref, mand, fecha, filas, saldoPendiente = null) {
        const v = window.open('', '', 'height=800,width=1000');
        const htmlDeuda = (saldoPendiente !== null && saldoPendiente !== undefined) 
            ? `<div style="margin-top:20px; border: 3px solid #dc3545; background-color: #f8d7da; color: #842029; padding: 10px; font-weight:bold; font-size:18px; text-align:center; border-radius:8px;">
                 ‚ö†Ô∏è DEUDA PENDIENTE ACTUAL: $${parseFloat(saldoPendiente).toLocaleString('es-AR', {minimumFractionDigits: 2})}
               </div>` 
            : '';

        v.document.write(`<html><head><title>Impresi√≥n Liquidaci√≥n</title><style>
            body { font-family: 'Courier New', monospace; font-size: 14px; padding: 20px; }
            h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 30px; }
            .header-farmacia { text-align: center; margin-bottom: 30px; font-weight: bold; font-size: 1.2em; line-height: 1.5; }
            .info-box { border: 2px solid #000; padding: 15px; margin-bottom: 20px; background: #f8f9fa; }
            .info-line { margin-bottom: 5px; font-size: 16px; }
            .info-label { font-weight: 900; margin-right: 10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th { border-bottom: 2px solid #000; padding: 8px; background: #e9ecef; text-align: center; font-size: 12px; font-weight:bold; }
            td { border-bottom: 1px solid #ccc; padding: 8px; font-size: 13px; }
            .firma { margin-top: 100px; text-align: right; font-weight: bold; padding-right: 50px; }
            .footer { text-align:center; margin-top:50px; font-size:10px; color: #666; border-top: 1px solid #ccc; padding-top: 10px;}
        </style></head><body>
            <div class="header-farmacia">
                ${farmaciaInfo.nombre}<br>
                ${farmaciaInfo.domicilio}<br>
                CUIT: ${farmaciaInfo.cuit} - Condici√≥n IVA: ${farmaciaInfo.iva}
            </div>
            <h1>DETALLE DE LIQUIDACI√ìN</h1>
            <div class="info-box">
                <div class="info-line"><span class="info-label">REFERENCIA / PERIODO:</span> ${ref}</div>
                <div class="info-line"><span class="info-label">MANDATARIA / GRUPO:</span> ${mand}</div>
                <div class="info-line"><span class="info-label">FECHA IMPRESI√ìN:</span> ${fecha}</div>
                ${htmlDeuda}
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="text-align:left;">OBRA SOCIAL</th><th>PLAN</th><th>RECETAS</th>
                        <th style="text-align:right;">BRUTO ORIG.</th><th style="text-align:right;">CARGO O.S.</th>
                        <th style="text-align:right;">BONIFICACI√ìN</th><th style="text-align:right;">NETO A PAGAR</th>
                    </tr>
                </thead>
                <tbody>${filas}</tbody>
            </table>
            <div class="firma">_______________________________<br>Firma Responsable</div>
            <div class="footer">Documento generado el: ${new Date().toLocaleString()}</div>
        </body></html>`);
        v.document.close(); v.focus(); setTimeout(() => { v.print(); v.close(); }, 500);
    }
</script>
}