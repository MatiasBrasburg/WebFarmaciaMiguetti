@using System.Text.Json
@using WebFarmaciaMiguetti.Models
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Gesti√≥n de Cobros";
    var listaMandatarias = (ViewBag.Mandatarias as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var listaObrasSociales = (ViewBag.ObrasSociales as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var listaTiposPago = (ViewBag.TiposPago as List<string>) ?? new List<string> { "Transferencia", "Cheque", "Efectivo", "Dep√≥sito" };

    var jsonObrasSociales = JsonSerializer.Serialize(listaObrasSociales.Select(x => new { id = x.IdObrasSociales, nombre = x.Nombre, idMandataria = x.IdMandataria }));
var jsonMandatarias = JsonSerializer.Serialize(listaMandatarias.Select(x => new { id = x.IdMandatarias, nombre = x.RazonSocial })); 

    // --- RECUPERAR DATOS DE LA FARMACIA DESDE SESI√ìN ---
    string nombreFarmacia = "FARMACIA";
    string direccionFarmacia = "Domicilio no configurado";
    string cuitFarmacia = "---";
    string ivaFarmacia = "Consumidor Final";

    var usuarioJson = HttpContextAccessor.HttpContext.Session.GetString("Usuario");
    if (!string.IsNullOrEmpty(usuarioJson))
    {
        try {
            var usuarioObj = JsonSerializer.Deserialize<Usuario>(usuarioJson);
            if(usuarioObj != null) {
                nombreFarmacia = usuarioObj.RazonSocial ?? "FARMACIA MIGUETTI";
                direccionFarmacia = usuarioObj.Domicilio ?? "";
                cuitFarmacia = usuarioObj.Cuit.ToString() ?? "";
                ivaFarmacia = usuarioObj.Iva ?? "";
            }
        } catch { }
    }
}

<style>
    /* =========================================
       ESTILOS DE ALTO IMPACTO (UX 85 A√ëOS)
       ========================================= */
    body { font-family: 'Verdana', sans-serif; background-color: #f4f6f9; color: #000; }
    
    h1 { font-size: 2.2rem; font-weight: 900; color: #146c43; text-transform: uppercase; border-bottom: 5px solid #146c43; display: inline-block; margin-bottom: 20px; }
    
    .form-label { font-weight: 900; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 5px; display: block; }

    /* --- ALINEACI√ìN PERFECTA DE LA FILA DE CARGA --- */
    .row.align-items-end .form-control, 
    .row.align-items-end .form-select, 
    .row.align-items-end .btn {
        height: 42px !important; /* Altura fija est√°ndar */
        font-size: 1.05rem;
        font-weight: 700;
        display: flex;
        align-items: center; 
    }

    /* Ajustes cosm√©ticos generales */
    .form-control, .form-select { 
        border: 2px solid #6c757d; 
        color: #000;
        padding: 5px 10px;
    }
    
    .form-control:focus, .form-select:focus { 
        border-color: #198754; 
        box-shadow: 0 0 0 0.25rem rgba(25,135,84, 0.25); 
        background-color: #f0fff4; 
    }

    /* El grupo del buscador + bot√≥n deuda */
    .input-group .btn {
        border: 2px solid #0d6efd;
        z-index: 5;
        padding-left: 15px;
        padding-right: 15px;
    }
    
    .input-group .form-control {
        border: 2px solid #6c757d; 
    }

    /* BUSCADORES FLOTANTES */
    .buscador-wrapper { position: relative; flex-grow: 1; }
    .lista-sugerencias { 
        position: absolute; top: 100%; left: 0; width: 100%; 
        background: white; border: 3px solid #000; border-top: none; 
        z-index: 10000; display: none; max-height: 250px; overflow-y: auto; 
        box-shadow: 0px 10px 20px rgba(0,0,0,0.4);
    }
    .item-sugerencia { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #ccc; font-weight: 700; font-size: 1rem; color: #333; }
    .item-sugerencia:hover { background-color: #198754; color: white; }

    /* BOTONES GENERALES */
    .btn-super { font-size: 1.1rem; font-weight: 800; padding: 10px 20px; border: 2px solid rgba(0,0,0,0.2); text-transform: uppercase; letter-spacing: 1px; }
    
    /* TOTALES Y TABLAS */
    .total-display { font-size: 2rem; font-weight: 900; color: #198754; text-align: right; padding: 15px; background: #d1e7dd; border: 3px solid #198754; border-radius: 6px; }
    .table-container { border: 3px solid #000; border-radius: 4px; overflow: hidden; background: white; margin-top:15px; }
    .table thead th { background-color: #146c43; color: white; font-size: 1.1rem; vertical-align: middle; text-align: center; border-bottom: 3px solid #000; padding: 15px; }
    .table tbody td { font-size: 1.05rem; vertical-align: middle; font-weight: 600; padding: 10px; }

    /* COLORES DE CABECERA MODAL */
    .bg-header-add { background-color: #198754; color: white; border-bottom: 5px solid #0f5132; }
    .bg-header-view { background-color: #0d6efd; color: white; border-bottom: 5px solid #0a58ca; }
    .bg-header-edit { background-color: #ffc107; color: #000; border-bottom: 5px solid #000; }

    .active-sugerencia {
    background-color: #198754 !important;
    color: white !important;
}
</style>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>üí∞ GESTI√ìN DE COBROS</h1>
        <button class="btn btn-success btn-lg btn-super shadow" onclick="abrirModalNuevo()">‚ûï NUEVO LOTE</button>
    </div>

    <div class="card mb-4 shadow-sm" style="border: 3px solid #6c757d; background-color: #e2e3e5;">
        <div class="card-body">
            <h4 class="mb-3 fw-bold">üîç BUSCAR LOTES</h4>
            <div class="row g-3 align-items-end">
                <div class="col-md-2"><label class="form-label">Desde</label><input type="date" id="filtroDesde" class="form-control" data-enter="buscarCobros"></div>
                <div class="col-md-2"><label class="form-label">Hasta</label><input type="date" id="filtroHasta" class="form-control" data-enter="buscarCobros"></div>
                <div class="col-md-3">
                <label class="form-label">Mandataria</label>
                <div class="buscador-wrapper">
                    <input type="text" id="txtFiltroMandataria" class="form-control" placeholder="Escriba para buscar..." autocomplete="off">
                    <input type="hidden" id="filtroMandataria" value="0">
                    <div id="listaFiltroMandataria" class="lista-sugerencias"></div>
                </div>
            </div>
                <div class="col-md-3">
                    <label class="form-label">Obra Social</label>
                    <div class="buscador-wrapper">
                        <input type="text" id="txtFiltroOS" class="form-control" placeholder="Buscar..." autocomplete="off">
                        <input type="hidden" id="filtroOS" value="0">
                        <div id="listaFiltroOS" class="lista-sugerencias"></div>
                    </div>
                </div>
                <div class="col-md-2 d-flex gap-2">
                    <button class="btn btn-primary btn-super w-100" onclick="buscarCobros()">BUSCAR</button>
                    <button class="btn btn-secondary btn-super" onclick="limpiarFiltros()">üîÑ</button>
                </div>
            </div>
            
            <div class="mt-3 text-end">
                <button class="btn btn-dark fw-bold btn-super" onclick="imprimirListadoCobros()">üñ®Ô∏è IMPRIMIR LISTADO</button>
            </div>
        </div>
    </div>

    <div class="table-container shadow">
        <table class="table table-striped table-hover mb-0">
            <thead>
                <tr>
                    <th>FECHA LOTE</th>
                    <th>MANDATARIA</th>
                    <th>COMPROBANTE</th>
                    <th class="text-center">ITEMS</th>
                    <th class="text-end pe-4">TOTAL IMPORTE</th>
                    <th class="text-end pe-4">TOTAL NETO</th>
                    <th class="text-center">ACCIONES</th>
                </tr>
            </thead>
            <tbody id="tbodyResultados"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalNuevo" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-xl" style="max-width: 95%;"> 
        <div class="modal-content border-0">
            <div class="modal-header bg-header-add py-3">
                <h3 class="modal-title fw-bold">üßæ NUEVO LOTE DE COBROS</h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-4">
                <div class="row g-3 mb-4 p-3 border border-3 border-success rounded bg-white shadow-sm">
                    <div class="col-md-4">
                    <label class="form-label text-success">1. MANDATARIA</label>
                    <div class="buscador-wrapper">
                        <input type="text" id="txtN_Mand" class="form-control fw-bold border-success" placeholder="Escriba Mandataria..." autocomplete="off">
                        
                        <input type="hidden" id="n_Mand" value="0" onchange="alCambiarMandatariaNuevo()">
                        
                        <div id="listaN_Mand" class="lista-sugerencias"></div>
                    </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">N¬∞ COMPROBANTE</label>
                        <input type="text" id="n_Comp" class="form-control" placeholder="Ej: REC-001">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">FECHA REFERENCIA</label>
                        <input type="date" id="n_FechaRef" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" onchange="actualizarFechaDefault()">
                    </div>
                </div>

                <h5 class="fw-bold text-success mb-2">2. AGREGAR PAGOS</h5>
                <div class="card mb-3 border-2 border-secondary shadow-sm">
                    <div class="card-body bg-white py-3">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label small">OBRA SOCIAL</label>
                                <div class="input-group">
                                    <div class="buscador-wrapper flex-grow-1">
                                        <input type="text" id="txtN_OS" class="form-control fw-bold" placeholder="Buscar..." autocomplete="off">
                                        <input type="hidden" id="valN_OS" value="0">
                                        <div id="listN_OS" class="lista-sugerencias"></div>
                                    </div>
                                    <button class="btn btn-outline-primary fw-bold" type="button" onclick="abrirModalDeudas('Nuevo')">üîç DEUDAS</button>
                                </div>
                            </div>
                            <div class="col-md-2"><label class="form-label small">FECHA PAGO</label><input type="date" id="n_ItemFecha" class="form-control fw-bold"></div>
                            <div class="col-md-2"><label class="form-label small">TIPO</label><select id="n_ItemTipo" class="form-select fw-bold">@foreach(var t in listaTiposPago){<option value="@t">@t</option>}</select></div>
                            <div class="col-md-2"><label class="form-label small text-success">IMPORTE</label><input type="number" id="n_Imp" class="form-control text-success fw-bold" placeholder="$" data-enter="aggTemp"></div>
                            <div class="col-md-1"><label class="form-label small text-danger">D√âB.</label><input type="number" id="n_Deb" class="form-control text-danger fw-bold" value="0" data-enter="aggTemp"></div>
                            <div class="col-md-1"><button class="btn btn-success w-100 fw-bold" onclick="aggTemp()">‚¨áÔ∏è</button></div>
                        </div>
                        <input type="hidden" id="n_IdLiqDetalle" value=""> <small id="lblDeudaSeleccionada" class="text-primary fw-bold ms-1" style="display:none;"></small>
                    </div>
                </div>

                <div class="table-responsive border border-2 border-dark rounded bg-white" style="height:250px; overflow-y:auto;">
                    <table class="table table-bordered mb-0">
                        <thead class="table-light sticky-top">
                            <tr><th>OBRA SOCIAL</th><th>FECHA</th><th>TIPO</th><th class="text-end">IMPORTE</th><th class="text-end">D√âBITOS</th><th>LIQ.</th><th class="text-center">X</th></tr>
                        </thead>
                        <tbody id="tbodyTemp"></tbody>
                    </table>
                </div>
                <div class="row mt-3 justify-content-end"><div class="col-md-6"><div class="total-display">TOTAL: <span id="lblTotalLote">$0.00</span></div></div></div>
            </div>
            <div class="modal-footer bg-light py-3">
                <button class="btn btn-secondary btn-lg btn-super me-auto" data-bs-dismiss="modal">CANCELAR</button>
                <button class="btn btn-success btn-lg btn-super px-5 shadow" onclick="guardarNuevoLote()">üíæ GUARDAR LOTE</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVer" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-4 border-primary">
            <div class="modal-header bg-header-view"><h4 class="modal-title fw-bold text-white">üëÅÔ∏è DETALLE DEL LOTE</h4><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body bg-light p-4">
                <div class="row mb-3 bg-white border p-3 rounded mx-1 shadow-sm">
                    <div class="col-md-6"><span class="text-muted small d-block">MANDATARIA:</span><h4 class="fw-bold text-primary m-0" id="v_Titulo">---</h4></div>
                    <div class="col-md-3"><span class="text-muted small d-block">COMPROBANTE:</span><h4 class="fw-bold m-0" id="v_Comp">---</h4></div>
                    <div class="col-md-3"><span class="text-muted small d-block">FECHA LOTE:</span><h4 class="fw-bold m-0" id="v_Fecha">---</h4></div>
                </div>
                
                <div class="card mb-3 border-2 border-primary">
                    <div class="card-header bg-primary text-white fw-bold py-1">‚ûï AGREGAR PAGO SUELTO</div>
                    <div class="card-body py-2">
                        <div class="row g-1 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label small mb-1">OBRA SOCIAL</label>
                                <div class="input-group input-group-sm">
                                    <div class="buscador-wrapper flex-grow-1">
                                        <input type="text" id="txtV_OS" class="form-control form-control-sm fw-bold" placeholder="Obra Social..." autocomplete="off">
                                        <input type="hidden" id="valV_OS" value="0">
                                        <div id="listV_OS" class="lista-sugerencias"></div>
                                    </div>
                                    <button class="btn btn-outline-primary fw-bold" type="button" onclick="abrirModalDeudas('Ver')">üîç</button>
                                </div>
                            </div>
                            <div class="col-md-2"><label class="form-label small">FECHA PAGO</label><input type="date" id="v_FechaItem" class="form-control form-control-sm"></div>
                            <div class="col-md-2"><label class="form-label small">TIPO</label><select id="v_TipoItem" class="form-select form-select-sm">@foreach(var t in listaTiposPago){<option value="@t">@t</option>}</select></div>
                            <div class="col-md-2"><label class="form-label small text-success">IMPORTE</label><input type="number" id="v_Imp" class="form-control form-control-sm text-success fw-bold" placeholder="0.00" data-enter="agregarAlLote"></div>
                            <div class="col-md-2"><label class="form-label small text-danger">DEBITO</label><input type="number" id="v_Imp" class="form-control form-control-sm text-success fw-bold" placeholder="0.00" data-enter="agregarAlLote"></div>

                            <div class="col-md-2"><button class="btn btn-primary fw-bold w-100 btn-sm" onclick="agregarAlLote()">AGREGAR</button></div>
                        </div>
                        <input type="hidden" id="v_IdLiqDetalle" value="">
                        <small id="lblDeudaSeleccionadaVer" class="text-primary fw-bold ms-1" style="display:none;"></small>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold text-primary m-0">DETALLES IMPUTADOS</h5>
                    <input type="text" id="buscadorInterno" class="form-control w-50" placeholder="üîç Filtrar en esta lista..." onkeyup="filtrarInterno()">
                </div>

                <div class="table-responsive border border-2 border-dark rounded bg-white" style="height: 300px; overflow-y: auto;">
                    <table class="table table-bordered table-sm mb-0">
                        <thead class="table-dark sticky-top">
                            <tr><th>OS</th><th>FECHA</th><th>TIPO</th><th class="text-end">IMPORTE</th><th class="text-end">NETO</th><th class="text-center">X</th></tr>
                        </thead>
                        <tbody id="tbodyVer"></tbody>
                    </table>
                </div>
                <div class="row mt-3 justify-content-end">
                    <div class="col-md-6"><div class="total-display">TOTAL: <span id="lblTotalBrutoVer" class="text-dark">$0.00</span></div></div>
                </div>
            </div>
            <div class="modal-footer bg-light"><button class="btn btn-secondary btn-lg fw-bold px-5" data-bs-dismiss="modal">CERRAR</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDeudas" tabindex="-1" style="z-index: 1070;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-info">
            <div class="modal-header bg-info text-dark fw-bold">
                <h5 class="modal-title">üìâ SELECCIONAR DEUDA A PAGAR</h5>
                <button type="button" class="btn-close" onclick="cerrarModalDeudas()"></button>
            </div>
            <div class="modal-body p-0">
                <div class="p-2 bg-light border-bottom">
                    <span id="lblTituloDeudas" class="fw-bold text-uppercase"></span>
                </div>
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover mb-0">
                        <thead class="table-secondary sticky-top">
                            <tr><th>PERIODO</th><th>FECHA LIQ.</th><th class="text-end">IMPORTE ORIGINAL</th><th class="text-end">SALDO PENDIENTE</th><th>ACCI√ìN</th></tr>
                        </thead>
                        <tbody id="tbodyDeudas"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEdit" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-warning">
            <div class="modal-header bg-header-edit"><h4 class="modal-title fw-bold">‚úèÔ∏è CORREGIR CABECERA</h4><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body bg-white p-4">
                <input type="hidden" id="e_IdCobroRef">
                <div class="row g-3">
                    <div class="col-md-12"><label class="form-label">Mandataria</label><select id="e_Mandataria" class="form-select">@foreach (var m in listaMandatarias) { <option value="@m.IdMandatarias">@m.RazonSocial</option> }</select></div>
                    <div class="col-md-6"><label class="form-label">Fecha Lote</label><input type="date" id="e_Fecha" class="form-control"></div>
                    <div class="col-md-6"><label class="form-label">Comprobante</label><input type="text" id="e_Comp" class="form-control"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-warning fw-bold px-4" onclick="guardarEdicionLote()">GUARDAR CAMBIOS</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditDetalle" tabindex="-1" style="z-index: 1060;">
    <div class="modal-dialog">
        <div class="modal-content border-warning">
            <div class="modal-header bg-warning py-2"><h5 class="modal-title fw-bold">EDITAR PAGO</h5><button type="button" class="btn-close" onclick="cerrarEditDetalle()"></button></div>
            <div class="modal-body p-3">
                <input type="hidden" id="ed_Id">
                <input type="hidden" id="valED_OS">
                <div class="mb-2"><label>Obra Social</label><input type="text" id="txtED_OS" class="form-control fw-bold" readonly disabled></div>
                <div class="row g-2">
                    <div class="col-6"><label>Fecha</label><input type="date" id="ed_Fecha" class="form-control"></div>
                    <div class="col-6"><label>Tipo</label><select id="ed_Tipo" class="form-select">@foreach(var t in listaTiposPago){<option value="@t">@t</option>}</select></div>
                    <div class="col-6"><label>Importe</label><input type="number" id="ed_Imp" class="form-control fw-bold text-success"></div>
                    <div class="col-6"><label>D√©bitos</label><input type="number" id="ed_Deb" class="form-control fw-bold text-danger"></div>
                </div>
            </div>
            <div class="modal-footer py-2"><button class="btn btn-warning fw-bold w-100" onclick="guardarEditDetalle()">GUARDAR</button></div>
        </div>
    </div>
</div>

<script>
    // DATOS DE FARMACIA (Para Impresi√≥n)
    const farmaciaInfo = {
        nombre: "@Html.Raw(nombreFarmacia)",
        domicilio: "@Html.Raw(direccionFarmacia)",
        cuit: "@Html.Raw(cuitFarmacia)",
        iva: "@Html.Raw(ivaFarmacia)"
    };

    var datosOS = @Html.Raw(jsonObrasSociales);
    var datosMand = @Html.Raw(jsonMandatarias ?? "[]");
    var datosOS_FiltradosNuevo = [];
    var itemsTemp = []; 
    var datosAgrupados = {}; 
    var loteContexto = {}; 
    var mVer, mNuevo, mEdit, mEditDetalle, mDeudas;
    var origenDeuda = ""; 

    document.addEventListener("DOMContentLoaded", () => {
        mVer = new bootstrap.Modal(document.getElementById('modalVer'));
        mNuevo = new bootstrap.Modal(document.getElementById('modalNuevo'));
        mEdit = new bootstrap.Modal(document.getElementById('modalEdit'));
        mEditDetalle = new bootstrap.Modal(document.getElementById('modalEditDetalle'));
        mDeudas = new bootstrap.Modal(document.getElementById('modalDeudas'));

        setupAuto('txtFiltroOS', 'listaFiltroOS', 'filtroOS', datosOS);
        setupAuto('txtFiltroMandataria', 'listaFiltroMandataria', 'filtroMandataria', datosMand);
        setupAuto('txtN_Mand', 'listaN_Mand', 'n_Mand', datosMand);
        setupAuto('txtN_OS', 'listN_OS', 'valN_OS', datosOS_FiltradosNuevo);
        setupAuto('txtV_OS', 'listV_OS', 'valV_OS', datosOS);

        // --- NAVEGACI√ìN MEJORADA (LOCAL) ---
        // 1. Auto-Focus en Modales
        document.getElementById('modalNuevo').addEventListener('shown.bs.modal', function () { document.getElementById('n_Comp').focus(); });
        document.getElementById('modalVer').addEventListener('shown.bs.modal', function () { document.getElementById('txtV_OS').focus(); });
        document.getElementById('modalEditDetalle').addEventListener('shown.bs.modal', function () { document.getElementById('ed_Imp').focus(); });

        // 2. Evento Enter Global (Delegado)
        document.addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                const target = e.target;
                if(target.dataset && target.dataset.enter) {
                    e.preventDefault();
                    const fnName = target.dataset.enter;
                    if(typeof window[fnName] === 'function') window[fnName]();
                }
            }
        });

        buscarCobros(); 
        
        const hoy = new Date().toISOString().substring(0, 10);
        if(document.getElementById('n_FechaRef')) document.getElementById('n_FechaRef').value = hoy;
        if(document.getElementById('n_ItemFecha')) document.getElementById('n_ItemFecha').value = hoy;
    });

   // --- FUNCI√ìN SETUP AUTO MEJORADA (CON FLECHAS Y TAB) ---
    function setupAuto(inpId, listId, hidId, fuenteDatos) {
        const inp = document.getElementById(inpId);
        const list = document.getElementById(listId);
        const hid = document.getElementById(hidId);
        let currentFocus = -1; // √çndice para navegar con flechas

        inp.addEventListener("input", function() {
            const t = this.value.toLowerCase();
            list.innerHTML = '';
            currentFocus = -1;
            
            // L√≥gica espec√≠fica de limpieza (Mantenemos tu l√≥gica original)
            if (inpId === 'txtN_OS') { 
                document.getElementById('n_IdLiqDetalle').value = ""; 
                document.getElementById('lblDeudaSeleccionada').style.display = 'none';
            }
            if (inpId === 'txtV_OS') { 
                document.getElementById('v_IdLiqDetalle').value = "";
                document.getElementById('lblDeudaSeleccionadaVer').style.display = 'none'; 
            }

            if (t.length < 1) { 
                list.style.display = 'none';
                hid.value="0"; 
                return; 
            }

            // Filtramos y mostramos m√°ximo 50 resultados para rendimiento
            const f = fuenteDatos.filter(x => x.nombre.toLowerCase().includes(t)).slice(0, 50);
            
            if (f.length === 0) { 
                list.innerHTML = '<div class="item-sugerencia text-muted">üö´ NO EXISTE</div>'; 
                list.style.display = 'block'; 
                return;
            }

            f.forEach(x => {
                const item = document.createElement('div');
                item.className = 'item-sugerencia'; 
                item.textContent = x.nombre;
                // Guardamos datos en el elemento para usarlos al hacer click/enter
                item.dataset.nombre = x.nombre;
                item.dataset.id = x.id;

                item.addEventListener("click", function() {
                    seleccionarItem(this);
                });
                list.appendChild(item);
            });
            list.style.display = 'block';
        });

        // --- NAVEGACI√ìN POR TECLADO ---
        inp.addEventListener("keydown", function(e) {
            let x = list.getElementsByTagName("div");
            if (e.key === "ArrowDown") {
                currentFocus++;
                addActive(x);
            } else if (e.key === "ArrowUp") {
                currentFocus--;
                addActive(x);
            } else if (e.key === "Enter") {
                e.preventDefault();
                if (currentFocus > -1) {
                    if (x) x[currentFocus].click();
                } else if (list.style.display === "block" && x.length > 0) {
                    // Si aprieta Enter sin seleccionar, elegimos el primero
                    x[0].click();
                }
            } else if (e.key === "Tab") {
                // Si aprieta Tab y hay lista, seleccionamos el primero o el activo
                if (list.style.display === "block" && x.length > 0) {
                    e.preventDefault(); // Evitamos que se vaya el foco antes de seleccionar
                    if (currentFocus > -1) x[currentFocus].click();
                    else x[0].click();
                    // Opcional: mover el foco manualmente al siguiente campo si es necesario
                }
            }
        });

        // Ocultar al perder foco (con delay para permitir el click)
        inp.addEventListener("blur", function() { 
            setTimeout(() => { list.style.display = 'none'; }, 200); 
        });

        // --- FUNCIONES AUXILIARES INTERNAS ---
       function seleccionarItem(elemento) {
    inp.value = elemento.dataset.nombre;
    hid.value = elemento.dataset.id;
    list.style.display = 'none';
    
    // --- ESTA ES LA L√çNEA QUE FALTABA ---
    // Le avisa al input oculto que cambi√≥, para que se dispare 'alCambiarMandatariaNuevo'
    hid.dispatchEvent(new Event('change')); 
    // ------------------------------------

    // Foco inteligente seg√∫n qu√© buscador sea
    if (inpId === 'txtN_OS') document.getElementById('n_Imp').focus();
    if (inpId === 'txtV_OS') document.getElementById('v_Imp').focus();
    if (inpId === 'txtFiltroMandataria') document.getElementById('txtFiltroOS').focus();
    // Nuevo: Al elegir mandataria, saltamos al buscador de OS
    if (inpId === 'txtN_Mand') document.getElementById('txtN_OS').focus();
}

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("active-sugerencia");
            x[currentFocus].scrollIntoView({ block: "nearest" });
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("active-sugerencia");
            }
        }
    }
    function alCambiarMandatariaNuevo() {
        const idMand = parseInt(document.getElementById('n_Mand').value) || 0;
        
        // 1. Limpiamos los inputs de Obra Social
        document.getElementById('txtN_OS').value = ''; 
        document.getElementById('valN_OS').value = '0';
        document.getElementById('n_IdLiqDetalle').value = ""; 
        document.getElementById('lblDeudaSeleccionada').style.display = 'none';

        // 2. MAGIA: Vaciamos la lista puente (sin romper la referencia)
        datosOS_FiltradosNuevo.length = 0;

        // 3. Filtramos los datos originales
        const filtradas = idMand > 0 
            ? datosOS.filter(x => x.idMandataria == idMand) 
            : datosOS;

        // 4. Llenamos la lista puente con los nuevos datos
        datosOS_FiltradosNuevo.push(...filtradas);
        
       
    }
    
    function actualizarFechaDefault() {
        if(itemsTemp.length === 0 && document.getElementById('n_ItemFecha')) {
            document.getElementById('n_ItemFecha').value = document.getElementById('n_FechaRef').value;
        }
    }

    async function buscarCobros() {
        const tbody = document.getElementById('tbodyResultados');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4"><div class="spinner-border text-success"></div></td></tr>';
        
        let url = `@Url.Action("BuscarCobrosAjax", "Home")?dummy=1` +
            `&IdMandataria=${document.getElementById('filtroMandataria').value}` +
            `&IdObraSocial=${document.getElementById('filtroOS').value}` +
            `&desde=${document.getElementById('filtroDesde').value}` +
            `&hasta=${document.getElementById('filtroHasta').value}`;
        
        try {
            const r = await fetch(url);
            const res = await r.json();
            if(res.success && res.data.length > 0) {
                datosAgrupados = {};
                tbody.innerHTML = '';
                res.data.forEach(x => {
                    const idPadre = x.IdCobros || x.idCobros;
                    const totI = parseFloat(x.TotalImporte||0);
                    const totD = parseFloat(x.TotalDebitos||0);
                    
                    datosAgrupados[idPadre] = {
                        idPadre: idPadre,
                        comp: (x.NumeroComprobante||'S/N'),
                        fecha: (x.FechaCobro||'').split('T')[0],
                        mand: x.NombreMandataria,
                        idMand: x.IdMandatarias
                    };

                    tbody.innerHTML += `
                    <tr>
                        <td class="text-center">${datosAgrupados[idPadre].fecha}</td>
                        <td class="fw-bold text-primary">${datosAgrupados[idPadre].mand}</td>
                        <td class="fw-bold text-center">${datosAgrupados[idPadre].comp}</td>
                        <td class="text-center fw-bold fs-5">${x.CantidadItems}</td>
                        <td class="text-end fw-bold fs-5 text-dark">$${totI.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                        <td class="text-end fw-black fs-5 text-success border-start border-end bg-light">$${(totI-totD).toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                        <td class="text-center">
                            <button class="btn btn-danger btn-sm me-1" onclick="eliminarLoteCompleto(${idPadre})" title="Eliminar Todo">üóëÔ∏è</button>
                            <button class="btn btn-warning btn-sm me-1" onclick="abrirEditarLote(${idPadre})" title="Editar Cabecera">‚úèÔ∏è</button>
                            <button class="btn btn-primary btn-sm fw-bold px-3" onclick="abrirVer(${idPadre})">üëÅÔ∏è VER</button>
                        </td>
                    </tr>`;
                });
            } else tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-muted">Sin datos.</td></tr>';
        } catch(e) { console.error(e); tbody.innerHTML = '<tr><td colspan="7" class="text-danger">Error de red</td></tr>'; }
    }

    function limpiarFiltros() { 
        document.getElementById('filtroMandataria').value = 0; document.getElementById('txtFiltroOS').value = ""; 
        document.getElementById('filtroOS').value = 0; document.getElementById('filtroDesde').value = ""; document.getElementById('filtroHasta').value = "";
        buscarCobros(); 
    }

    // --- IMPRESI√ìN MEJORADA ---
    function imprimirListadoCobros() {
        const tabla = document.getElementById('tbodyResultados');
        let filas = "";
        let tImp = 0; let tNet = 0;
        
        tabla.querySelectorAll('tr').forEach(tr => {
            const cols = tr.querySelectorAll('td');
            if(cols.length > 5) {
                const imp = parseFloat(cols[4].textContent.replace('$','').replace('.','').replace(',','.')) || 0;
                const net = parseFloat(cols[5].textContent.replace('$','').replace('.','').replace(',','.')) || 0;
                tImp += imp; tNet += net;

                filas += "<tr>" +
                    "<td style='text-align:center;'>" + cols[0].textContent + "</td>" +
                    "<td>" + cols[1].textContent + "</td>" +
                    "<td style='text-align:center;'>" + cols[2].textContent + "</td>" +
                    "<td style='text-align:center;'>" + cols[3].textContent + "</td>" +
                    "<td style='text-align:right;'>" + cols[4].textContent + "</td>" +
                    "<td style='text-align:right; font-weight:bold;'>" + cols[5].textContent + "</td>" +
                "</tr>";
            }
        });

        const totalRow = "<tr style='background:#eee; font-weight:bold;'><td colspan='4' style='text-align:right'>TOTALES:</td><td style='text-align:right'>$" + tImp.toLocaleString('es-AR',{minimumFractionDigits:2}) + "</td><td style='text-align:right'>$" + tNet.toLocaleString('es-AR',{minimumFractionDigits:2}) + "</td></tr>";

        const v = window.open('', '', 'height=800,width=1000');
        v.document.write('<html><head><title>Listado</title><style>');
        v.document.write('body { font-family: Courier New, monospace; padding: 20px; }');
        v.document.write('.header { text-align:center; margin-bottom:20px; font-weight:bold; font-size:1.1em; }');
        v.document.write('table { width: 100%; border-collapse: collapse; margin-top: 20px; }');
        v.document.write('th { border-bottom: 2px solid #000; padding: 8px; background: #eee; }');
        v.document.write('td { border-bottom: 1px solid #ccc; padding: 8px; font-size: 12px; }');
        v.document.write('</style></head><body>');
        
        v.document.write('<div class="header">');
        v.document.write(farmaciaInfo.nombre + '<br>');
        v.document.write(farmaciaInfo.domicilio + ' - CUIT: ' + farmaciaInfo.cuit + '<br>');
        v.document.write(farmaciaInfo.iva);
        v.document.write('</div>');

        v.document.write('<h2 style="text-align:center">LISTADO DE LOTES DE COBROS</h2>');
        v.document.write('<table><thead><tr><th>FECHA</th><th>MANDATARIA</th><th>COMPROBANTE</th><th>ITEMS</th><th>TOTAL IMPORTE</th><th>TOTAL NETO</th></tr></thead><tbody>');
        v.document.write(filas);
        v.document.write(totalRow);
        v.document.write('</tbody></table>');
        v.document.write('<div style="text-align:center; margin-top:30px; font-size:10px;">Generado el: ' + new Date().toLocaleString() + '</div>');
        v.document.write('<' + '/body><' + '/html>'); // Rompemos etiquetas para que no fallen
        
        v.document.close(); 
        v.focus(); 
        setTimeout(function() { v.print(); v.close(); }, 500);
    }

    // --- L√ìGICA DE DEUDAS ---
    async function abrirModalDeudas(origen) {
        origenDeuda = origen;
        const idOS = (origen === 'Nuevo') ? document.getElementById('valN_OS').value : document.getElementById('valV_OS').value;
        const nombreOS = (origen === 'Nuevo') ? document.getElementById('txtN_OS').value : document.getElementById('txtV_OS').value;

        if(idOS == 0) { alert("‚ö†Ô∏è Seleccione primero una Obra Social."); return; }

        document.getElementById('lblTituloDeudas').textContent = "Deudas de: " + nombreOS;
        document.getElementById('tbodyDeudas').innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div> Buscando...</td></tr>';
        
        mDeudas.show();

        try {
            const r = await fetch(`@Url.Action("TraerDeudasPendientes", "Home")?idObraSocial=${idOS}`);
            const res = await r.json();
            const b = document.getElementById('tbodyDeudas'); b.innerHTML = '';

            if(res.success && res.data.length > 0) {
                res.data.forEach(d => {
                    const saldo = parseFloat(d.SaldoPendiente);
                    b.innerHTML += `
                    <tr>
                        <td>${d.Periodo}</td>
                        <td class="small">${(d.FechaPresentacion||'').split('T')[0]}</td>
                        <td class="text-end text-muted">$${parseFloat(d.ImporteOriginal).toLocaleString()}</td>
                        <td class="text-end fw-bold text-danger">$${saldo.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-success fw-bold" onclick="seleccionarDeuda(${d.IdLiquidacionDetalle}, ${saldo}, '${d.Periodo}')">‚úÖ PAGAR</button>
                        </td>
                    </tr>`;
                });
            } else b.innerHTML = '<tr><td colspan="5" class="text-center text-success fw-bold">üëè No hay deudas pendientes.</td></tr>';
        } catch(e) { alert("Error buscando deudas."); }
    }

    function seleccionarDeuda(idLiqDet, saldo, periodo) {
        mDeudas.hide();
        if(origenDeuda === 'Nuevo') {
            document.getElementById('n_Imp').value = saldo;
            document.getElementById('n_IdLiqDetalle').value = idLiqDet;
            const lbl = document.getElementById('lblDeudaSeleccionada');
            lbl.style.display = 'inline'; lbl.textContent = `(Paga: ${periodo})`;
            document.getElementById('n_Imp').focus();
        } else {
            document.getElementById('v_Imp').value = saldo;
            document.getElementById('v_IdLiqDetalle').value = idLiqDet;
            const lbl = document.getElementById('lblDeudaSeleccionadaVer');
            lbl.style.display = 'inline'; lbl.textContent = `(Paga: ${periodo})`;
            document.getElementById('v_Imp').focus();
        }
    }

    function cerrarModalDeudas() { mDeudas.hide(); }

    // --- NUEVO LOTE ---
    function abrirModalNuevo() { 
        itemsTemp = [];
        document.getElementById('tbodyTemp').innerHTML=''; 
        document.getElementById('n_Comp').value=""; 
        document.getElementById('lblTotalLote').textContent="$0.00";
        document.getElementById('n_FechaRef').value = new Date().toISOString().substring(0, 10);
        document.getElementById('n_Mand').value = "0";      
    document.getElementById('txtN_Mand').value = "";
        
        document.getElementById('txtN_OS').value = "";
        document.getElementById('valN_OS').value = "0";
        document.getElementById('n_Imp').value = "";
        document.getElementById('n_Deb').value = "0";
        document.getElementById('n_IdLiqDetalle').value = "";
        document.getElementById('lblDeudaSeleccionada').style.display = 'none';

        if(document.getElementById('n_ItemFecha')) document.getElementById('n_ItemFecha').value = document.getElementById('n_FechaRef').value;
        alCambiarMandatariaNuevo();
        mNuevo.show();
    }

    function aggTemp() {
        const id = document.getElementById('valN_OS').value;
        const nom = document.getElementById('txtN_OS').value;
        const fecha = document.getElementById('n_ItemFecha').value;
        const tipo = document.getElementById('n_ItemTipo').value;
        const imp = parseFloat(document.getElementById('n_Imp').value)||0;
        const deb = parseFloat(document.getElementById('n_Deb').value)||0;
        const idLiqDet = document.getElementById('n_IdLiqDetalle').value || null;

        if(id==0 || imp==0 || fecha=="") { alert("‚ö†Ô∏è Faltan datos (OS, Fecha, Importe)"); return; }
        
        itemsTemp.push({id:id, nom:nom, fecha:fecha, tipo:tipo, imp:imp, deb:deb, idLiq: idLiqDet});
        dibujarTemp();
        
        document.getElementById('n_Imp').value=""; 
        document.getElementById('n_Deb').value="0.00";
        document.getElementById('txtN_OS').value=""; 
        document.getElementById('valN_OS').value="0";
        document.getElementById('n_IdLiqDetalle').value = ""; 
        document.getElementById('lblDeudaSeleccionada').style.display = 'none';
        
        // FOCO AUTOM√ÅTICO AL BUSCADOR PARA SEGUIR CARGANDO
        document.getElementById('txtN_OS').focus();
    }

    function dibujarTemp() {
        const b = document.getElementById('tbodyTemp'); b.innerHTML='';
        let tot = 0;
        itemsTemp.forEach((x,i) => {
            tot += (x.imp - x.deb);
            const badgeDeuda = x.idLiq ? '<span class="badge bg-info text-dark">Imputado</span>' : '';
            b.innerHTML+=`<tr>
                <td class="fw-bold small">${x.nom}</td><td class="text-center small">${x.fecha}</td><td class="text-center small">${x.tipo}</td>
                <td class="text-end text-success">$${x.imp.toFixed(2)}</td><td class="text-end text-danger">$${x.deb.toFixed(2)}</td>
                <td class="text-center">${badgeDeuda}</td>
                <td class="text-center"><button class="btn btn-sm btn-danger py-0" onclick="itemsTemp.splice(${i},1);dibujarTemp()">x</button></td>
            </tr>`;
        });
        document.getElementById('lblTotalLote').textContent = `$${tot.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
    }

    async function guardarNuevoLote() {
        const mandId = parseInt(document.getElementById('n_Mand').value) || 0;
        const comp = document.getElementById('n_Comp').value.trim();
        const fechaRef = document.getElementById('n_FechaRef').value;

        if(mandId === 0 || comp === "" || itemsTemp.length === 0) { alert("‚ö†Ô∏è Faltan datos."); return; }
        if(!confirm("¬øConfirmar Lote?")) return;

        const loteFinal = itemsTemp.map(x => ({
            IdMandatariasMaestro: mandId, FechaCobroMaestro: fechaRef, NumeroComprobanteMaestro: comp,
            IdObrasSociales: parseInt(x.id), FechaCobroDetalle: x.fecha, TipoPago: x.tipo,
            ImporteCobrado: x.imp, MontoDebito: x.deb, MotivoDebito: "",
            IdLiquidacionDetalle: x.idLiq ? parseInt(x.idLiq) : null
        }));

        try {
            const r = await fetch('@Url.Action("GuardarLoteCobros", "Home")', { 
                method:'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(loteFinal)
            });
            const res = await r.json();
            if(res.success) { alert(res.message); mNuevo.hide(); buscarCobros(); } 
            else alert("‚ùå " + res.message);
        } catch(e) { alert("Error red: " + e.message); }
    }

    // --- VER DETALLES ---
    function abrirVer(idPadre) {
        const g = datosAgrupados[idPadre];
        if(!g) return;
        loteContexto = { fecha: g.fecha, comp: g.comp, mandatariaId: g.idMand, idPadre: idPadre };
        document.getElementById('v_Titulo').textContent = g.mand;
        document.getElementById('v_Comp').textContent = g.comp;
        document.getElementById('v_Fecha').textContent = g.fecha;
        document.getElementById('v_FechaItem').value = g.fecha; 

        document.getElementById('buscadorInterno').value = '';
        const osDeEstaMandataria = datosOS.filter(x => x.idMandataria == g.idMand);
        setupAuto('txtV_OS', 'listV_OS', 'valV_OS', osDeEstaMandataria);
        
        traerDetalles(idPadre);
        mVer.show();
    }

    async function traerDetalles(idPadre) {
        const b = document.getElementById('tbodyVer');
        b.innerHTML = '<tr><td colspan="6" class="text-center p-2"><div class="spinner-border spinner-border-sm"></div></td></tr>';
        
        try {
            const r = await fetch(`@Url.Action("TraerCobrosPorIdPadre", "Home")?idCobroPadre=${idPadre}`);
            const res = await r.json();
            
            b.innerHTML='';
            if(res.success) {
                let tot=0;
                res.data.forEach(x => {
                    const imp = parseFloat(x.ImporteCobrado||0);
                    const deb = parseFloat(x.MontoDebito||0);
                    tot += (imp - deb);
                    
                    b.innerHTML += `
                    <tr class="detalle-cobro-row">
                        <td class="fw-bold small">${x.NombreObraSocial}</td>
                        <td class="text-center small">${(x.FechaCobroDetalle||'').split('T')[0]}</td>
                        <td class="text-center small">${x.TipoPago}</td>
                        <td class="text-end text-success fw-bold">$${imp.toFixed(2)}</td>
                        <td class="text-end fw-black">$${(imp-deb).toFixed(2)}</td>
                        <td class="text-center">
                            <button class="btn btn-warning btn-sm me-1" onclick="abrirEditDetalle(${x.IdCobrosDetalle})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarDelLote(${x.IdCobrosDetalle})">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                document.getElementById('lblTotalBrutoVer').textContent = `$${tot.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
            } else alert(res.message);
        } catch (e) { console.error(e); }
    }

    async function agregarAlLote() {
        const idOS = document.getElementById('valV_OS').value;
        const imp = document.getElementById('v_Imp').value.replace(',','.');
        const idLiq = document.getElementById('v_IdLiqDetalle').value || null;

        if(idOS==0 || imp==0) { alert("Datos incompletos."); return; }

        const fd = new FormData();
        fd.append("IdCobro", 0); 
        fd.append("IdObraSocial", idOS); fd.append("IdObrasSociales", idOS);
        fd.append("IdMandataria", loteContexto.mandatariaId); 
        fd.append("FechaCobro", document.getElementById('v_FechaItem').value);
        fd.append("TipoPago", document.getElementById('v_TipoItem').value);
        fd.append("NumeroComprobante", loteContexto.comp);
        fd.append("ImporteCobrado", imp); fd.append("MontoDebitos", 0); fd.append("MotivoDebito", "");
        if(idLiq) fd.append("IdLiquidacionDetalle", idLiq);

        try {
            await fetch('@Url.Action("GuardarCobro", "Home")', { method:'POST', body:fd });
            document.getElementById('v_Imp').value=""; document.getElementById('txtV_OS').value=""; document.getElementById('valV_OS').value="0";
            document.getElementById('v_IdLiqDetalle').value=""; document.getElementById('lblDeudaSeleccionadaVer').style.display='none';
            
            buscarCobros(); 
            traerDetalles(loteContexto.idPadre);
            // FOCO AL BUSCADOR
            document.getElementById('txtV_OS').focus();
        } catch(e) { alert("Error de red."); }
    }

    async function eliminarLoteCompleto(idPadre) {
        if(!confirm("¬øEliminar TODO el lote?")) return;
        try {
            const r = await fetch('@Url.Action("EliminarLoteCompleto", "Home")', {
                method:'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: `idCobroPadre=${idPadre}`
            });
            const res = await r.json();
            if(res.success) { alert(res.message); buscarCobros(); } else alert(res.message);
        } catch(e) { alert("Error de red"); }
    }

    async function eliminarDelLote(id) {
        if(!confirm("¬øBorrar pago?")) return;
        const fd=new FormData(); fd.append("idCobro", id);
        try {
            await fetch('@Url.Action("EliminarCobro", "Home")', {method:'POST', body:fd});
            buscarCobros();
            traerDetalles(loteContexto.idPadre);
        } catch(e) { alert("Error al eliminar."); }
    }

    function abrirEditarLote(idPadre) {
        const g = datosAgrupados[idPadre];
        document.getElementById('e_IdCobroRef').value = g.idPadre;
        document.getElementById('e_Mandataria').value = g.idMand;
        document.getElementById('e_Fecha').value = g.fecha;
        document.getElementById('e_Comp').value = g.comp;
        mEdit.show();
    }

    async function guardarEdicionLote() {
        const fd = new FormData();
        fd.append("IdCobro", document.getElementById('e_IdCobroRef').value);
        fd.append("IdMandataria", document.getElementById('e_Mandataria').value);
        fd.append("Fecha", document.getElementById('e_Fecha').value);
        fd.append("Comprobante", document.getElementById('e_Comp').value);
        try {
            await fetch('@Url.Action("ModificarCabeceraLote", "Home")', {method:'POST', body:fd});
            mEdit.hide(); buscarCobros();
        } catch(e) { alert("Error red"); }
    }

    async function abrirEditDetalle(id) {
        const r = await fetch(`@Url.Action("ObtenerCobroPorId", "Home")?idCobro=${id}`);
        const res = await r.json();
        if(res.success) {
            const d = res.data;
            document.getElementById('ed_Id').value = id;
            document.getElementById('valED_OS').value = d.IdObrasSociales;
            document.getElementById('txtED_OS').value = datosOS.find(x=>x.id==d.IdObrasSociales)?.nombre||'---';
            document.getElementById('ed_Fecha').value = (d.FechaCobroDetalle||'').split('T')[0];
            document.getElementById('ed_Tipo').value = d.TipoPago;
            document.getElementById('ed_Imp').value = d.ImporteCobrado;
            document.getElementById('ed_Deb').value = d.MontoDebito;
            mEditDetalle.show();
        }
    }

    function cerrarEditDetalle() { mEditDetalle.hide(); }

    async function guardarEditDetalle() {
        const fd = new FormData();
        fd.append("IdCobro", document.getElementById('ed_Id').value);
        const idOS = document.getElementById('valED_OS').value;
        fd.append("IdObraSocial", idOS); fd.append("IdObrasSociales", idOS);
        
        // AGREGAMOS ESTO PARA QUE PASE LA VALIDACI√ìN DEL CONTROLLER
        fd.append("IdMandataria", loteContexto.mandatariaId); 
        
        fd.append("FechaCobro", document.getElementById('ed_Fecha').value);
        fd.append("TipoPago", document.getElementById('ed_Tipo').value);
        
        // MARCA ESPECIAL: "---" indica al Controller que es una edici√≥n
        fd.append("NumeroComprobante", "---"); 
        
        fd.append("ImporteCobrado", document.getElementById('ed_Imp').value.replace(',','.'));
        fd.append("MontoDebitos", document.getElementById('ed_Deb').value.replace(',','.'));
        fd.append("MotivoDebito", ""); // Campo obligatorio aunque vaya vac√≠o

        try {
            const r = await fetch('@Url.Action("GuardarCobro", "Home")', { method:'POST', body:fd });
            const res = await r.json();
            
            if(res.success) {
                mEditDetalle.hide(); 
                buscarCobros(); 
                traerDetalles(loteContexto.idPadre);
            } else {
                alert("Error: " + res.message);
            }
        } catch(e) { alert("Error de red"); }
    }
    
    function filtrarInterno() {
        const t = document.getElementById('buscadorInterno').value.toLowerCase();
        document.querySelectorAll('#tbodyVer tr.detalle-cobro-row').forEach(r => {
            const texto = r.innerText.toLowerCase();
            r.style.display = texto.includes(t) ? '' : 'none';
        });
    }
</script>