@using System.Text.Json
@using WebFarmaciaMiguetti.Models

@{
    ViewData["Title"] = "Gesti√≥n de Cobros";
    // Datos del servidor
    var listaMandatarias = (ViewBag.Mandatarias as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var listaObrasSociales = (ViewBag.ObrasSociales as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var listaTiposPago = (ViewBag.TiposPago as List<string>) ?? new List<string> { "Transferencia", "Cheque", "Efectivo", "Dep√≥sito" };

    // Serializaci√≥n para JS
    var jsonObrasSociales = JsonSerializer.Serialize(listaObrasSociales.Select(x => new { id = x.IdObrasSociales, nombre = x.Nombre, idMandataria = x.IdMandataria }));
}

<style>
    /* =========================================
       ESTILOS DE ALTO IMPACTO (UX 85 A√ëOS)
       ========================================= */
    body { font-family: 'Verdana', sans-serif; background-color: #f4f6f9; color: #000; }
    
    h1 { font-size: 2.2rem; font-weight: 900; color: #146c43; text-transform: uppercase; border-bottom: 5px solid #146c43; display: inline-block; margin-bottom: 20px; }
    
    .form-control, .form-select { 
        border: 3px solid #6c757d; font-size: 1.1rem; padding: 12px; color: #000; font-weight: 700; 
    }
    
    .form-control:focus, .form-select:focus { 
        border-color: #198754; box-shadow: 0 0 0 0.25rem rgba(25,135,84, 0.25); background-color: #f0fff4; 
    }
    
    .form-label { font-weight: 900; font-size: 0.95rem; text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 0.5px; }
    
    /* Botones Gigantes */
    .btn-super { font-size: 1.1rem; font-weight: 800; padding: 12px 25px; border: 2px solid rgba(0,0,0,0.2); text-transform: uppercase; letter-spacing: 1px; }
    
    .table-container { border: 3px solid #000; border-radius: 4px; overflow: hidden; background: white; margin-top:15px; }
    .table thead th { background-color: #146c43; color: white; font-size: 1.1rem; vertical-align: middle; text-align: center; border-bottom: 3px solid #000; padding: 15px; }
    .table tbody td { font-size: 1.05rem; vertical-align: middle; font-weight: 600; padding: 12px; }

    /* --- BUSCADORES CORREGIDOS --- */
    .buscador-wrapper { position: relative; width: 100%; }
    
    .lista-sugerencias { 
        position: absolute; top: 100%; left: 0; width: 100%; 
        background: white; border: 4px solid #000; border-top: none; 
        z-index: 10000; /* Z-INDEX EXTREMO PARA ESTAR SOBRE MODALES */
        display: none; max-height: 300px; overflow-y: auto; 
        box-shadow: 0px 10px 20px rgba(0,0,0,0.4);
    }
    
    .item-sugerencia { 
        padding: 15px; cursor: pointer; border-bottom: 2px solid #ccc; 
        font-weight: 800; font-size: 1.1rem; color: #333;
    }
    
    .item-sugerencia:hover, .item-sugerencia.active { 
        background-color: #198754; color: white; border-color: #0f5132;
    }

    /* Totales */
    .total-display { font-size: 2rem; font-weight: 900; color: #198754; text-align: right; padding: 15px; background: #d1e7dd; border: 3px solid #198754; border-radius: 6px; }
    
    /* Colores Modales */
    .bg-header-add { background-color: #198754; color: white; border-bottom: 5px solid #0f5132; }
    .bg-header-view { background-color: #0d6efd; color: white; border-bottom: 5px solid #0a58ca; }
    .bg-header-edit { background-color: #ffc107; color: #000; border-bottom: 5px solid #000; }
    
    .loading-cell { display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: bold; color: #666; }
</style>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>üí∞ GESTI√ìN DE COBROS</h1>
        <button class="btn btn-success btn-lg btn-super shadow" onclick="abrirModalNuevo()">‚ûï NUEVO LOTE (CHEQUE/TRANSF)</button>
    </div>

    <div class="card mb-4 shadow-sm" style="border: 3px solid #6c757d; background-color: #e2e3e5;">
        <div class="card-body">
            <h4 class="mb-3 fw-bold">üîç BUSCAR LOTES ANTERIORES</h4>
            <div class="row g-3 align-items-end">
                <div class="col-md-2"><label class="form-label">Desde</label><input type="date" id="filtroDesde" class="form-control"></div>
                <div class="col-md-2"><label class="form-label">Hasta</label><input type="date" id="filtroHasta" class="form-control"></div>
                <div class="col-md-3">
                    <label class="form-label">Mandataria</label>
                    <select id="filtroMandataria" class="form-select">
                        <option value="0">-- TODAS --</option>
                        @foreach (var m in listaMandatarias) { <option value="@m.IdMandatarias">@m.RazonSocial</option> }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Obra Social (Filtro Global)</label>
                    <div class="buscador-wrapper">
                        <input type="text" id="txtFiltroOS" class="form-control" placeholder="Escriba obra social..." autocomplete="off">
                        <input type="hidden" id="filtroOS" value="0">
                        <div id="listaFiltroOS" class="lista-sugerencias"></div>
                    </div>
                </div>
                <div class="col-md-2 d-flex gap-2">
                    <button class="btn btn-primary btn-super w-100" onclick="buscarCobros()">BUSCAR</button>
                    <button class="btn btn-secondary btn-super" onclick="limpiarFiltros()">üîÑ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="table-container shadow">
        <table class="table table-striped table-hover mb-0">
            <thead>
                <tr>
                    <th>FECHA</th>
                    <th>MANDATARIA (ORIGEN)</th>
                    <th>COMPROBANTE</th>
                    <th>TIPO</th>
                    <th class="text-center">ITEMS</th>
                    <th class="text-end pe-4">TOTAL IMPORTE</th>
                    <th class="text-end pe-4">TOTAL NETO</th>
                    <th class="text-center">ACCIONES</th>
                </tr>
            </thead>
            <tbody id="tbodyResultados">
                <tr><td colspan="8" class="text-center p-4 text-muted fs-4">Cargando datos...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalNuevo" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-xl"> 
        <div class="modal-content border-0">
            <div class="modal-header bg-header-add py-3">
                <h3 class="modal-title fw-bold">üßæ REGISTRAR NUEVO INGRESO</h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-4">
                
                <div class="row g-3 mb-4 p-3 border border-3 border-success rounded bg-white shadow-sm position-relative">
                    <span class="position-absolute top-0 start-0 bg-success text-white px-3 fw-bold rounded-bottom-end">1. DATOS DE CABECERA</span>
                    <div class="col-12 mt-1"></div>
                    <div class="col-md-3"><label class="form-label">üìÖ FECHA</label><input type="date" id="n_Fecha" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")"></div>
                    <div class="col-md-4">
                        <label class="form-label">üè¢ MANDATARIA (PAGADOR)</label>
                        <select id="n_Mand" class="form-select fw-bold border-success" onchange="alCambiarMandatariaNuevo()">
                            <option value="0">-- SELECCIONE PRIMERO --</option>
                            @foreach (var m in listaMandatarias) { <option value="@m.IdMandatarias">@m.RazonSocial</option> }
                        </select>
                    </div>
                    <div class="col-md-3"><label class="form-label">üí≥ TIPO</label><select id="n_Tipo" class="form-select">@foreach(var t in listaTiposPago){<option value="@t">@t</option>}</select></div>
                    <div class="col-md-2"><label class="form-label">üìÑ N¬∞ COMP</label><input type="text" id="n_Comp" class="form-control" placeholder="Ej: 5544"></div>
                </div>

                <h5 class="fw-bold text-success mb-2">2. IMPUTAR DETALLES (OBRAS SOCIALES)</h5>
                <div class="card mb-3 border-2 border-secondary">
                    <div class="card-body bg-white">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-5">
                                <label class="form-label">OBRA SOCIAL</label>
                                <div class="buscador-wrapper">
                                    <input type="text" id="txtN_OS" class="form-control fw-bold" placeholder="Escriba para buscar..." autocomplete="off">
                                    <input type="hidden" id="valN_OS" value="0">
                                    <div id="listN_OS" class="lista-sugerencias"></div>
                                </div>
                            </div>
                            <div class="col-md-3"><label class="form-label text-success">IMPORTE</label><input type="number" id="n_Imp" class="form-control text-success fw-bold form-control-lg" placeholder="0.00" onkeypress="enterAdd(event)"></div>
                            <div class="col-md-2"><label class="form-label text-danger">D√âBITOS</label><input type="number" id="n_Deb" class="form-control text-danger fw-bold" value="0.00" onkeypress="enterAdd(event)"></div>
                            <div class="col-md-2"><button class="btn btn-success w-100 fw-bold py-2 btn-super" onclick="aggTemp()">‚¨áÔ∏è AGREGAR</button></div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive border border-2 border-dark rounded bg-white" style="height:250px; overflow-y:auto;">
                    <table class="table table-bordered mb-0">
                        <thead class="table-light sticky-top"><tr><th>OBRA SOCIAL</th><th class="text-end">IMPORTE</th><th class="text-end">D√âBITOS</th><th class="text-end">NETO</th><th class="text-center">X</th></tr></thead>
                        <tbody id="tbodyTemp"></tbody>
                    </table>
                </div>
                <div class="row mt-3 justify-content-end"><div class="col-md-6"><div class="total-display">TOTAL LOTE: <span id="lblTotalLote">$0.00</span></div></div></div>
            </div>
            <div class="modal-footer bg-light py-3">
                <button class="btn btn-secondary btn-lg btn-super me-auto" data-bs-dismiss="modal">CANCELAR</button>
                <button class="btn btn-success btn-lg btn-super px-5 shadow" onclick="guardarNuevoLote()">üíæ GUARDAR TODO</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVer" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-4 border-primary">
            <div class="modal-header bg-header-view">
                <h4 class="modal-title fw-bold">üëÅÔ∏è VER / GESTIONAR LOTE</h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-4">
                <div class="row mb-3 bg-white border p-3 rounded mx-1 shadow-sm">
                    <div class="col-md-6"><span class="text-muted small d-block">MANDATARIA:</span><h4 class="fw-bold text-primary m-0" id="v_Titulo">---</h4></div>
                    <div class="col-md-3"><span class="text-muted small d-block">COMPROBANTE:</span><h4 class="fw-bold m-0" id="v_Comp">---</h4></div>
                    <div class="col-md-3"><span class="text-muted small d-block">FECHA:</span><h4 class="fw-bold m-0" id="v_Fecha">---</h4></div>
                </div>
                
                <div class="card mb-3 border-2 border-primary">
                    <div class="card-header bg-primary text-white fw-bold py-2">‚ûï AGREGAR PAGO EXTRA A ESTE LOTE</div>
                    <div class="card-body py-2">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-5">
                                <label class="form-label small mb-1">OBRA SOCIAL</label>
                                <div class="buscador-wrapper">
                                    <input type="text" id="txtV_OS" class="form-control form-control-sm fw-bold" placeholder="Buscar..." autocomplete="off">
                                    <input type="hidden" id="valV_OS" value="0">
                                    <div id="listV_OS" class="lista-sugerencias"></div>
                                </div>
                            </div>
                            <div class="col-md-3"><label class="form-label small mb-1 text-success">IMPORTE</label><input type="number" id="v_Imp" class="form-control form-control-sm text-success fw-bold"></div>
                            <div class="col-md-2"><label class="form-label small mb-1 text-danger">D√âBITOS</label><input type="number" id="v_Deb" class="form-control form-control-sm text-danger fw-bold" value="0"></div>
                            <div class="col-md-2"><button class="btn btn-primary fw-bold w-100 py-2 btn-sm mt-3" onclick="agregarAlLote()">‚¨áÔ∏è AGREGAR</button></div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold text-primary m-0">DETALLES IMPUTADOS</h5>
                    <input type="text" id="buscadorInterno" class="form-control w-50" placeholder="üîç Filtrar en esta lista..." onkeyup="filtrarInterno()">
                </div>
                
                <div class="table-responsive border border-2 border-dark rounded bg-white" style="height: 300px; overflow-y: auto;">
                    <table class="table table-bordered table-striped mb-0">
                        <thead class="table-dark sticky-top"><tr><th>OBRA SOCIAL</th><th class="text-end">IMPORTE</th><th class="text-end">D√âBITOS</th><th class="text-end">NETO</th><th class="text-center">ACCIONES</th></tr></thead>
                        <tbody id="tbodyVer"></tbody>
                    </table>
                </div>
                
                <div class="row mt-3 justify-content-end">
                    <div class="col-md-6">
                        <div class="total-display">
                            TOTAL BRUTO: <span id="lblTotalBrutoVer" class="text-dark">$0.00</span><br>
                            TOTAL NETO: <span id="lblTotalNetoVer">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light"><button class="btn btn-secondary btn-lg fw-bold px-5" data-bs-dismiss="modal">CERRAR</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEdit" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-warning">
            <div class="modal-header bg-header-edit"><h4 class="modal-title fw-bold">‚úèÔ∏è CORREGIR DATOS (CABECERA)</h4><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body bg-white p-4">
                <div class="alert alert-warning fw-bold">‚ö†Ô∏è Si cambia estos datos, se actualizar√°n en TODOS los pagos de este lote.</div>
                <input type="hidden" id="e_IdCobroRef">
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">Mandataria</label><select id="e_Mandataria" class="form-select">@foreach (var m in listaMandatarias) { <option value="@m.IdMandatarias">@m.RazonSocial</option> }</select></div>
                    <div class="col-md-6"><label class="form-label">Resumen Items</label><input type="text" id="e_NombreOS" class="form-control" readonly disabled></div>
                    <div class="col-md-4"><label class="form-label">Fecha</label><input type="date" id="e_Fecha" class="form-control"></div>
                    <div class="col-md-4"><label class="form-label">Comprobante</label><input type="text" id="e_Comp" class="form-control"></div>
                    <div class="col-md-4"><label class="form-label">Tipo Pago</label><select id="e_Tipo" class="form-select">@foreach(var t in listaTiposPago){<option value="@t">@t</option>}</select></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-warning fw-bold px-4" onclick="guardarEdicionLote()">APLICAR A TODO EL LOTE</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditDetalle" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog">
        <div class="modal-content border-warning">
            <div class="modal-header bg-warning py-2"><h5 class="modal-title fw-bold">EDITAR PAGO INDIVIDUAL</h5><button type="button" class="btn-close" onclick="cerrarEditDetalle()"></button></div>
            <div class="modal-body p-3">
                <input type="hidden" id="ed_Id">
                <label class="form-label">Obra Social</label>
                <div class="buscador-wrapper mb-2">
                    <input type="text" id="txtED_OS" class="form-control fw-bold" autocomplete="off">
                    <input type="hidden" id="valED_OS">
                    <div id="listED_OS" class="lista-sugerencias"></div>
                </div>
                <label class="form-label">Importe</label><input type="number" id="ed_Imp" class="form-control fw-bold text-success mb-2">
                <label class="form-label">D√©bitos</label><input type="number" id="ed_Deb" class="form-control fw-bold text-danger">
            </div>
            <div class="modal-footer py-2"><button class="btn btn-warning fw-bold w-100 btn-super" onclick="guardarEditDetalle()">üíæ GUARDAR CAMBIO</button></div>
        </div>
    </div>
</div>

<script>
    // == VARIABLES GLOBALES ==
    // NOTA: datosOS contiene el idMandataria de cada OS
    var datosOS = @Html.Raw(jsonObrasSociales);
    var itemsTemp = []; // Para Modal Nuevo
    var datosAgrupados = {}; // Cache de Grupos (Lotes)
    var loteContexto = {}; // Datos del lote actual en "Ver"
    
    // Instancias de Modales
    var mVer, mNuevo, mEdit, mEditDetalle;

    document.addEventListener("DOMContentLoaded", () => {
        // Inicializar Bootstrap Modals
        mVer = new bootstrap.Modal(document.getElementById('modalVer'));
        mNuevo = new bootstrap.Modal(document.getElementById('modalNuevo'));
        mEdit = new bootstrap.Modal(document.getElementById('modalEdit'));
        mEditDetalle = new bootstrap.Modal(document.getElementById('modalEditDetalle'));

        // 1. Inicializar Buscador Principal (Todas las OS)
        setupAuto('txtFiltroOS', 'listaFiltroOS', 'filtroOS', datosOS);
        
        // 2. Inicializar Buscador de Edici√≥n Individual (Todas las OS)
        setupAuto('txtED_OS', 'listED_OS', 'valED_OS', datosOS);
        
        // 3. Inicializar Buscador "Nuevo Lote" (Al inicio vac√≠o o todas, pero se actualiza luego)
        setupAuto('txtN_OS', 'listN_OS', 'valN_OS', datosOS);

        // 4. Carga inicial de datos
        buscarCobros(); 
    });

    // =================================================================
    // MOTOR DE AUTOCOMPLETADO
    // =================================================================
    function setupAuto(inpId, listId, hidId, fuenteDatos) {
        const inp = document.getElementById(inpId);
        const list = document.getElementById(listId);
        const hid = document.getElementById(hidId);
        
        inp.oninput = function() {
            const texto = this.value.toLowerCase();
            list.innerHTML = '';
            
            if (texto.length < 1) { 
                list.style.display = 'none'; 
                hid.value = "0"; 
                return; 
            }

            const filtrados = fuenteDatos.filter(x => x.nombre.toLowerCase().includes(texto));

            if (filtrados.length === 0) {
                list.innerHTML = '<div class="item-sugerencia text-muted">üö´ NO EXISTE</div>';
                list.style.display = 'block';
                return;
            }

            filtrados.forEach(x => {
                const item = document.createElement('div');
                item.className = 'item-sugerencia';
                item.textContent = x.nombre;
                
                item.onclick = function() {
                    inp.value = x.nombre;
                    hid.value = x.id;
                    list.style.display = 'none';
                    if (inpId === 'txtN_OS') document.getElementById('n_Imp').focus();
                    if (inpId === 'txtV_OS') document.getElementById('v_Imp').focus();
                };
                
                list.appendChild(item);
            });
            
            list.style.display = 'block';
        };

        inp.onblur = function() {
            setTimeout(() => { 
                list.style.display = 'none';
                if (hid.value == "0" && inp.value.trim() !== "") {
                    inp.value = ""; 
                }
            }, 300);
        };
    }

    function alCambiarMandatariaNuevo() {
        const idMand = parseInt(document.getElementById('n_Mand').value) || 0;
        let datosFiltrados = datosOS;

        if (idMand > 0) {
            datosFiltrados = datosOS.filter(x => x.idMandataria == idMand);
        }

        document.getElementById('txtN_OS').value = '';
        document.getElementById('valN_OS').value = '0';
        setupAuto('txtN_OS', 'listN_OS', 'valN_OS', datosFiltrados);
    }

    // =================================================================
    // L√ìGICA DE NEGOCIO (B√öSQUEDA Y GRILLA)
    // =================================================================
    async function buscarCobros() {
        const tbody = document.getElementById('tbodyResultados');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4"><div class="spinner-border text-success"></div> Procesando datos...</td></tr>';

        const filtroMandataria = document.getElementById('filtroMandataria').value;
        const filtroOS = document.getElementById('filtroOS').value;
        const filtroDesde = document.getElementById('filtroDesde').value;
        const filtroHasta = document.getElementById('filtroHasta').value;

        let url = `@Url.Action("BuscarCobrosAjax", "Home")?dummy=1` +
            `&IdMandataria=${filtroMandataria}` +
            `&IdObraSocial=${filtroOS}` +
            `&desde=${filtroDesde}` +
            `&hasta=${filtroHasta}`;
        
        try {
            const r = await fetch(url);
            if (!r.ok) throw new Error(`Error servidor: ${r.status}`);
            const res = await r.json();

            if(res.success && res.data.length > 0) {
                datosAgrupados = {}; 
                
                res.data.forEach(x => {
                    const comp = (x.NumeroComprobante||x.numeroComprobante||'S/N').trim();
                    const idMand = x.IdMandatarias||x.idMandatarias||0; 
                    const fecha = (x.FechaCobro||x.fechaCobro).split('T')[0];
                    const tipo = x.TipoPago||x.tipoPago||'-';
                    
                    const key = comp + '_' + fecha + '_' + tipo;
                    
                    if(!datosAgrupados[key]) {
                        datosAgrupados[key] = {
                            key: key, comp: comp, fecha: fecha,
                            mand: x.NombreMandataria||x.nombreMandataria||'---',
                            idMand: idMand, tipo: tipo, items: [], 
                            totalImp: 0, totalDeb: 0
                        };
                    }
                    
                    datosAgrupados[key].items.push(x);
                    datosAgrupados[key].totalImp += parseFloat(x.ImporteCobrado||x.importeCobrado||0);
                    datosAgrupados[key].totalDeb += parseFloat(x.MontoDebitos||x.montoDebitos||0);
                });

                tbody.innerHTML = '';
                Object.values(datosAgrupados).forEach(g => {
                    const neto = g.totalImp - g.totalDeb;
                    const cantPagos = g.items.length;
                    
                    tbody.innerHTML += `
                    <tr data-key="${g.key}">
                        <td class="text-center">${g.fecha}</td>
                        <td class="fw-bold text-primary">${g.mand}</td>
                        <td class="fw-bold text-center">${g.comp}</td>
                        <td>${g.tipo}</td>
                        <td class="text-center fw-bold fs-5">${cantPagos}</td>
                        <td class="text-end fw-bold fs-5 text-dark">$${g.totalImp.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                        <td class="text-end fw-black fs-5 text-success border-start border-end bg-light">$${neto.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                        <td class="text-center" id="actions-${g.key}">
                            <button class="btn btn-danger btn-sm me-1 btn-super p-2" onclick="eliminarLoteCompleto('${g.key}')" title="Eliminar Todo">üóëÔ∏è</button>
                            <button class="btn btn-warning btn-sm me-1 btn-super p-2" onclick="abrirEditarLote('${g.key}')" title="Editar Cabecera">‚úèÔ∏è</button>
                            <button class="btn btn-primary btn-sm fw-bold px-3 btn-super" onclick="abrirVer('${g.key}')">üëÅÔ∏è VER</button>
                        </td>
                    </tr>`;
                });
            } else { 
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 fs-4 text-secondary">No se encontraron cobros con estos filtros.</td></tr>';
            }
        } catch(e) { 
            console.error(e);
            tbody.innerHTML = `<tr><td colspan="8" class="text-danger text-center p-4">‚ö†Ô∏è Error de conexi√≥n: ${e.message}</td></tr>`;
        }
    }

    function limpiarFiltros() { 
        document.getElementById('filtroMandataria').value = 0;
        document.getElementById('txtFiltroOS').value = ""; 
        document.getElementById('filtroOS').value = 0;
        document.getElementById('filtroDesde').value = ""; 
        document.getElementById('filtroHasta').value = "";
        buscarCobros(); 
    }

    // =================================================================
    // MODAL NUEVO LOTE (USA MODELO Cobros.cs -> PLURAL)
    // =================================================================
    function abrirModalNuevo() { 
        itemsTemp = [];
        document.getElementById('tbodyTemp').innerHTML=''; 
        document.getElementById('n_Comp').value=""; 
        document.getElementById('lblTotalLote').textContent="$0.00";
        document.getElementById('n_Fecha').value = new Date().toISOString().substring(0, 10);
        document.getElementById('n_Mand').value = "0";
        alCambiarMandatariaNuevo();
        mNuevo.show();
    }
    
    function enterAdd(e) { if(e.key==='Enter') aggTemp(); }
    
    function aggTemp() {
        const id = document.getElementById('valN_OS').value;
        const nom = document.getElementById('txtN_OS').value;
        const imp = parseFloat(document.getElementById('n_Imp').value)||0;
        const deb = parseFloat(document.getElementById('n_Deb').value)||0;

        if(id==0 || imp==0) { alert("‚ö†Ô∏è Debe seleccionar Obra Social e ingresar Importe."); return; }
        
        itemsTemp.push({id:id, nom:nom, imp:imp, deb:deb});
        dibujarTemp();
        
        document.getElementById('n_Imp').value=""; 
        document.getElementById('n_Deb').value="0.00";
        document.getElementById('txtN_OS').value=""; 
        document.getElementById('valN_OS').value="0";
        document.getElementById('txtN_OS').focus();
    }
    
    function dibujarTemp() {
        const b = document.getElementById('tbodyTemp');
        b.innerHTML='';
        let tot = 0;
        itemsTemp.forEach((x,i) => {
            const neto = (x.imp - x.deb);
            tot += neto;
            b.innerHTML+=`
            <tr data-index="${i}">
                <td class="fw-bold">${x.nom}</td>
                <td class="text-end text-success">$${x.imp.toFixed(2)}</td>
                <td class="text-end text-danger">$${x.deb.toFixed(2)}</td>
                <td class="text-end fw-bold">$${neto.toFixed(2)}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-danger fw-bold" onclick="itemsTemp.splice(${i},1);dibujarTemp()">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
        document.getElementById('lblTotalLote').textContent = `$${tot.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
    }

    async function guardarNuevoLote() {
        const mandId = document.getElementById('n_Mand').value;
        const comp = document.getElementById('n_Comp').value.trim();
        const fecha = document.getElementById('n_Fecha').value;
        const tipo = document.getElementById('n_Tipo').value;

        if(mandId=="0" || comp=="" || itemsTemp.length==0) { 
            alert("‚ö†Ô∏è Faltan datos: Seleccione Mandataria, escriba N¬∞ Comprobante y agregue items."); return; 
        }
        
        if(!confirm("¬øConfirmar el guardado de este lote?")) return;

        const originalFooter = document.querySelector('#modalNuevo .modal-footer').innerHTML;
        document.querySelector('#modalNuevo .modal-footer').innerHTML = '<span class="text-success fw-bold me-3">GUARDANDO...</span> <div class="spinner-border text-success"></div>';

        // CORRECCI√ìN: JSON respeta el modelo Cobros.cs (PLURAL) y env√≠a n√∫meros reales
        const loteFinal = itemsTemp.map(x => ({
            IdCobros: 0, 
            
            // TU MODELO Cobros.cs USA "IdObrasSociales" (PLURAL)
            IdObrasSociales: parseInt(x.id), 
            
            FechaCobro: fecha,
            NumeroComprobante: comp,
            TipoPago: tipo,
            ImporteCobrado: x.imp, // N√∫mero puro (100.50), NO string ("100,50")
            MontoDebitos: x.deb,
            MotivoDebito: ""
        }));

        try {
            const r = await fetch('@Url.Action("GuardarLoteCobros", "Home")', { 
                method:'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(loteFinal)
            });
            const res = await r.json();
            
            if(res.success) {
                alert(res.message);
                mNuevo.hide(); 
                buscarCobros();
            } else {
                alert("‚ùå Error: " + res.message);
            }
        } catch (e) {
            alert("‚ùå Error de red: " + e.message);
        } finally {
            document.querySelector('#modalNuevo .modal-footer').innerHTML = originalFooter;
        }
    }

    // =================================================================
    // MODAL VER DETALLES (BLINDADO CON DOBLE ID Y REPLACE DECIMAL)
    // =================================================================
    function abrirVer(key) {
        const g = datosAgrupados[key];
        if(!g) return;
        
        loteContexto = { 
            fecha: g.fecha, comp: g.comp, tipo: g.tipo, 
            mandKey: key, mandatariaId: g.idMand 
        };

        document.getElementById('v_Titulo').textContent = g.mand;
        document.getElementById('v_Comp').textContent = g.comp;
        document.getElementById('v_Fecha').textContent = g.fecha;

        document.getElementById('buscadorInterno').value = '';
        
        const osDeEstaMandataria = datosOS.filter(x => x.idMandataria == g.idMand);
        setupAuto('txtV_OS', 'listV_OS', 'valV_OS', osDeEstaMandataria);
        
        traerDetallesYLlenarVer(g.comp);
        mVer.show();
    }

    async function traerDetallesYLlenarVer(comprobante) {
        document.getElementById('tbodyVer').innerHTML = '<tr><td colspan="5" class="text-center p-4"><div class="spinner-border spinner-border-sm text-primary"></div> Cargando...</td></tr>';
        
        try {
            const r = await fetch(`@Url.Action("TraerCobrosPorComprobante", "Home")?comprobante=${comprobante}`);
            const res = await r.json();
            if (res.success) dibujarTablaVer(res.data);
            else alert(res.message);
        } catch (e) { console.error(e); }
    }

    function dibujarTablaVer(items) {
        const b = document.getElementById('tbodyVer');
        b.innerHTML='';
        let totalImp = 0, totalDeb = 0;
        
        if (items.length === 0) b.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Vac√≠o</td></tr>';

        items.forEach(x => {
            const nomOS = x.NombreObraSocial || x.nombreObraSocial || datosOS.find(o=>o.id == (x.IdObrasSociales||x.idObrasSociales))?.nombre || "---";
            const imp = parseFloat(x.ImporteCobrado||x.importeCobrado||0);
            const deb = parseFloat(x.MontoDebitos||x.montoDebitos||0);
            const id = x.IdCobros||x.idCobros;
            
            totalImp += imp;
            totalDeb += deb;

            b.innerHTML += `
            <tr data-id="${id}" class="detalle-cobro-row">
                <td class="fw-bold">${nomOS}</td>
                <td class="text-end text-success">$${imp.toFixed(2)}</td>
                <td class="text-end text-danger">$${deb.toFixed(2)}</td>
                <td class="text-end fw-black">$${(imp-deb).toFixed(2)}</td>
                <td class="text-center">
                    <button class="btn btn-warning btn-sm me-1 fw-bold" onclick="abrirEditDetalle(${id})">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-danger fw-bold" onclick="eliminarDelLote(${id})">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
        
        document.getElementById('lblTotalBrutoVer').textContent = `$${totalImp.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
        document.getElementById('lblTotalNetoVer').textContent = `$${(totalImp - totalDeb).toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
    }

    async function agregarAlLote() {
        const idOS = document.getElementById('valV_OS').value;
        let impStr = document.getElementById('v_Imp').value; 
        let debStr = document.getElementById('v_Deb').value || "0";
        
        if(idOS==0 || !impStr || parseFloat(impStr)==0) { alert("‚ö†Ô∏è Seleccione OS e ingrese importe."); return; }

        // Normalizar decimales a punto (10.50)
        impStr = impStr.replace(',','.');
        debStr = debStr.replace(',','.');

        const fd = new FormData();
        fd.append("IdCobro", 0);
        
        // ESTRATEGIA DE SEGURIDAD: Env√≠o AMBOS por si el controlador espera Singular o Plural en los params
        fd.append("IdObraSocial", idOS);      // Singular
        fd.append("IdObrasSociales", idOS);   // Plural
        
        fd.append("FechaCobro", loteContexto.fecha);
        fd.append("NumeroComprobante", loteContexto.comp);
        fd.append("TipoPago", loteContexto.tipo);
        fd.append("ImporteCobrado", impStr); 
        fd.append("MontoDebitos", debStr);
        fd.append("MotivoDebito", "");

        try {
            const r = await fetch('@Url.Action("GuardarCobro", "Home")', { method:'POST', body:fd });
            const res = await r.json();
            if(res.success) {
                document.getElementById('v_Imp').value=""; document.getElementById('v_Deb').value="0";
                document.getElementById('txtV_OS').value=""; document.getElementById('valV_OS').value="0";
                buscarCobros(); 
                traerDetallesYLlenarVer(loteContexto.comp);
            } else {
                alert("Error: " + res.message);
            }
        } catch(e) { alert("Error de red."); }
    }

    function filtrarInterno() {
        const t = document.getElementById('buscadorInterno').value.toLowerCase();
        document.querySelectorAll('#tbodyVer tr.detalle-cobro-row').forEach(r => {
            const texto = r.innerText.toLowerCase();
            r.style.display = texto.includes(t) ? '' : 'none';
        });
    }

    // =================================================================
    // EDICI√ìN Y ELIMINACI√ìN
    // =================================================================
    async function eliminarLoteCompleto(key) {
        const g = datosAgrupados[key];
        if(!g) return;
        if(!confirm(`‚ö†Ô∏è PELIGRO: ¬øEliminar TODO el lote ${g.comp} de ${g.mand}?\nSe borrar√°n ${g.items.length} pagos.`)) return;
        
        const actionCell = document.getElementById(`actions-${key}`);
        actionCell.innerHTML = '<div class="spinner-border text-danger"></div>';
        
        let errores = 0;
        for(const item of g.items) {
            const fd=new FormData(); fd.append("idCobro", item.IdCobros||item.idCobros);
            try { await fetch('@Url.Action("EliminarCobro", "Home")', {method:'POST', body:fd}); } 
            catch { errores++; }
        }
        
        if(errores>0) alert(`Se complet√≥ con ${errores} errores.`);
        else alert("‚úÖ Lote eliminado.");
        
        buscarCobros();
    }

    async function eliminarDelLote(id) {
        if(!confirm("¬øEliminar este pago individual?")) return;
        const fd=new FormData(); fd.append("idCobro", id);
        try {
            await fetch('@Url.Action("EliminarCobro", "Home")', {method:'POST', body:fd});
            buscarCobros();
            traerDetallesYLlenarVer(loteContexto.comp);
        } catch(e) { alert("Error al eliminar."); }
    }

    function abrirEditarLote(key) {
        const g = datosAgrupados[key];
        document.getElementById('e_IdCobroRef').value = key; 
        document.getElementById('e_Mandataria').value = g.idMand;
        document.getElementById('e_NombreOS').value = `Varios (${g.items.length} items)`;
        document.getElementById('e_Fecha').value = g.fecha;
        document.getElementById('e_Comp').value = g.comp;
        document.getElementById('e_Tipo').value = g.tipo;
        mEdit.show();
    }

    async function guardarEdicionLote() {
        if(!confirm("¬øAplicar cambios a TODO el lote?")) return;
        const key = document.getElementById('e_IdCobroRef').value;
        const g = datosAgrupados[key];
        const nuevaFecha = document.getElementById('e_Fecha').value;
        const nuevoComp = document.getElementById('e_Comp').value;
        const nuevoTipo = document.getElementById('e_Tipo').value;

        document.querySelector('#modalEdit .modal-footer').innerHTML = 'Guardando...';

        for(const item of g.items) {
            const fd = new FormData();
            fd.append("IdCobro", item.IdCobros||item.idCobros);
            
            // Env√≠o DOBLE de ID para asegurar compatibilidad
            const idOS = item.IdObrasSociales||item.idObrasSociales;
            fd.append("IdObraSocial", idOS);
            fd.append("IdObrasSociales", idOS);
            
            fd.append("FechaCobro", nuevaFecha);
            fd.append("NumeroComprobante", nuevoComp);
            fd.append("TipoPago", nuevoTipo);
            
            const impStr = (item.ImporteCobrado||item.importeCobrado).toString().replace(',','.');
            const debStr = (item.MontoDebitos||item.montoDebitos).toString().replace(',','.');
            
            fd.append("ImporteCobrado", impStr);
            fd.append("MontoDebitos", debStr);
            
            await fetch('@Url.Action("GuardarCobro", "Home")', { method:'POST', body:fd });
        }
        
        mEdit.hide();
        document.querySelector('#modalEdit .modal-footer').innerHTML = '<button class="btn btn-warning fw-bold px-4" onclick="guardarEdicionLote()">APLICAR A TODO EL LOTE</button>';
        buscarCobros();
        alert("‚úÖ Lote actualizado.");
    }

    async function abrirEditDetalle(id) {
        const r = await fetch(`@Url.Action("ObtenerCobroPorId", "Home")?idCobro=${id}`);
        const res = await r.json();
        if(!res.success) return;
        
        const d = res.data;
        document.getElementById('ed_Id').value = id;
        document.getElementById('valED_OS').value = d.IdObrasSociales||d.idObrasSociales;
        
        const nombreOS = datosOS.find(x=>x.id == (d.IdObrasSociales||d.idObrasSociales))?.nombre || "---";
        document.getElementById('txtED_OS').value = nombreOS;
        
        document.getElementById('ed_Imp').value = d.ImporteCobrado||d.importeCobrado;
        document.getElementById('ed_Deb').value = d.MontoDebitos||d.montoDebitos;
        
        document.getElementById('ed_Id').dataset.full = JSON.stringify(d);
        mEditDetalle.show();
    }

    function cerrarEditDetalle() { mEditDetalle.hide(); }

    async function guardarEditDetalle() {
        const id = document.getElementById('ed_Id').value;
        const d = JSON.parse(document.getElementById('ed_Id').dataset.full);
        
        let impStr = document.getElementById('ed_Imp').value.replace(',','.');
        let debStr = document.getElementById('ed_Deb').value.replace(',','.');

        const fd = new FormData();
        fd.append("IdCobro", id);
        
        // Env√≠o DOBLE de ID
        const idOS = document.getElementById('valED_OS').value;
        fd.append("IdObraSocial", idOS);
        fd.append("IdObrasSociales", idOS);
        
        fd.append("FechaCobro", (d.FechaCobro||d.fechaCobro).split('T')[0]); 
        fd.append("NumeroComprobante", d.NumeroComprobante||d.numeroComprobante); 
        fd.append("TipoPago", d.TipoPago||d.tipoPago);
        fd.append("ImporteCobrado", impStr);
        fd.append("MontoDebitos", debStr);

        try {
            const r = await fetch('@Url.Action("GuardarCobro", "Home")', { method:'POST', body:fd });
            const res = await r.json();
            if(res.success) {
                mEditDetalle.hide();
                buscarCobros();
                traerDetallesYLlenarVer(loteContexto.comp);
                alert("‚úÖ Actualizado.");
            } else alert("Error: " + res.message);
        } catch(e) { alert("Error de red"); }
    }
</script>