@using WebFarmaciaMiguetti.Models

@{
    ViewData["Title"] = "Gesti√≥n de Cobros";
    var listaMandatarias = (ViewBag.Mandatarias as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var listaTiposPago = (ViewBag.TiposPago as List<string>) ?? new List<string> { "Transferencia", "Cheque", "Efectivo", "Dep√≥sito" };
}

<style>
    body { font-family: 'Verdana', sans-serif; background-color: #f0f7f4; color: #000; }
    h1 { font-size: 2.5rem; font-weight: 900; color: #146c43; margin-bottom: 20px; text-transform: uppercase; border-bottom: 4px solid #146c43; display: inline-block; }
    
    .form-control, .form-select { border: 3px solid #6c757d; font-size: 1.1rem; padding: 10px; color: #000; font-weight: 500; }
    .form-control:focus, .form-select:focus { border-color: #198754; box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25); background-color: #e8f5e9; }
    .form-label { font-weight: 900; font-size: 1rem; text-transform: uppercase; color: #333; }
    .btn-super { font-size: 1.1rem; font-weight: 800; padding: 10px 20px; border: 3px solid rgba(0,0,0,0.2); text-transform: uppercase; }
    
    .table-bordered { border: 2px solid #000; }
    .table thead th { background-color: #146c43; color: white; font-size: 1.1rem; vertical-align: middle; }
    .table tbody td { font-size: 1.1rem; vertical-align: middle; font-weight: 500; }
    
    .card-resumen { background-color: #d1e7dd; border: 3px solid #198754; border-radius: 10px; padding: 15px; }
    .total-final { font-size: 2rem; font-weight: 900; color: #198754; text-align: center; }
</style>

<div class="container-fluid mt-4">
    <h1>üí∞ GESTI√ìN DE COBROS</h1>

    <div class="card mb-4" style="border: 3px solid #6c757d; background-color: #e9ecef;">
        <div class="card-body">
            <h4 class="mb-3 fw-bold text-dark">üîç BUSCAR POR MANDATARIA / OS</h4>
            <div class="row g-3">
                
                <div class="col-md-3">
                    <label class="form-label">1. Mandataria</label>
                    <input class="form-control" list="dlFiltroMandataria" id="txtFiltroMandataria" placeholder="Escriba para buscar..." onchange="seleccionarMandatariaFiltro()">
                    <datalist id="dlFiltroMandataria">
                        @foreach (var m in listaMandatarias)
                        {
                            <option data-id="@m.IdMandatarias" value="@m.RazonSocial"></option>
                        }
                    </datalist>
                    <input type="hidden" id="filtroMandataria" value="0">
                </div>

                <div class="col-md-3">
                    <label class="form-label">2. Obra Social</label>
                    <input class="form-control" list="dlFiltroOS" id="txtFiltroOS" placeholder="Primero Mandataria..." disabled onchange="seleccionarOSFiltro()">
                    <datalist id="dlFiltroOS">
                        </datalist>
                    <input type="hidden" id="filtroOS" value="0">
                </div>
                
                <div class="col-md-2">
                    <label class="form-label">Fecha Desde</label>
                    <input type="date" id="filtroFechaDesde" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Fecha Hasta</label>
                    <input type="date" id="filtroFechaHasta" class="form-control">
                </div>

                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button class="btn btn-success btn-super w-100" onclick="buscarCobros()">üîç BUSCAR</button>
                    <button class="btn btn-secondary btn-super" onclick="limpiarFiltros()" title="Borrar filtros">üîÑ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card" style="border: 3px solid #000;">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center p-3">
            <h3 class="m-0 fw-bold">üìã LISTADO DE INGRESOS</h3>
            <button class="btn btn-success btn-super text-white border-white" onclick="abrirModalCobro(0)">
                ‚ûï NUEVO COBRO
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="tablaCobros">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>MANDATARIA / OS</th>
                            <th>COMPROBANTE</th>
                            <th>TIPO</th>
                            <th class="text-end">IMPORTE ($)</th>
                            <th class="text-end">D√âBITOS ($)</th>
                            <th class="text-end">NETO ($)</th>
                            <th class="text-center">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyCobros">
                        <tr><td colspan="8" class="text-center p-4 text-muted fs-4">Utilice los filtros para buscar...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCobro" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-lg"> 
        <div class="modal-content border-4 border-success">
            <div class="modal-header bg-success text-white">
                <h3 class="modal-title fw-bold" id="tituloModal">REGISTRAR COBRO</h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-white">
                <input type="hidden" id="cobroId" value="0">
                
                <div class="row g-3 mb-3 p-3 bg-light border border-2 rounded">
                    <div class="col-md-6">
                        <label class="form-label">1. MANDATARIA</label>
                        <input class="form-control fw-bold" list="dlCobroMandataria" id="txtCobroMandataria" placeholder="Escriba para buscar..." onchange="seleccionarMandatariaModal()">
                        <datalist id="dlCobroMandataria">
                            @foreach (var m in listaMandatarias)
                            {
                                <option data-id="@m.IdMandatarias" value="@m.RazonSocial"></option>
                            }
                        </datalist>
                        <input type="hidden" id="cobroMandataria" value="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">2. OBRA SOCIAL PAGADORA</label>
                        <input class="form-control fw-bold" list="dlCobroOS" id="txtCobroOS" placeholder="Primero Mandataria..." disabled onchange="seleccionarOSModal()">
                        <datalist id="dlCobroOS">
                            </datalist>
                        <input type="hidden" id="cobroOS" value="0">
                    </div>
                </div>

                <div class="card mb-3 p-3 bg-white border-2">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">FECHA</label>
                            <input type="date" id="cobroFecha" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">FORMA PAGO</label>
                            <select id="cobroTipo" class="form-select">
                                @foreach(var tipo in listaTiposPago) { <option value="@tipo">@tipo</option> }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">N¬∞ COMPROBANTE</label>
                            <input type="text" id="cobroComprobante" class="form-control" placeholder="Ej: 998877">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label text-primary">üíµ IMPORTE (BRUTO)</label>
                            <input type="number" id="cobroImporte" class="form-control fw-bold fs-4 text-primary" step="0.01" value="0.00" oninput="calcularTotalNeto()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-danger">üìâ D√âBITOS</label>
                            <input type="number" id="cobroDebitos" class="form-control fw-bold fs-4 text-danger" step="0.01" value="0.00" oninput="calcularTotalNeto()">
                        </div>
                        <div class="col-12">
                            <input type="text" id="cobroMotivoDebito" class="form-control form-control-sm" placeholder="Motivo del d√©bito (Opcional)...">
                        </div>
                    </div>
                </div>

                <div class="card-resumen">
                    <div class="row align-items-center">
                        <div class="col-6 text-end fw-bold fs-5">NETO PERCIBIDO:</div>
                        <div class="col-6"><div class="total-final" id="lblTotalNeto">$0.00</div></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary btn-lg fw-bold" data-bs-dismiss="modal">CANCELAR</button>
                <button type="button" class="btn btn-success btn-lg fw-bold px-5" onclick="guardarCobro()">üíæ GUARDAR</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const modalCobro = new bootstrap.Modal(document.getElementById('modalCobro'));

    document.addEventListener("DOMContentLoaded", () => {
        buscarCobros();
    });

    // =========================================================================
    // 1. UTILIDADES DE AUTOCOMPLETADO
    // =========================================================================
    function obtenerIdDeDatalist(inputId, datalistId) {
        const val = document.getElementById(inputId).value;
        const options = document.getElementById(datalistId).options;
        for(let i=0; i<options.length; i++) {
            if(options[i].value === val) return options[i].getAttribute('data-id');
        }
        return "0";
    }

    function seleccionarMandatariaFiltro() {
        const id = obtenerIdDeDatalist('txtFiltroMandataria', 'dlFiltroMandataria');
        document.getElementById('filtroMandataria').value = id;
        cargarOS(id, 'dlFiltroOS', 'txtFiltroOS'); 
    }

    function seleccionarOSFiltro() {
        const id = obtenerIdDeDatalist('txtFiltroOS', 'dlFiltroOS');
        document.getElementById('filtroOS').value = id;
    }

    function seleccionarMandatariaModal() {
        const id = obtenerIdDeDatalist('txtCobroMandataria', 'dlCobroMandataria');
        document.getElementById('cobroMandataria').value = id;
        document.getElementById('txtCobroOS').value = "";
        document.getElementById('cobroOS').value = "0";
        cargarOS(id, 'dlCobroOS', 'txtCobroOS');
    }

    function seleccionarOSModal() {
        const id = obtenerIdDeDatalist('txtCobroOS', 'dlCobroOS');
        document.getElementById('cobroOS').value = id;
    }

    // =========================================================================
    // 2. CARGA DE DATOS (AJAX)
    // =========================================================================
    async function cargarOS(idMandataria, idDatalist, idInputVisible) {
        const datalist = document.getElementById(idDatalist);
        const input = document.getElementById(idInputVisible);
        
        datalist.innerHTML = ''; 
        input.disabled = true;
        input.placeholder = "Cargando...";

        if(idMandataria == "0") {
            input.placeholder = "Primero Mandataria...";
            return;
        }

        try {
            const r = await fetch(`@Url.Action("TraerObrasSocialesPorMandataria", "Home")?idMandataria=${idMandataria}`);
            const res = await r.json();
            
            if(res.success && res.data.length > 0) {
                res.data.forEach(os => {
                    const id = os.idObrasSociales || os.IdObrasSociales;
                    const nombre = os.nombre || os.Nombre;
                    const opt = document.createElement('option');
                    opt.value = nombre; 
                    opt.setAttribute('data-id', id); 
                    datalist.appendChild(opt);
                });
                input.disabled = false;
                input.placeholder = "Escriba para buscar...";
            } else {
                input.placeholder = "Sin Obras Sociales";
            }
        } catch(e) {
            console.error(e);
            alert("Error al cargar Obras Sociales.");
        }
    }

    function calcularTotalNeto() {
        const imp = parseFloat(document.getElementById('cobroImporte').value) || 0;
        const deb = parseFloat(document.getElementById('cobroDebitos').value) || 0;
        document.getElementById('lblTotalNeto').textContent = `$${(imp - deb).toFixed(2)}`;
    }

    // =========================================================================
    // 3. CRUD PRINCIPAL (BUSCAR, GUARDAR, ELIMINAR)
    // =========================================================================

    async function buscarCobros() {
        const mand = document.getElementById('filtroMandataria').value;
        const os = document.getElementById('filtroOS').value;
        // Si no se us√≥ el buscador predictivo, el value podr√≠a ser 0, intentamos buscar texto libre si quisieras (opcional)
        // Por ahora mantenemos l√≥gica estricta de ID.
        
        const comp = document.getElementById('filtroComprobante')?.value || ""; // Protecci√≥n null
        const d = document.getElementById('filtroFechaDesde').value;
        const h = document.getElementById('filtroFechaHasta').value;
        
        const tbody = document.getElementById('tbodyCobros');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4"><div class="spinner-border text-success"></div> Buscando...</td></tr>';

        const url = `@Url.Action("BuscarCobrosAjax", "Home")?IdMandataria=${mand}&IdObraSocial=${os}&numeroComprobante=${comp}&desde=${d}&hasta=${h}`;

        try {
            const r = await fetch(url);
            const res = await r.json();
            
            if(res.success && res.data.length > 0) {
                tbody.innerHTML = '';
                res.data.forEach(c => {
                    const fecha = new Date(c.fechaCobro || c.FechaCobro).toLocaleDateString('es-AR');
                    const nombreOS = c.nombreObraSocial || c.NombreObraSocial || "---"; 
                    const precio = c.precio || c.Precio || 0;
                    const debitos = c.montoDebitos || c.MontoDebitos || 0;
                    const idCobro = c.idCobros || c.IdCobros;
                    const comp = c.numeroComprobante || c.NumeroComprobante;
                    const tipo = c.tipoPago || c.TipoPago;
                    const neto = precio - debitos; 

                    tbody.innerHTML += `<tr>
                        <td>${fecha}</td>
                        <td class="fw-bold text-dark">${nombreOS}</td>
                        <td>${comp}</td>
                        <td><span class="badge bg-secondary">${tipo}</span></td>
                        <td class="text-end text-primary">$${precio.toFixed(2)}</td>
                        <td class="text-end text-danger">$${debitos.toFixed(2)}</td>
                        <td class="text-end fw-bold border-start border-secondary">$${neto.toFixed(2)}</td>
                        <td class="text-center">
                            <button class="btn btn-warning btn-sm" onclick="editarCobro(${idCobro})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarCobro(${idCobro})">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
            } else { 
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-muted">No se encontraron cobros con esos filtros.</td></tr>'; 
            }
        } catch(e) { 
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error de conexi√≥n.</td></tr>'; 
        }
    }

    async function guardarCobro() {
        if(document.getElementById('cobroOS').value == "0") { alert("Falta Obra Social"); return; }
        
        const fd = new FormData();
        fd.append("IdCobro", document.getElementById('cobroId').value);
        fd.append("IdObraSocial", document.getElementById('cobroOS').value);
        fd.append("FechaCobro", document.getElementById('cobroFecha').value);
        fd.append("TipoPago", document.getElementById('cobroTipo').value);
        fd.append("NumeroComprobante", document.getElementById('cobroComprobante').value);
        fd.append("Precio", document.getElementById('cobroImporte').value.replace('.', ','));
        fd.append("MontoDebitos", document.getElementById('cobroDebitos').value.replace('.', ','));
        fd.append("MotivoDebito", document.getElementById('cobroMotivoDebito').value);
        // Eliminado IdLiquidacion

        try {
            const r = await fetch('@Url.Action("GuardarCobro", "Home")', { method: 'POST', body: fd });
            const res = await r.json();
            if(res.success) { alert("‚úÖ Guardado."); modalCobro.hide(); buscarCobros(); }
            else { alert("‚ùå " + res.message); }
        } catch(e) { alert("Error guardando."); }
    }

    async function eliminarCobro(id) {
        if(!confirm("¬øEliminar este cobro?")) return;
        const fd = new FormData(); fd.append("idCobro", id);
        try {
            const r = await fetch('@Url.Action("EliminarCobro", "Home")', { method: 'POST', body: fd });
            if((await r.json()).success) buscarCobros();
        } catch(e) {}
    }

    async function editarCobro(id) {
        try {
            const r = await fetch(`@Url.Action("ObtenerCobroPorId", "Home")?idCobro=${id}`);
            const res = await r.json();
            if(res.success) {
                const d = res.data;
                const mandID = res.idMandataria || d.idMandataria || 0; 

                abrirModalCobro(id);

                // Setear Mandataria
                const opciones = document.getElementById('dlCobroMandataria').options;
                for(let i=0; i<opciones.length; i++){
                    if(opciones[i].getAttribute('data-id') == mandID){
                        document.getElementById('txtCobroMandataria').value = opciones[i].value;
                        break;
                    }
                }
                document.getElementById('cobroMandataria').value = mandID;

                // Cargar OS y luego seleccionar
                if(mandID > 0) {
                    await cargarOS(mandID, 'dlCobroOS', 'txtCobroOS');
                    const idOS = d.idObrasSociales || d.IdObrasSociales;
                    document.getElementById('cobroOS').value = idOS;
                    
                    setTimeout(() => {
                        const opsOS = document.getElementById('dlCobroOS').options;
                        for(let k=0; k<opsOS.length; k++){
                            if(opsOS[k].getAttribute('data-id') == idOS){
                                document.getElementById('txtCobroOS').value = opsOS[k].value;
                                break;
                            }
                        }
                    }, 200);
                }
                
                document.getElementById('cobroFecha').value = (d.fechaCobro || d.FechaCobro).split('T')[0];
                document.getElementById('cobroTipo').value = d.tipoPago || d.TipoPago;
                document.getElementById('cobroComprobante').value = d.numeroComprobante || d.NumeroComprobante;
                document.getElementById('cobroImporte').value = d.precio || d.Precio || d.importeCobrado;
                document.getElementById('cobroDebitos').value = d.montoDebitos || d.MontoDebitos;
                document.getElementById('cobroMotivoDebito').value = d.motivoDebito || d.MotivoDebito || "";
                
                calcularTotalNeto();
            }
        } catch(e) { 
            console.error(e);
            alert("Error recuperando datos."); 
        }
    }

    function abrirModalCobro(id) {
        document.getElementById('cobroId').value = id;
        document.getElementById('tituloModal').textContent = (id === 0) ? "NUEVO COBRO" : "EDITAR COBRO";
        
        if(id === 0) {
            document.getElementById('txtCobroMandataria').value = "";
            document.getElementById('cobroMandataria').value = "0";
            
            document.getElementById('txtCobroOS').value = "";
            document.getElementById('cobroOS').value = "0";
            document.getElementById('txtCobroOS').disabled = true;
            document.getElementById('txtCobroOS').placeholder = "Primero Mandataria...";

            document.getElementById('cobroImporte').value = "0.00";
            document.getElementById('cobroComprobante').value = "";
            document.getElementById('cobroMotivoDebito').value = "";
            calcularTotalNeto();
        }
        modalCobro.show();
    }

    function limpiarFiltros() {
        document.getElementById('txtFiltroMandataria').value = "";
        document.getElementById('filtroMandataria').value = "0";
        document.getElementById('txtFiltroOS').value = "";
        document.getElementById('filtroOS').value = "0";
        document.getElementById('txtFiltroOS').disabled = true;
        document.getElementById('filtroComprobante').value = "";
        document.getElementById('filtroFechaDesde').value = "";
        document.getElementById('filtroFechaHasta').value = "";
        buscarCobros();
    }
</script>
}