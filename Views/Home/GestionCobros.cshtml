@using System.Text.Json
@using WebFarmaciaMiguetti.Models

@{
    ViewData["Title"] = "Gesti√≥n de Cobros";

    // Datos del servidor (Backend original)
    var listaMandatarias = (ViewBag.Mandatarias as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var listaObrasSociales = (ViewBag.ObrasSociales as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var listaTiposPago = (ViewBag.TiposPago as List<string>) ?? new List<string> { "Transferencia", "Cheque", "Efectivo", "Dep√≥sito" };

    try { listaObrasSociales = listaObrasSociales.OrderBy(x => x.Nombre).ToList(); } catch { }

    var jsonObrasSociales = JsonSerializer.Serialize(listaObrasSociales.Select(x => new { id = x.IdObrasSociales, nombre = x.Nombre, idMand = x.IdMandataria }));
}

<style>
    /* ESTILOS DE ALTO CONTRASTE Y LECTURA F√ÅCIL */
    body { font-family: 'Verdana', sans-serif; background-color: #f4f6f9; color: #000; }
    h1 { font-size: 2.2rem; font-weight: 900; color: #146c43; text-transform: uppercase; border-bottom: 5px solid #146c43; display: inline-block; margin-bottom: 20px; }
    
    .form-control, .form-select { border: 3px solid #6c757d; font-size: 1rem; padding: 10px; color: #000; font-weight: 600; }
    .form-label { font-weight: 900; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 5px; display: block; }
    
    .btn-super { font-size: 0.95rem; font-weight: 800; padding: 8px 16px; border: 2px solid rgba(0,0,0,0.2); text-transform: uppercase; }
    
    .table-container { border: 3px solid #000; border-radius: 4px; overflow: hidden; background: white; margin-top:15px; }
    .table thead th { background-color: #146c43; color: white; font-size: 1rem; vertical-align: middle; text-align: center; border-bottom: 3px solid #000; }
    .table tbody td { font-size: 1rem; vertical-align: middle; font-weight: 500; padding: 12px; }

    /* Buscadores */
    .buscador-wrapper { position: relative; width: 100%; }
    .lista-sugerencias { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 3px solid #000; border-top: none; z-index: 9999; display: none; max-height: 250px; overflow-y: auto; }
    .item-sugerencia { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-weight: bold; }
    .item-sugerencia:hover { background-color: #198754; color: white; }

    /* Headers Modales */
    .total-display { font-size: 2rem; font-weight: 900; color: #198754; text-align: right; padding: 10px; background: #d1e7dd; border: 3px solid #198754; border-radius: 6px; }
    .bg-header-add { background-color: #198754; color: white; border-bottom: 5px solid #0f5132; }
    .bg-header-view { background-color: #0d6efd; color: white; border-bottom: 5px solid #000; }
    .bg-header-edit { background-color: #ffc107; color: #000; border-bottom: 5px solid #000; }
</style>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>üí∞ GESTI√ìN DE COBROS</h1>
        <button class="btn btn-success btn-lg btn-super shadow" onclick="abrirModalNuevo()">‚ûï NUEVO LOTE (CHEQUE)</button>
    </div>

    <div class="card mb-4 shadow-sm" style="border: 3px solid #6c757d; background-color: #e2e3e5;">
        <div class="card-body">
            <h4 class="mb-3 fw-bold">üîç BUSCAR LOTES</h4>
            <div class="row g-3 align-items-end">
                <div class="col-md-2"><label class="form-label">Desde</label><input type="date" id="filtroDesde" class="form-control"></div>
                <div class="col-md-2"><label class="form-label">Hasta</label><input type="date" id="filtroHasta" class="form-control"></div>
                <div class="col-md-3"><label class="form-label">Mandataria</label><select id="filtroMandataria" class="form-select"><option value="0">-- TODAS --</option>@foreach (var m in listaMandatarias) { <option value="@m.IdMandatarias">@m.RazonSocial</option> }</select></div>
                <div class="col-md-3"><label class="form-label">Obra Social</label><div class="buscador-wrapper"><input type="text" id="txtFiltroOS" class="form-control" placeholder="Buscar..." autocomplete="off"><input type="hidden" id="filtroOS" value="0"><div id="listaFiltroOS" class="lista-sugerencias"></div></div></div>
                <div class="col-md-2 d-flex gap-2"><button class="btn btn-primary btn-super w-100" onclick="buscarCobros()">BUSCAR</button><button class="btn btn-secondary btn-super" onclick="limpiarFiltros()">üîÑ</button></div>
            </div>
        </div>
    </div>

    <div class="table-container shadow">
        <table class="table table-striped table-hover mb-0">
            <thead>
                <tr>
                    <th>FECHA</th>
                    <th>MANDATARIA (ORIGEN)</th>
                    <th>COMPROBANTE</th>
                    <th>TIPO</th>
                    <th class="text-center">CANT. PAGOS</th>
                    <th class="text-end pe-4">TOTAL IMPORTE</th>
                    <th class="text-end pe-4">TOTAL NETO</th>
                    <th class="text-center">ACCIONES</th>
                </tr>
            </thead>
            <tbody id="tbodyResultados">
                <tr><td colspan="8" class="text-center p-4 text-muted fs-4">Cargando datos...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalNuevo" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-xl"> 
        <div class="modal-content border-0">
            <div class="modal-header bg-header-add py-3">
                <h3 class="modal-title fw-bold">üßæ REGISTRAR NUEVO INGRESO</h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-4">
                
                <div class="row g-3 mb-4 p-3 border border-3 border-success rounded bg-white shadow-sm position-relative">
                    <span class="fw-bold text-success">1. DATOS DEL CHEQUE / TRANSFERENCIA</span>
                    <div class="col-md-3"><label class="form-label">üìÖ FECHA</label><input type="date" id="n_Fecha" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")"></div>
                    <div class="col-md-4"><label class="form-label">üè¢ PAGADOR</label><select id="n_Mand" class="form-select fw-bold border-success"><option value="0">-- SELECCIONE --</option>@foreach (var m in listaMandatarias) { <option value="@m.IdMandatarias">@m.RazonSocial</option> }</select></div>
                    <div class="col-md-3"><label class="form-label">üí≥ TIPO</label><select id="n_Tipo" class="form-select">@foreach(var t in listaTiposPago){<option value="@t">@t</option>}</select></div>
                    <div class="col-md-2"><label class="form-label">üìÑ N¬∞ COMP</label><input type="text" id="n_Comp" class="form-control" placeholder="Ej: 5544"></div>
                </div>

                <h5 class="fw-bold text-success mb-2">2. IMPUTAR A OBRAS SOCIALES</h5>
                <div class="card mb-3 border-2 border-secondary">
                    <div class="card-body bg-white">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-5"><label class="form-label">OBRA SOCIAL</label><div class="buscador-wrapper"><input type="text" id="txtN_OS" class="form-control fw-bold" placeholder="Escriba para buscar..." autocomplete="off"><input type="hidden" id="valN_OS" value="0"><div id="listN_OS" class="lista-sugerencias"></div></div></div>
                            <div class="col-md-3"><label class="form-label text-success">IMPORTE</label><input type="number" id="n_Imp" class="form-control text-success fw-bold form-control-lg" placeholder="0.00" onkeypress="enterAdd(event)"></div>
                            <div class="col-md-2"><label class="form-label text-danger">D√âBITOS</label><input type="number" id="n_Deb" class="form-control text-danger fw-bold" value="0.00" onkeypress="enterAdd(event)"></div>
                            <div class="col-md-2"><button class="btn btn-success w-100 fw-bold py-2" onclick="aggTemp()">‚¨áÔ∏è BAJAR</button></div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive border border-2 border-dark rounded bg-white" style="height:250px; overflow-y:auto;">
                    <table class="table table-bordered mb-0">
                        <thead class="table-light sticky-top"><tr><th>OBRA SOCIAL</th><th class="text-end">IMPORTE</th><th class="text-end">D√âBITOS</th><th class="text-end">NETO</th><th class="text-center">X</th></tr></thead>
                        <tbody id="tbodyTemp"></tbody>
                    </table>
                </div>
                <div class="row mt-3 justify-content-end"><div class="col-md-6"><div class="total-display">TOTAL LOTE: <span id="lblTotalLote">$0.00</span></div></div></div>
            </div>
            <div class="modal-footer bg-light py-3">
                <button class="btn btn-secondary btn-lg btn-super me-auto" data-bs-dismiss="modal">CANCELAR</button>
                <button class="btn btn-success btn-lg btn-super px-5 shadow" onclick="guardarNuevoLote()">üíæ GUARDAR TODO</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVer" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-4 border-primary">
            <div class="modal-header bg-header-view">
                <h4 class="modal-title fw-bold">üëÅÔ∏è GESTI√ìN DEL LOTE</h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div class="row mb-3 bg-white border p-3 rounded mx-1 shadow-sm">
                    <div class="col-md-6"><span class="text-muted small d-block">MANDATARIA:</span><h4 class="fw-bold text-primary m-0" id="v_Titulo">---</h4></div>
                    <div class="col-md-3"><span class="text-muted small d-block">COMPROBANTE:</span><h4 class="fw-bold m-0" id="v_Comp">---</h4></div>
                    <div class="col-md-3"><span class="text-muted small d-block">FECHA:</span><h4 class="fw-bold m-0" id="v_Fecha">---</h4></div>
                </div>

                <div class="card mb-3 border-primary">
                    <div class="card-header bg-primary text-white fw-bold py-1">‚ûï AGREGAR PAGO A ESTE LOTE</div>
                    <div class="card-body py-2">
                        <div class="alert alert-info py-1 mb-2 small">‚ÑπÔ∏è Solo Obras Sociales de <b><span id="v_LblMand"></span></b>.</div>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-5"><div class="buscador-wrapper"><input type="text" id="txtV_OS" class="form-control form-control-sm fw-bold" placeholder="Buscar OS..." autocomplete="off"><input type="hidden" id="valV_OS" value="0"><div id="listV_OS" class="lista-sugerencias"></div></div></div>
                            <div class="col-md-3"><input type="number" id="v_Imp" class="form-control form-control-sm text-success fw-bold" placeholder="Importe $"></div>
                            <div class="col-md-2"><input type="number" id="v_Deb" class="form-control form-control-sm text-danger fw-bold" value="0"></div>
                            <div class="col-md-2"><button class="btn btn-primary fw-bold w-100" onclick="agregarAlLote()">‚¨áÔ∏è AGREGAR</button></div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive border border-2 border-dark rounded bg-white" style="height: 300px; overflow-y: auto;">
                    <table class="table table-bordered table-striped mb-0">
                        <thead class="table-dark sticky-top">
                            <tr><th>OBRA SOCIAL</th><th class="text-end">IMPORTE</th><th class="text-end">D√âBITOS</th><th class="text-end">NETO</th><th class="text-center">ACCIONES</th></tr>
                        </thead>
                        <tbody id="tbodyVer"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light"><button class="btn btn-secondary btn-lg fw-bold px-5" data-bs-dismiss="modal">CERRAR</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEdit" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-warning">
            <div class="modal-header bg-header-edit"><h4 class="modal-title fw-bold">‚úèÔ∏è CORREGIR DATOS DEL LOTE</h4><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body bg-white p-4">
                <input type="hidden" id="e_IdCobroRef">
                <div class="alert alert-warning fw-bold">‚ö†Ô∏è Los cambios se aplicar√°n a TODOS los pagos de este lote.</div>
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">Mandataria</label><input type="text" id="e_Mandataria" class="form-control" disabled readonly></div>
                    <div class="col-md-6"><label class="form-label">Tipo Pago</label><select id="e_Tipo" class="form-select">@foreach(var t in listaTiposPago){<option value="@t">@t</option>}</select></div>
                    <div class="col-md-6"><label class="form-label">Fecha</label><input type="date" id="e_Fecha" class="form-control"></div>
                    <div class="col-md-6"><label class="form-label">Comprobante</label><input type="text" id="e_Comp" class="form-control"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-warning fw-bold px-4" onclick="guardarEdicionLote()">APLICAR A TODO EL LOTE</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditDetalle" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog">
        <div class="modal-content border-warning">
            <div class="modal-header bg-warning py-2"><h5 class="modal-title fw-bold">EDITAR PAGO INDIVIDUAL</h5><button type="button" class="btn-close" onclick="cerrarEditDetalle()"></button></div>
            <div class="modal-body p-3">
                <input type="hidden" id="ed_Id">
                <label>Obra Social</label>
                <div class="buscador-wrapper mb-2"><input type="text" id="txtED_OS" class="form-control fw-bold"><input type="hidden" id="valED_OS"><div id="listED_OS" class="lista-sugerencias"></div></div>
                <label>Importe</label><input type="number" id="ed_Imp" class="form-control fw-bold text-success mb-2">
                <label>D√©bitos</label><input type="number" id="ed_Deb" class="form-control fw-bold text-danger">
            </div>
            <div class="modal-footer py-2"><button class="btn btn-warning fw-bold w-100" onclick="guardarEditDetalle()">GUARDAR CAMBIO</button></div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // == VARIABLES GLOBALES ==
    var datosOS = @Html.Raw(jsonObrasSociales);
    var itemsTemp = []; 
    var datosAgrupados = {}; 
    var loteContexto = {}; 
    
    var mVer = new bootstrap.Modal(document.getElementById('modalVer'));
    var mNuevo = new bootstrap.Modal(document.getElementById('modalNuevo'));
    var mEdit = new bootstrap.Modal(document.getElementById('modalEdit'));
    var mEditDetalle = new bootstrap.Modal(document.getElementById('modalEditDetalle'));

    // --- UTILITIES ROBUSTAS ---
    // Funci√≥n para leer propiedades insensible a may√∫sculas/min√∫sculas
    function getProp(obj, prop) {
        if (!obj) return null;
        if (obj[prop] !== undefined) return obj[prop];
        let lowerProp = prop.toLowerCase();
        for (let key in obj) {
            if (key.hasOwnProperty(key) && key.toLowerCase() === lowerProp) return obj[key];
        }
        return null;
    }
    
    // Funci√≥n para convertir a Float Seguro
    function safeFloat(val) {
        if (!val) return 0;
        if (typeof val === 'number') return val;
        let s = val.toString().trim();
        if (s.includes(',') && s.includes('.')) {
            s = s.replace(/\./g, '').replace(',', '.'); 
        } else if (s.includes(',')) {
            s = s.replace(',', '.');
        }
        return parseFloat(s) || 0;
    }
    // --- FIN UTILITIES ---

    document.addEventListener("DOMContentLoaded", () => {
        // Inicializar Buscadores
        setupAuto('txtFiltroOS', 'listaFiltroOS', 'filtroOS', datosOS);
        setupAuto('txtN_OS', 'listN_OS', 'valN_OS', datosOS);
        
        // Setup especial para el modal Ver: Solo muestra OS de la Mandataria del lote
        setupAuto('txtV_OS', 'listV_OS', 'valV_OS', datosOS, () => loteContexto.idMand); 
        
        setupAuto('txtED_OS', 'listED_OS', 'valED_OS', datosOS);
        buscarCobros();
    });

    // 1. BUSCADOR PRINCIPAL (AGRUPA Y SUMA EN JS)
    async function buscarCobros() {
        const tbody = document.getElementById('tbodyResultados');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4"><div class="spinner-border text-success"></div> Procesando datos...</td></tr>';

        let url = `@Url.Action("BuscarCobrosAjax", "Home")?dummy=1` +
            `&IdMandataria=${document.getElementById('filtroMandataria').value}` +
            `&IdObraSocial=${document.getElementById('filtroOS').value}` +
            `&desde=${document.getElementById('filtroDesde').value}` +
            `&hasta=${document.getElementById('filtroHasta').value}`;

        try {
            const r = await fetch(url);
            const res = await r.json();
            
            if(res.success && res.data.length > 0) {
                datosAgrupados = {}; 
                
                res.data.forEach(x => {
                    // USO DE GETPROP ROBUSTO
                    const comp = (getProp(x, 'NumeroComprobante') || 'S/N').trim();
                    const idMand = getProp(x, 'IdMandatarias') || 0; 
                    const fecha = (getProp(x, 'FechaCobro')).split('T')[0]; // Asumo que FechaCobro existe
                    const key = comp + '_' + idMand + '_' + fecha; 
                    
                    if(!datosAgrupados[key]) {
                        datosAgrupados[key] = {
                            key: key, comp: comp, fecha: fecha,
                            mand: getProp(x, 'NombreMandataria') || '---',
                            tipo: getProp(x, 'TipoPago') || '-',
                            idMand: idMand,
                            items: [], totalImp: 0, totalDeb: 0
                        };
                    }
                    
                    datosAgrupados[key].items.push(x);
                    // SUMAS SEGURAS
                    datosAgrupados[key].totalImp += safeFloat(getProp(x, 'ImporteCobrado'));
                    datosAgrupados[key].totalDeb += safeFloat(getProp(x, 'MontoDebitos'));
                });

                tbody.innerHTML = '';
                Object.values(datosAgrupados).forEach(g => {
                    const neto = g.totalImp - g.totalDeb;
                    
                    tbody.innerHTML += `<tr>
                        <td class="text-center">${g.fecha}</td>
                        <td class="fw-bold text-primary">${g.mand}</td>
                        <td class="fw-bold text-center">${g.comp}</td>
                        <td>${g.tipo}</td>
                        <td class="text-center fw-bold fs-5">${g.items.length}</td>
                        <td class="text-end fw-bold fs-5 text-dark">$${g.totalImp.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                        <td class="text-end fw-black fs-5 text-success border-start border-end bg-light">$${neto.toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                        <td class="text-center">
                            <button class="btn btn-warning btn-sm me-1" onclick="abrirEditarLote('${g.key}')">‚úèÔ∏è</button>
                            <button class="btn btn-primary btn-sm fw-bold px-3 me-1" onclick="abrirVer('${g.key}')">üëÅÔ∏è VER</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarLoteCompleto('${g.key}')" title="Eliminar Lote Completo">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
            } else { tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4">No hay resultados.</td></tr>'; }
        } catch(e) { console.error("Error al buscar/agrupar:", e); tbody.innerHTML = '<tr><td colspan="8" class="text-danger text-center">Error al cargar datos.</td></tr>'; }
    }

    // 2. MODAL NUEVO (GUARDAR LOTE)
    async function guardarNuevoLote() {
        const mand = document.getElementById('n_Mand').value;
        if(mand=="0" || itemsTemp.length==0) { alert("‚ö†Ô∏è Faltan datos"); return; }
        if(!confirm("¬øGuardar?")) return;

        for (const x of itemsTemp) {
            const fd = new FormData();
            fd.append("IdCobro", 0);
            fd.append("IdObraSocial", x.id);
            fd.append("FechaCobro", document.getElementById('n_Fecha').value);
            fd.append("NumeroComprobante", document.getElementById('n_Comp').value);
            fd.append("TipoPago", document.getElementById('n_Tipo').value);
            fd.append("ImporteCobrado", x.imp.toString().replace('.', ',')); // Env√≠a valor num√©rico con coma
            fd.append("MontoDebitos", x.deb.toString().replace('.', ','));
            fd.append("MotivoDebito", "");
            
            // Llama a tu funci√≥n GuardarCobro (que hace el INSERT)
            await fetch('@Url.Action("GuardarCobro", "Home")', { method:'POST', body:fd });
        }
        alert("‚úÖ Lote Guardado."); mNuevo.hide(); buscarCobros();
    }

    // 3. MODAL VER (MUESTRA DETALLE Y PERMITE AGREGAR/EDITAR)
    function abrirVer(key) {
        const g = datosAgrupados[key];
        if(!g) return;
        
        loteContexto = { fecha: g.fecha, comp: g.comp, tipo: g.tipo, mandKey: key, idMand: g.idMand };

        document.getElementById('v_Titulo').textContent = g.mand;
        document.getElementById('v_LblMand').textContent = g.mand; 
        document.getElementById('v_Comp').textContent = g.comp;
        document.getElementById('v_Fecha').textContent = g.fecha;
        
        dibujarTablaVer(g.items);
        mVer.show();
    }

    function dibujarTablaVer(items) {
        const b = document.getElementById('tbodyVer'); b.innerHTML='';
        items.forEach(x => {
            const nomOS = getProp(x, 'NombreObraSocial') || datosOS.find(o=>o.id==(getProp(x, 'IdObrasSociales')||0))?.nombre||'-';
            const imp = safeFloat(getProp(x, 'ImporteCobrado'));
            const deb = safeFloat(getProp(x, 'MontoDebitos'));
            const id = getProp(x, 'IdCobros');

            b.innerHTML += `<tr>
                <td class="fw-bold">${nomOS}</td>
                <td class="text-end text-success">$${imp.toFixed(2)}</td>
                <td class="text-end text-danger">$${deb.toFixed(2)}</td>
                <td class="text-end fw-black">$${(imp-deb).toFixed(2)}</td>
                <td class="text-center">
                    <button class="btn btn-warning btn-sm me-1" onclick="abrirEditDetalle(${id})">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-outline-danger fw-bold" onclick="eliminarDelLote(${id})">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
    }

    // AGREGAR √çTEM DENTRO DEL LOTE
    async function agregarAlLote() {
        const idOS = document.getElementById('valV_OS').value;
        const imp = document.getElementById('v_Imp').value;
        if(idOS==0 || !imp) return;

        const fd = new FormData();
        fd.append("IdCobro", 0);
        fd.append("IdObraSocial", idOS);
        fd.append("FechaCobro", loteContexto.fecha);
        fd.append("NumeroComprobante", loteContexto.comp);
        fd.append("TipoPago", loteContexto.tipo);
        fd.append("ImporteCobrado", imp.replace('.', ',')); // Env√≠a con coma
        fd.append("MontoDebitos", (document.getElementById('v_Deb').value||0).toString().replace('.', ','));
        fd.append("MotivoDebito", "");

        const r = await fetch('@Url.Action("GuardarCobro", "Home")', { method:'POST', body:fd });
        if((await r.json()).success) {
            document.getElementById('v_Imp').value=""; document.getElementById('txtV_OS').value=""; document.getElementById('valV_OS').value="0";
            await buscarCobros(); 
            if(datosAgrupados[loteContexto.mandKey]) abrirVer(loteContexto.mandKey); 
        } else alert("Error al agregar.");
    }

    // 4. EDICI√ìN GLOBAL (CABECERA)
    function abrirEditarLote(key) {
        const g = datosAgrupados[key];
        document.getElementById('e_IdCobroRef').value = key; 
        document.getElementById('e_Mandataria').value = g.mand; 
        document.getElementById('e_Fecha').value = g.fecha;
        document.getElementById('e_Comp').value = g.comp;
        document.getElementById('e_Tipo').value = g.tipo;
        mEdit.show();
    }

    async function guardarEdicionLote() {
        if(!confirm("¬øActualizar todo el lote?")) return;
        const key = document.getElementById('e_IdCobroRef').value;
        const g = datosAgrupados[key];
        
        const nF = document.getElementById('e_Fecha').value;
        const nC = document.getElementById('e_Comp').value;
        const nT = document.getElementById('e_Tipo').value;
        
        // Iteramos sobre todos los √≠tems del lote y llamamos a GuardarCobro para cada uno
        for(const item of g.items) {
            const fd = new FormData();
            fd.append("IdCobro", getProp(item, 'IdCobros')); // ID del item
            fd.append("IdObraSocial", getProp(item, 'IdObrasSociales'));
            fd.append("FechaCobro", nF); // Nuevo dato
            fd.append("NumeroComprobante", nC); // Nuevo dato
            fd.append("TipoPago", nT); // Nuevo dato
            // Mantenemos importes originales
            fd.append("ImporteCobrado", safeFloat(getProp(item, 'ImporteCobrado')).toString().replace('.',','));
            fd.append("MontoDebitos", safeFloat(getProp(item, 'MontoDebitos')).toString().replace('.',','));
            fd.append("MotivoDebito", getProp(item, 'MotivoDebito')||"");
            
            await fetch('@Url.Action("GuardarCobro", "Home")', { method:'POST', body:fd });
        }
        mEdit.hide(); buscarCobros();
    }

    // 5. EDICI√ìN DETALLE (INDIVIDUAL)
    async function abrirEditDetalle(id) {
        // Obtenemos datos frescos del servidor
        const r = await fetch(`@Url.Action("ObtenerCobroPorId", "Home")?idCobro=${id}`);
        const res = (await r.json());
        if(!res.success) { alert("Error al traer datos"); return; }
        
        const d = res.data;
        document.getElementById('ed_Id').value = id;
        document.getElementById('valED_OS').value = getProp(d, 'IdObrasSociales');
        const nom = datosOS.find(x=>x.id == getProp(d, 'IdObrasSociales'))?.nombre || "ID "+getProp(d, 'IdObrasSociales');
        document.getElementById('txtED_OS').value = nom;
        
        document.getElementById('ed_Imp').value = safeFloat(getProp(d, 'ImporteCobrado'));
        document.getElementById('ed_Deb').value = safeFloat(getProp(d, 'MontoDebitos'));
        
        // Guardamos objeto completo para reusar los campos de cabecera que no se editan aqu√≠
        document.getElementById('ed_Id').dataset.full = JSON.stringify(d);
        mEditDetalle.show();
    }

    async function guardarEditDetalle() {
        const id = document.getElementById('ed_Id').value;
        const d = JSON.parse(document.getElementById('ed_Id').dataset.full);
        
        const fd = new FormData();
        fd.append("IdCobro", id);
        fd.append("IdObraSocial", document.getElementById('valED_OS').value);
        fd.append("FechaCobro", (getProp(d, 'FechaCobro')).split('T')[0]);
        fd.append("NumeroComprobante", getProp(d, 'NumeroComprobante'));
        fd.append("TipoPago", getProp(d, 'TipoPago'));
        
        fd.append("ImporteCobrado", document.getElementById('ed_Imp').value.replace('.',','));
        fd.append("MontoDebitos", document.getElementById('ed_Deb').value.replace('.',','));
        fd.append("MotivoDebito", getProp(d, 'MotivoDebito')||"");

        const r = await fetch('@Url.Action("GuardarCobro", "Home")', { method:'POST', body:fd });
        if((await r.json()).success) {
            mEditDetalle.hide();
            await buscarCobros();
            // Refresca la tabla del modal Ver si sigue abierta
            if(datosAgrupados[loteContexto.mandKey]) abrirVer(loteContexto.mandKey);
        } else alert("Error.");
    }
    
    function cerrarEditDetalle() { mEditDetalle.hide(); }

    // ELIMINAR LOTE COMPLETO (BOT√ìN DE LA TABLA PRINCIPAL)
    async function eliminarLoteCompleto(key) {
        if(!confirm("¬øEST√Å SEGURO DE BORRAR TODO ESTE CHEQUE/LOTE? Se borrar√°n todos los pagos incluidos.")) return;
        const g = datosAgrupados[key];
        for(const item of g.items) {
            const fd = new FormData(); fd.append("idCobro", getProp(item, 'IdCobros'));
            await fetch('@Url.Action("EliminarCobro", "Home")', {method:'POST', body:fd});
        }
        buscarCobros();
    }

    // ELIMINAR √çTEM INDIVIDUAL (BOT√ìN EN EL MODAL VER)
    function eliminarDelLote(id) {
        if(!confirm("¬øBorrar este pago individual?")) return;
        const fd=new FormData(); fd.append("idCobro", id);
        fetch('@Url.Action("EliminarCobro", "Home")', {method:'POST', body:fd}).then(async ()=> { 
            await buscarCobros();
            // Refresca el modal Ver si a√∫n existe el grupo
            if(datosAgrupados[loteContexto.mandKey]) abrirVer(loteContexto.mandKey); else mVer.hide();
        });
    }

    // UTILS
    function limpiarFiltros() { 
        document.getElementById('filtroMandataria').value=0; document.getElementById('txtFiltroOS').value=""; document.getElementById('filtroOS').value=0;
        document.getElementById('filtroDesde').value=""; document.getElementById('filtroHasta').value="";
        buscarCobros(); 
    }

    function setupAuto(inpId, listId, hidId, src, filtroCallback) {
        const i=document.getElementById(inpId), l=document.getElementById(listId), h=document.getElementById(hidId);
        i.addEventListener('input', function() {
            const tx = this.value.toLowerCase(); l.innerHTML=''; h.value=0;
            if(!tx) { l.style.display='none'; return; }
            
            const filtroMand = filtroCallback ? filtroCallback() : 0;
            
            src.filter(x => {
                const matchTexto = x.nombre.toLowerCase().includes(tx);
                const matchMand = (filtroMand === 0 || x.idMand === filtroMand);
                return matchTexto && matchMand;
            }).forEach(x=>{
                const d=document.createElement('div'); d.className='item-sugerencia'; d.textContent=x.nombre;
                d.onmousedown=()=>{ i.value=x.nombre; h.value=x.id; l.style.display='none'; };
                l.appendChild(d);
            });
            l.style.display='block';
        });
        i.addEventListener('blur', ()=>setTimeout(()=>l.style.display='none',200));
    }
</script>
}