@using System.Text.Json
@using WebFarmaciaMiguetti.Models

@{
    ViewData["Title"] = "Gesti√≥n de Cobros";

    // 1. PREPARAMOS LOS DATOS INICIALES DEL SERVER
    var listaMandatariasRaw = ViewBag.Mandatarias as IEnumerable<dynamic>;
    var listaMandatarias = listaMandatariasRaw?.ToList() ?? new List<dynamic>();
    var listaTiposPago = (ViewBag.TiposPago as List<string>) ?? new List<string> { "Transferencia", "Cheque", "Efectivo", "Dep√≥sito" };

    // 2. SERIALIZAMOS PARA JS
    var jsonMandatarias = JsonSerializer.Serialize(listaMandatarias.Select(m => new { 
        id = m.IdMandatarias, 
        nombre = m.RazonSocial 
    }));
}

<style>
    body { font-family: 'Roboto', sans-serif; background-color: #f4f6f9; }
    h1 { font-size: 2.2rem; font-weight: 900; color: #146c43; text-transform: uppercase; border-bottom: 4px solid #146c43; display: inline-block; }

    /* CONTENEDOR BUSCADOR */
    .search-container { background-color: #e9ecef; border: 2px solid #ced4da; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .form-label-sm { font-weight: 700; font-size: 0.85rem; text-transform: uppercase; color: #495057; display: block; }
    
    /* INPUTS */
    .form-control-sm-custom { border: 2px solid #adb5bd; font-weight: 500; padding: 5px 10px; width: 100%; border-radius: 4px; font-size: 0.95rem; }
    .form-control-sm-custom:focus { border-color: #198754; box-shadow: 0 0 0 0.2rem rgba(25,135,84,0.15); outline: none; }
    .form-control-sm-custom:disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }

    /* BUSCADOR FLOTANTE */
    .buscador-wrapper { position: relative; width: 100%; }
    .lista-sugerencias {
        position: absolute; top: 100%; left: 0; width: 100%;
        background: white; border: 2px solid #000; border-top: none;
        z-index: 9999; 
        display: none; max-height: 250px; overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .item-sugerencia { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; color: #000; }
    .item-sugerencia:hover { background-color: #198754; color: white; }

    /* TABLA */
    .table-responsive { border: 2px solid #000; border-radius: 4px; overflow: hidden; background: white; margin-top: 15px; }
    
    /* ALINEACI√ìN DE T√çTULOS */
    .table thead th { background-color: #146c43; color: white; padding: 12px; text-align: center; vertical-align: middle; }
    
    /* Celdas generales */
    .table tbody td { padding: 8px 12px; vertical-align: middle; }

    /* MODAL */
    .card-resumen { background-color: #d1e7dd; border: 3px solid #198754; border-radius: 8px; padding: 10px; margin-top: 15px; }
    .total-final { font-size: 1.8rem; font-weight: 900; color: #198754; text-align: center; }
</style>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>üí∞ GESTI√ìN DE COBROS</h1>
        <button class="btn btn-success fw-bold py-2 px-4" onclick="abrirModalCobro(0)">
            ‚ûï NUEVO COBRO
        </button>
    </div>

    <div class="search-container">
        <div class="row g-2 align-items-end">
            
            <div class="col-lg-3 col-md-4">
                <label class="form-label-sm">Mandataria</label>
                <div class="buscador-wrapper">
                    <input type="text" class="form-control-sm-custom" id="txtFiltroMandataria" placeholder="Todas las mandatarias..." autocomplete="off">
                    <input type="hidden" id="filtroMandataria" value="0">
                    <div id="listaFiltroMandataria" class="lista-sugerencias"></div>
                </div>
            </div>

            <div class="col-lg-3 col-md-4">
                <label class="form-label-sm">Obra Social</label>
                <div class="buscador-wrapper">
                    <input type="text" class="form-control-sm-custom" id="txtFiltroOS" placeholder="Primero Mandataria..." disabled autocomplete="off">
                    <input type="hidden" id="filtroOS" value="0">
                    <div id="listaFiltroOS" class="lista-sugerencias"></div>
                </div>
            </div>

            <div class="col-lg-2 col-md-4">
                <label class="form-label-sm">N¬∞ Comprobante</label>
                <input type="text" id="filtroComprobante" class="form-control-sm-custom" placeholder="Ej: 1234">
            </div>

            <div class="col-lg-1 col-md-6 col-6">
                <label class="form-label-sm">Desde</label>
                <input type="date" id="filtroFechaDesde" class="form-control-sm-custom">
            </div>
            <div class="col-lg-1 col-md-6 col-6">
                <label class="form-label-sm">Hasta</label>
                <input type="date" id="filtroFechaHasta" class="form-control-sm-custom">
            </div>

            <div class="col-lg-2 col-md-12 d-flex gap-1">
                <button class="btn btn-primary fw-bold w-100" onclick="buscarCobros()">üîç BUSCAR</button>
                <button class="btn btn-secondary fw-bold" onclick="limpiarFiltros()" title="Limpiar">üîÑ</button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-striped mb-0">
            <thead>
                <tr>
                    <th>FECHA</th>
                    <th>MANDATARIA</th>
                    <th>OBRA SOCIAL</th>
                    <th>COMPROBANTE</th>
                    <th>TIPO</th>
                    <th class="text-end pe-4">IMPORTE</th>
                    <th class="text-end pe-4">D√âBITOS</th>
                    <th class="text-end pe-4">NETO</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody id="tbodyCobros">
                <tr><td colspan="9" class="text-center p-4 text-muted">Use el buscador para ver los cobros.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalCobro" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-lg"> 
        <div class="modal-content border-3 border-success">
            <div class="modal-header bg-success text-white py-2">
                <h4 class="modal-title fw-bold" id="tituloModal">REGISTRAR COBRO</h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-white p-4">
                <input type="hidden" id="cobroId" value="0">
                
                <div class="row g-3 mb-3 border pb-3 bg-light rounded">
                    <div class="col-12"><h6 class="fw-bold text-success m-0">PASO 1: ORIGEN DE LOS FONDOS</h6></div>
                    
                    <div class="col-md-6">
                        <label class="form-label-sm">MANDATARIA</label>
                        <div class="buscador-wrapper">
                            <input type="text" class="form-control fw-bold" id="txtCobroMandataria" placeholder="Buscar..." autocomplete="off">
                            <input type="hidden" id="cobroMandataria" value="0">
                            <div id="listaCobroMandataria" class="lista-sugerencias"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label-sm">OBRA SOCIAL</label>
                        <div class="buscador-wrapper">
                            <input type="text" class="form-control fw-bold" id="txtCobroOS" placeholder="Seleccione Mandataria..." disabled autocomplete="off">
                            <input type="hidden" id="cobroOS" value="0">
                            <div id="listaCobroOS" class="lista-sugerencias"></div>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-12"><h6 class="fw-bold text-success m-0">PASO 2: DETALLES DEL PAGO</h6></div>
                    
                    <div class="col-md-4">
                        <label class="form-label-sm">FECHA</label>
                        <input type="date" id="cobroFecha" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label-sm">FORMA PAGO</label>
                        <select id="cobroTipo" class="form-select">
                            @foreach(var tipo in listaTiposPago) { <option value="@tipo">@tipo</option> }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label-sm">N¬∞ COMPROBANTE</label>
                        <input type="text" id="cobroComprobante" class="form-control" placeholder="Ej: 998877">
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label-sm text-primary">IMPORTE COBRADO</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" id="cobroImporte" class="form-control fw-bold fs-5 text-primary" step="0.01" value="0.00" oninput="calcularTotalNeto()">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-sm text-danger">D√âBITOS / RETENCIONES</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" id="cobroDebitos" class="form-control fw-bold fs-5 text-danger" step="0.01" value="0.00" oninput="calcularTotalNeto()">
                        </div>
                    </div>
                    <div class="col-12">
                        <input type="text" id="cobroMotivoDebito" class="form-control form-control-sm" placeholder="Motivo del d√©bito (Opcional)...">
                    </div>
                </div>

                <div class="card-resumen">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold fs-5">NETO A INGRESAR:</span>
                        <span class="total-final" id="lblTotalNeto">$0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light py-2">
                <button type="button" class="btn btn-secondary fw-bold" data-bs-dismiss="modal">CANCELAR</button>
                <button type="button" class="btn btn-success fw-bold px-4" onclick="guardarCobro()">üíæ GUARDAR COBRO</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    var fuentesDatos = {
        'txtFiltroMandataria': @Html.Raw(jsonMandatarias),
        'txtCobroMandataria': @Html.Raw(jsonMandatarias),
        'txtFiltroOS': [],  
        'txtCobroOS': []    
    };
    var modalCobro;

    document.addEventListener("DOMContentLoaded", () => {
        modalCobro = new bootstrap.Modal(document.getElementById('modalCobro'));

        // INICIALIZACI√ìN
        setupBuscador('txtFiltroMandataria', 'listaFiltroMandataria', 'filtroMandataria', onSelectMandatariaFiltro);
        setupBuscador('txtFiltroOS', 'listaFiltroOS', 'filtroOS', null);
        setupBuscador('txtCobroMandataria', 'listaCobroMandataria', 'cobroMandataria', onSelectMandatariaModal);
        setupBuscador('txtCobroOS', 'listaCobroOS', 'cobroOS', null);

        buscarCobros();
    });

    // MOTOR BUSCADOR
    function setupBuscador(inputId, listaId, hiddenId, callbackSelect) {
        const input = document.getElementById(inputId);
        const lista = document.getElementById(listaId);
        const hidden = document.getElementById(hiddenId);

        function dibujarLista() {
            const texto = input.value.toLowerCase().trim();
            const datos = fuentesDatos[inputId]; 

            lista.innerHTML = '';
            if (!datos || datos.length === 0) { lista.style.display = 'none'; return; }

            const filtrados = (texto === "") ? datos : datos.filter(item => item.nombre.toLowerCase().includes(texto));
            if (filtrados.length === 0) { lista.style.display = 'none'; return; }

            filtrados.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-sugerencia';
                div.textContent = item.nombre;
                div.onmousedown = function(e) {
                    e.preventDefault();
                    input.value = item.nombre;
                    hidden.value = item.id;
                    lista.style.display = 'none';
                    if (callbackSelect) callbackSelect(item.id);
                };
                lista.appendChild(div);
            });
            lista.style.display = 'block';
        }

        input.addEventListener('focus', dibujarLista);
        input.addEventListener('input', () => { hidden.value = "0"; dibujarLista(); });
        input.addEventListener('blur', () => { setTimeout(() => { lista.style.display = 'none'; }, 200); });
    }

    // CARGA OBRAS SOCIALES
    function onSelectMandatariaFiltro(id) { cargarOS_Ajax(id, 'txtFiltroOS', 'filtroOS'); }
    function onSelectMandatariaModal(id) { 
        document.getElementById('txtCobroOS').value = "";
        document.getElementById('cobroOS').value = "0";
        cargarOS_Ajax(id, 'txtCobroOS', 'cobroOS'); 
    }

    async function cargarOS_Ajax(idMand, inputId, hiddenId) {
        const input = document.getElementById(inputId);
        const hidden = document.getElementById(hiddenId);
        input.disabled = true; input.placeholder = "Cargando..."; input.value = ""; hidden.value = "0";

        try {
            const resp = await fetch(`@Url.Action("TraerObrasSocialesPorMandataria", "Home")?idMandataria=${idMand}`);
            const json = await resp.json();
            if (json.success && json.data.length > 0) {
                fuentesDatos[inputId] = json.data.map(d => ({ 
                    id: d.idObrasSociales || d.id || d.IdObrasSociales, 
                    nombre: d.nombre || d.Nombre 
                }));
                input.disabled = false; input.placeholder = "Seleccione O.S..."; input.focus();
            } else {
                fuentesDatos[inputId] = []; input.placeholder = "Sin Obras Sociales"; input.disabled = true;
            }
        } catch (e) { fuentesDatos[inputId] = []; input.placeholder = "Error"; }
    }

    // L√ìGICA PRINCIPAL (TABLA)
    async function buscarCobros() {
        const idMand = document.getElementById('filtroMandataria').value;
        const idOS = document.getElementById('filtroOS').value;
        const comp = document.getElementById('filtroComprobante').value;
        const desde = document.getElementById('filtroFechaDesde').value;
        const hasta = document.getElementById('filtroFechaHasta').value;

        const tbody = document.getElementById('tbodyCobros');
        tbody.innerHTML = '<tr><td colspan="9" class="text-center p-4"><div class="spinner-border text-success"></div></td></tr>';

        let url = `@Url.Action("BuscarCobrosAjax", "Home")?dummy=1`;
        if(idMand > 0) url += `&IdMandataria=${idMand}`;
        if(idOS > 0) url += `&IdObraSocial=${idOS}`;
        if(comp) url += `&numeroComprobante=${encodeURIComponent(comp)}`;
        if(desde) url += `&desde=${desde}`;
        if(hasta) url += `&hasta=${hasta}`;

        try {
            const r = await fetch(url);
            const res = await r.json();

            if (res.success && res.data && res.data.length > 0) {
                tbody.innerHTML = '';
                res.data.forEach(item => {
                    let fecha = item.fechaCobro || item.FechaCobro;
                    if(fecha && fecha.includes('T')) fecha = fecha.split('T')[0];

                    const mand = item.nombreMandataria || item.NombreMandataria || '-';
                    const os = item.nombreObraSocial || item.NombreObraSocial || '-';
                    const comprobante = item.numeroComprobante || item.NumeroComprobante || '';
                    const tipo = item.tipoPago || item.TipoPago || '';
                    const imp = item.importeCobrado || item.ImporteCobrado || 0;
                    const deb = item.montoDebitos || item.MontoDebitos || 0;
                    const id = item.idCobros || item.IdCobros;
                    const neto = imp - deb;

                    // === CAMBIOS APLICADOS AQU√ç PARA CENTRADO VISUAL ===
                    // ps-4 = Padding Start 4 (aprox 24px) para empujar el texto a la derecha
                    tbody.innerHTML += `
                    <tr>
                        <td class="text-center">${fecha}</td>
                        <td class="fw-bold text-success ps-4">${mand}</td>
                        <td class="ps-4">${os}</td>
                        <td class="fw-bold text-center">${comprobante}</td>
                        <td class="ps-4"><span class="badge bg-secondary">${tipo}</span></td>
                        <td class="text-end pe-4">$${imp.toFixed(2)}</td>
                        <td class="text-end pe-4 text-danger">$${deb.toFixed(2)}</td>
                        <td class="text-end pe-4 fw-bold fs-6">$${neto.toFixed(2)}</td>
                        <td class="text-center">
                            <button class="btn btn-warning btn-sm" onclick="editarCobro(${id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarCobro(${id})">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-muted">No se encontraron cobros.</td></tr>';
            }
        } catch (e) { tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error de conexi√≥n.</td></tr>'; }
    }

    function calcularTotalNeto() {
        const imp = parseFloat(document.getElementById('cobroImporte').value) || 0;
        const deb = parseFloat(document.getElementById('cobroDebitos').value) || 0;
        document.getElementById('lblTotalNeto').textContent = `$${(imp - deb).toFixed(2)}`;
    }

    // MODAL
    async function abrirModalCobro(id) {
        document.getElementById('cobroId').value = id; // IMPORTANTE
        document.getElementById('tituloModal').textContent = (id === 0) ? "REGISTRAR COBRO" : "EDITAR COBRO";
        
        if (id === 0) {
            document.getElementById('txtCobroMandataria').value = ""; document.getElementById('cobroMandataria').value = "0";
            document.getElementById('txtCobroOS').value = ""; document.getElementById('cobroOS').value = "0";
            document.getElementById('txtCobroOS').disabled = true; document.getElementById('txtCobroOS').placeholder = "Primero Mandataria...";
            fuentesDatos['txtCobroOS'] = [];
            document.getElementById('cobroImporte').value = "0.00"; document.getElementById('cobroDebitos').value = "0.00";
            document.getElementById('cobroComprobante').value = ""; document.getElementById('cobroMotivoDebito').value = "";
            calcularTotalNeto();
            modalCobro.show();
        } else {
            await editarCobro(id);
        }
    }

    async function editarCobro(id) {
        document.getElementById('cobroId').value = id; // FIX EDICI√ìN

        try {
            const r = await fetch(`@Url.Action("ObtenerCobroPorId", "Home")?idCobro=${id}`);
            const res = await r.json();

            if (res.success) {
                const d = res.data;
                const idMand = res.idMandataria;

                const mandInfo = fuentesDatos['txtCobroMandataria'].find(m => m.id == idMand);
                document.getElementById('cobroMandataria').value = idMand;
                document.getElementById('txtCobroMandataria').value = mandInfo ? mandInfo.nombre : "Desconocida";

                await cargarOS_Ajax(idMand, 'txtCobroOS', 'cobroOS');
                
                const idOS = d.idObrasSociales || d.IdObrasSociales;
                const osInfo = fuentesDatos['txtCobroOS'].find(o => o.id == idOS);
                document.getElementById('cobroOS').value = idOS;
                document.getElementById('txtCobroOS').value = osInfo ? osInfo.nombre : "Desconocida";

                let fecha = d.fechaCobro || d.FechaCobro;
                if(fecha) document.getElementById('cobroFecha').value = fecha.split('T')[0];
                
                document.getElementById('cobroTipo').value = d.tipoPago || d.TipoPago;
                document.getElementById('cobroComprobante').value = d.numeroComprobante || d.NumeroComprobante;
                document.getElementById('cobroImporte').value = d.importeCobrado || d.ImporteCobrado;
                document.getElementById('cobroDebitos').value = d.montoDebitos || d.MontoDebitos;
                document.getElementById('cobroMotivoDebito').value = d.motivoDebito || d.MotivoDebito || "";

                calcularTotalNeto();
                modalCobro.show();
            } else { alert("Error: " + res.message); }
        } catch (e) { alert("Error obteniendo datos."); }
    }

    async function guardarCobro() {
        if(document.getElementById('cobroOS').value == "0") { alert("Seleccione Obra Social."); return; }

        const fd = new FormData();
        fd.append("IdCobro", document.getElementById('cobroId').value);
        fd.append("IdObraSocial", document.getElementById('cobroOS').value);
        fd.append("FechaCobro", document.getElementById('cobroFecha').value);
        fd.append("TipoPago", document.getElementById('cobroTipo').value);
        fd.append("NumeroComprobante", document.getElementById('cobroComprobante').value);
        fd.append("ImporteCobrado", document.getElementById('cobroImporte').value.replace('.', ','));
        fd.append("MontoDebitos", document.getElementById('cobroDebitos').value.replace('.', ','));
        fd.append("MotivoDebito", document.getElementById('cobroMotivoDebito').value);
        fd.append("IdLiquidacion", 0);

        try {
            const r = await fetch('@Url.Action("GuardarCobro", "Home")', { method: 'POST', body: fd });
            const res = await r.json();
            if (res.success) { alert("‚úÖ " + res.message); modalCobro.hide(); buscarCobros(); } 
            else { alert("‚ùå " + res.message); }
        } catch (e) { alert("Error al guardar."); }
    }

    async function eliminarCobro(id) {
        if (!confirm("¬øEliminar cobro?")) return;
        const fd = new FormData(); fd.append("idCobro", id);
        try {
            const r = await fetch('@Url.Action("EliminarCobro", "Home")', { method: 'POST', body: fd });
            const res = await r.json();
            if (res.success) { buscarCobros(); } else { alert("Error: " + res.message); }
        } catch (e) { alert("Error al eliminar."); }
    }

    function limpiarFiltros() {
        document.getElementById('txtFiltroMandataria').value = ""; document.getElementById('filtroMandataria').value = "0";
        document.getElementById('txtFiltroOS').value = ""; document.getElementById('filtroOS').value = "0";
        document.getElementById('txtFiltroOS').disabled = true; fuentesDatos['txtFiltroOS'] = [];
        document.getElementById('filtroComprobante').value = "";
        document.getElementById('filtroFechaDesde').value = ""; document.getElementById('filtroFechaHasta').value = "";
        buscarCobros();
    }
</script>
}