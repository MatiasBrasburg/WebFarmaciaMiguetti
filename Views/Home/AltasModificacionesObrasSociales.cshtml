@using System.Text.Json
@using System.Text.Encodings.Web
@using System.Text.Unicode
@using System.Linq
@using WebFarmaciaMiguetti.Models 

@{
    ViewData["Title"] = "Gesti√≥n de Obras Sociales";

    // =========================================================================
    // 1. RECUPERACI√ìN Y PREPARACI√ìN DE DATOS (Backend en la Vista)
    // =========================================================================
    var listaOS = (ViewBag.ListaObrasSociales as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var listaMandatarias = (ViewBag.ListaMandatarias as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();

    // Ordenamiento preventivo
    if (listaOS.Any())
    {
        try { listaOS = listaOS.OrderBy(x => x.NombreOS).ToList(); } catch { }
    }

    // Configuraci√≥n JSON para aceptar √ë y Acentos sin romper el JS
    var opcionesJson = new JsonSerializerOptions
    {
        Encoder = JavaScriptEncoder.Create(UnicodeRanges.All),
        WriteIndented = false
    };

    // A. DATOS PARA EL BUSCADOR PRINCIPAL (Spotify Lite)
    var datosBuscadorPrincipal = listaOS.Select(os => {
        string nombreMand = "Sin Asignar";
        var mand = listaMandatarias.FirstOrDefault(m => m.IdMandatarias == os.IdMandataria);
        if (mand != null) { nombreMand = mand.RazonSocial; }

        return new {
            id = os.IdObrasSociales,
            texto = os.Nombre + " (Mandataria: " + nombreMand + ")",
            nombre = os.Nombre
        };
    });
    var jsonOS = JsonSerializer.Serialize(datosBuscadorPrincipal, opcionesJson);

    // B. DATOS PARA EL BUSCADOR DEL MODAL
    var datosBuscadorModal = listaMandatarias.Select(m => new {
        id = m.IdMandatarias,
        texto = m.RazonSocial + " (CUIT: " + (m.Cuit > 0 ? m.Cuit.ToString() : "-") + ")",
        nombre = m.RazonSocial
    });
    var jsonMandatarias = JsonSerializer.Serialize(datosBuscadorModal, opcionesJson);
}

@* =========================================================================
   2. ESTILOS ESPEC√çFICOS (UX 85 A√ëOS)
   ========================================================================= *@
<style>
    /* Tipograf√≠a robusta */
    body { font-family: 'Roboto', 'Open Sans', Arial, sans-serif; background-color: #f8f9fa; }
    
    h1 { 
        font-size: clamp(2rem, 5vw, 2.8rem); 
        font-weight: 800; 
        color: #000; 
        margin-bottom: 2rem; 
        text-transform: uppercase;
        border-bottom: 5px solid #000;
        padding-bottom: 10px;
    }

    .container-fluid { width: 95%; max-width: 1600px; margin: 0 auto; }

    /* BOTONES GIGANTES (Ley de Fitts) */
    .btn-giant {
        font-size: 1.3rem;
        padding: 12px 25px;
        font-weight: bold;
        border: 3px solid rgba(0,0,0,0.2);
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        margin-right: 5px;
        margin-bottom: 5px;
        text-transform: uppercase;
    }
    .btn-giant:hover { transform: scale(1.02); filter: brightness(1.1); }
    
    /* Colores funcionales */
    .btn-success { background-color: #157347; color: white; }
    .btn-warning { background-color: #ffca2c; color: black; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-info { background-color: #0dcaf0; color: black; }

    /* BUSCADOR SPOTIFY */
    .buscador-container {
        position: relative;
        max-width: 600px;
        width: 100%;
    }
    .input-buscador {
        font-size: 1.4rem;
        padding: 15px;
        border: 4px solid #0d6efd;
        border-radius: 8px;
        font-weight: bold;
        width: 100%;
        background-color: #fff;
    }
    .input-buscador:focus {
        outline: none;
        box-shadow: 0 0 15px rgba(13, 110, 253, 0.5);
        background-color: #f0f8ff;
    }

    /* LISTA DE SUGERENCIAS */
    .lista-sugerencias {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: white;
        border: 3px solid #000;
        z-index: 9999;
        max-height: 400px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    .item-sugerencia {
        padding: 15px;
        font-size: 1.2rem;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        font-weight: 500;
        color: #000;
    }
    .item-sugerencia:hover {
        background-color: #0d6efd;
        color: white;
        font-weight: bold;
    }

    /* TABLA ALTA LEGIBILIDAD */
    .table-responsive { border: 3px solid #000; background: white; margin-top: 20px; }
    .table thead th {
        background-color: #212529;
        color: white;
        font-size: 1.3rem;
        text-align: center;
        vertical-align: middle;
        padding: 15px;
    }
    .table tbody td {
        font-size: 1.2rem;
        vertical-align: middle;
        padding: 15px;
        color: #000;
        font-weight: 500;
    }
    
    /* Animaci√≥n de fila encontrada */
    @@keyframes highlightRow {
        0% { background-color: #ffeb3b; transform: scale(1.02); }
        50% { background-color: #ffeb3b; transform: scale(1); }
        100% { background-color: transparent; }
    }
    .fila-destacada {
        animation: highlightRow 4s ease-out forwards;
        border: 4px solid #ffc107 !important;
    }

    /* MODALES */
    .modal-content { border: 4px solid #000; }
    .modal-header { padding: 20px; }
    .modal-title { font-size: 1.8rem; font-weight: 800; }
    .form-label { font-size: 1.2rem; font-weight: bold; color: #333; }
    .form-control { border: 2px solid #555; padding: 12px; font-size: 1.2rem; }
    .form-control:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13,110,253,0.25); }
    
    /* Checkbox Grande */
    .form-check-input { width: 2em; height: 2em; border: 2px solid #333; cursor: pointer; }
    .form-check-label { font-size: 1.3rem; margin-left: 10px; padding-top: 5px; cursor: pointer; font-weight: bold; }
    .card-check { background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
</style>

@* =========================================================================
   3. ESTRUCTURA HTML
   ========================================================================= *@

<div class="container-fluid mt-5">
    
    <div class="row align-items-center mb-4">
        <div class="col-12 col-xl-6">
            <h1>üè• GESTI√ìN DE OBRAS SOCIALES</h1>
            <button type="button" class="btn btn-success btn-giant w-100 w-md-auto" onclick="window.abrirModalAgregar()">
                ‚ûï NUEVA OBRA SOCIAL
            </button>
        </div>
        
        <div class="col-12 col-xl-6 mt-3 mt-xl-0 d-flex justify-content-xl-end justify-content-center">
            <div class="buscador-container">
                <label for="inputBuscadorMain" class="form-label mb-1">üîç BUSCAR R√ÅPIDO (Spotify Lite):</label>
                <input type="text" class="input-buscador" id="inputBuscadorMain" 
                       placeholder="Escrib√≠ Nombre o Mandataria..." autocomplete="off">
                <div id="listaSugerenciasMain" class="lista-sugerencias"></div>
            </div>
        </div>
    </div>

    @if (TempData["MensajeExito"] != null) {
        <div class="alert alert-success alert-dismissible fade show fs-4 fw-bold shadow" role="alert">
            ‚úÖ @TempData["MensajeExito"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["MensajeError"] != null) {
        <div class="alert alert-danger alert-dismissible fade show fs-4 fw-bold shadow" role="alert">
            ‚ùå @TempData["MensajeError"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="table-responsive shadow">
        <table class="table table-bordered table-hover table-striped mb-0">
            <thead>
                <tr>
                    <th style="width: 50px;">ID</th>
                    <th>NOMBRE O.S.</th>
                    <th>MANDATARIA</th>
                    <th>PLAN / COD</th>
                    <th>PREPAGA</th>
                    <th>ESTADO</th>
                    <th style="width: 200px;">ACCIONES</th>
                </tr>
            </thead>
            <tbody id="tbodyOS">
                @if (listaOS != null && listaOS.Count > 0)
                {
                    @foreach (var os in listaOS)
                    {
                        // L√≥gica "on the fly" para mostrar nombres
                        string nombreMandataria = "-";
                        int idMand = os.IdMandataria;
                        var objMand = listaMandatarias.FirstOrDefault(m => m.IdMandatarias == idMand);
                        if(objMand != null) { nombreMandataria = objMand.RazonSocial; }

                        // JS Safe Strings
                        string nombreOsJs = System.Web.HttpUtility.JavaScriptStringEncode(os.Nombre);
                        string nombreMandJs = System.Web.HttpUtility.JavaScriptStringEncode(nombreMandataria);
                        string nombrePlanJs = System.Web.HttpUtility.JavaScriptStringEncode(os.NombreCodigoBonificacion ?? "");
                        
                        <tr class="fila-os" id="fila-@os.IdObrasSociales" data-id="@os.IdObrasSociales">
                            <td class="fw-bold text-center">@os.IdObrasSociales</td>
                            <td class="fw-bold text-primary">@os.Nombre</td>
                            <td>@nombreMandataria</td>
                            <td>
                                <div><strong>Plan:</strong> @(string.IsNullOrEmpty(os.NombreCodigoBonificacion) ? "-" : os.NombreCodigoBonificacion)</div>
                                <div class="text-muted small">C√≥d: @(os.CodigoBonificacion > 0 ? os.CodigoBonificacion.ToString() : "-")</div>
                            </td>
                            <td class="text-center">
                                @if(os.EsPrepaga == true) { <span class="badge bg-warning text-dark fs-6">S√ç</span> } else { <span>NO</span> }
                            </td>
                            <td class="text-center">
                                @if(os.Activa == true) { <span class="badge bg-success fs-6">ACTIVA</span> } else { <span class="badge bg-danger fs-6">BAJA</span> }
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-warning btn-lg mb-1" title="Editar"
                                        onclick="window.abrirModalModificar(@os.IdObrasSociales, '@nombreOsJs', @os.IdMandataria, '@nombreMandJs', @((os.EsPrepaga == true).ToString().ToLower()), @((os.Activa == true).ToString().ToLower()))">
                                    ‚úèÔ∏è
                                </button>
                                
                                <button type="button" class="btn btn-info btn-lg mb-1" title="Planes"
                                        onclick="window.abrirModalPlanes(@os.IdObrasSociales, '@nombreOsJs', '@(os.CodigoBonificacion ?? 0)', '@nombrePlanJs')">
                                    üìã
                                </button>

                                <button type="button" class="btn btn-danger btn-lg mb-1" title="Eliminar"
                                        onclick="window.abrirModalEliminar(@os.IdObrasSociales, '@nombreOsJs')">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="7" class="text-center p-5 fs-3 text-muted">No hay Obras Sociales cargadas en el sistema.</td></tr>
                }
            </tbody>
        </table>
    </div>
</div>

@* =========================================================================
   4. MODALES (VENTANAS EMERGENTES)
   ========================================================================= *@

<div class="modal fade" id="modalOS" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form method="post" asp-controller="Home" asp-action="ABM_OS">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="modalTitulo">GESTI√ìN</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" name="IdOS" id="inputIdOS" value="0">
                    <input type="hidden" name="QueToco" id="inputQueToco" value="">
                    <input type="hidden" name="IdMandatarias" id="inputIdMandatariaHidden" value="0">

                    <div id="divFormulario">
                        <div class="mb-4">
                            <label class="form-label">üè• NOMBRE DE LA OBRA SOCIAL:</label>
                            <input type="text" class="form-control" name="NombreOS" id="inputNombreOS" required placeholder="Ej: OSDE, PAMI...">
                        </div>

                        <div class="mb-4 position-relative">
                            <label class="form-label">üè¢ MANDATARIA (Qui√©n paga):</label>
                            <input type="text" class="form-control" id="inputMandatariaModal" 
                                   placeholder="Escriba para buscar mandataria..." autocomplete="off" required>
                            <div id="listaSugerenciasModal" class="lista-sugerencias"></div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check card-check">
                                    <input class="form-check-input" type="checkbox" name="EsPrepaga" id="chkEsPrepaga" value="true">
                                    <label class="form-check-label" for="chkEsPrepaga">Es Prepaga / Mutual</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check card-check">
                                    <input class="form-check-input" type="checkbox" name="Activa" id="chkActiva" value="true" checked>
                                    <label class="form-check-label" for="chkActiva">Est√° Activa</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="divMensajeEliminar" class="alert alert-danger text-center p-5" style="display:none;">
                        <h3 class="fw-bold">‚ö†Ô∏è ¬øEST√Å SEGURO?</h3>
                        <p class="fs-4">Se eliminar√°: <span id="spanNombreEliminar" class="fw-bold text-decoration-underline"></span></p>
                        <p class="mb-0">Esta acci√≥n no se puede deshacer.</p>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary btn-giant" data-bs-dismiss="modal">‚ùå CANCELAR</button>
                    <button type="submit" class="btn btn-success btn-giant" id="btnConfirmarModal">‚úÖ CONFIRMAR</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPlanes" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-info">
            <form method="post" asp-controller="Home" asp-action="ABM_OS">
                <div class="modal-header bg-info text-dark">
                    <h5 class="modal-title">üìã PLANES DE: <span id="spanNombreOSPlan"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" name="IdOS" id="inputIdOSPlan" value="0">
                    <input type="hidden" name="QueToco" value="Planes">

                    <div class="mb-3">
                        <label class="form-label">üìù NOMBRE DEL PLAN:</label>
                        <input type="text" class="form-control" name="NombreCodigoBonificacion" id="inputNombrePlan" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">üî¢ C√ìDIGO BONIFICACI√ìN:</label>
                        <input type="number" class="form-control" name="CodigoBonificacion" id="inputCodigoPlan" required>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary btn-giant" data-bs-dismiss="modal">‚ùå CERRAR</button>
                    <button type="submit" class="btn btn-info btn-giant">üíæ GUARDAR PLAN</button>
                </div>
            </form>
        </div>
    </div>
</div>

@* =========================================================================
   5. L√ìGICA JAVASCRIPT (MODERNA Y ROBUSTA)
   ========================================================================= *@
@section Scripts {
<script>
    // Usamos 'DOMContentLoaded' para asegurar que TODO el HTML existe antes de ejecutar nada
    document.addEventListener("DOMContentLoaded", function() {
        
        // --- 1. DATOS SERIALIZADOS DESDE C# ---
        const datosBuscadorMain = @Html.Raw(jsonOS);
        const datosBuscadorModal = @Html.Raw(jsonMandatarias);

        // --- 2. BUSCADOR SPOTIFY LITE (PRINCIPAL) ---
        const inputMain = document.getElementById('inputBuscadorMain');
        const listaMain = document.getElementById('listaSugerenciasMain');
        const tbody = document.getElementById('tbodyOS');

        if(inputMain) {
            inputMain.addEventListener('input', function() {
                const texto = this.value.toLowerCase().trim();
                listaMain.innerHTML = ''; 
                
                if (texto.length === 0) { listaMain.style.display = 'none'; return; }

                // Filtrar (Buscamos en el texto pre-armado que incluye mandataria)
                const coincidencias = datosBuscadorMain.filter(item => 
                    item.texto && item.texto.toLowerCase().includes(texto)
                );

                if (coincidencias.length === 0) { listaMain.style.display = 'none'; return; }

                // Mostrar sugerencias
                coincidencias.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'item-sugerencia';
                    div.innerHTML = item.texto; // Ya viene formateado con Mandataria
                    div.onclick = () => {
                        inputMain.value = item.nombre;
                        listaMain.style.display = 'none';
                        moverFilaAlPrincipio(item.id);
                    };
                    listaMain.appendChild(div);
                });
                listaMain.style.display = 'block'; 
            });
        }

        // --- 3. FUNCI√ìN DE REORDENAMIENTO VISUAL ---
        window.moverFilaAlPrincipio = function(id) {
            const fila = document.getElementById('fila-' + id);
            if (fila) {
                // Removemos la clase de animaci√≥n si ya la ten√≠a para reiniciarla
                fila.classList.remove('fila-destacada');
                
                // Mover al principio del tbody
                tbody.prepend(fila);
                
                // Forzar un "reflow" para que el navegador note el cambio antes de animar
                void fila.offsetWidth; 
                
                // Agregar clase de animaci√≥n y hacer scroll
                fila.classList.add('fila-destacada');
                fila.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                alert("La fila con ID " + id + " no se encuentra en la vista actual.");
            }
        };

        // --- 4. BUSCADOR DENTRO DEL MODAL (MANDATARIAS) ---
        const inputMandModal = document.getElementById('inputMandatariaModal');
        const inputIdMandHidden = document.getElementById('inputIdMandatariaHidden');
        const listaModal = document.getElementById('listaSugerenciasModal');

        if(inputMandModal) {
            inputMandModal.addEventListener('input', function() {
                const texto = this.value.toLowerCase().trim();
                listaModal.innerHTML = '';
                inputIdMandHidden.value = "0"; // Resetear ID si el usuario edita el texto

                if (texto.length === 0) { listaModal.style.display = 'none'; return; }

                const coincidencias = datosBuscadorModal.filter(item => 
                    item.texto && item.texto.toLowerCase().includes(texto)
                );

                if (coincidencias.length === 0) { listaModal.style.display = 'none'; return; }

                coincidencias.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'item-sugerencia';
                    div.innerHTML = item.texto;
                    div.onclick = () => {
                        inputMandModal.value = item.nombre;
                        inputIdMandHidden.value = item.id;
                        listaModal.style.display = 'none';
                    };
                    listaModal.appendChild(div);
                });
                listaModal.style.display = 'block'; 
            });
        }

        // Cerrar listas al hacer clic afuera
        document.addEventListener('click', function(e) {
            if (inputMain && e.target !== inputMain && e.target !== listaMain) { 
                listaMain.style.display = 'none'; 
            }
            if (inputMandModal && e.target !== inputMandModal && e.target !== listaModal) { 
                listaModal.style.display = 'none'; 
            }
        });
    });

    // =========================================================================
    // 6. FUNCIONES GLOBALES (ACCESIBLES DESDE ONCLICK HTML)
    // =========================================================================
    
    // Instancias de Modales Bootstrap (se crean al llamar la funci√≥n para evitar errores de carga)
    let modalOS_BS = null;
    let modalPlanes_BS = null;

    function getModalOS() {
        if(!modalOS_BS) modalOS_BS = new bootstrap.Modal(document.getElementById('modalOS'));
        return modalOS_BS;
    }
    function getModalPlanes() {
        if(!modalPlanes_BS) modalPlanes_BS = new bootstrap.Modal(document.getElementById('modalPlanes'));
        return modalPlanes_BS;
    }

    // ABRIR MODAL AGREGAR
    window.abrirModalAgregar = function() {
        document.getElementById('modalTitulo').textContent = '‚ûï AGREGAR OBRA SOCIAL';
        const btn = document.getElementById('btnConfirmarModal');
        btn.className = 'btn btn-success btn-giant';
        btn.innerHTML = 'üíæ GUARDAR';

        document.getElementById('inputQueToco').value = 'Agregar';
        document.getElementById('inputIdOS').value = '0';
        document.getElementById('inputNombreOS').value = '';
        document.getElementById('inputMandatariaModal').value = '';
        document.getElementById('inputIdMandatariaHidden').value = '0';
        document.getElementById('chkEsPrepaga').checked = false;
        document.getElementById('chkActiva').checked = true;

        // Requerir campos
        document.getElementById('inputNombreOS').required = true;
        document.getElementById('inputMandatariaModal').required = true;

        document.getElementById('divFormulario').style.display = 'block';
        document.getElementById('divMensajeEliminar').style.display = 'none';

        getModalOS().show();
        setTimeout(() => document.getElementById('inputNombreOS').focus(), 500);
    };

    // ABRIR MODAL MODIFICAR
    window.abrirModalModificar = function(id, nombre, idMand, nombreMand, esPrepaga, activa) {
        document.getElementById('modalTitulo').textContent = '‚úèÔ∏è EDITAR OBRA SOCIAL';
        const btn = document.getElementById('btnConfirmarModal');
        btn.className = 'btn btn-warning btn-giant';
        btn.innerHTML = 'üíæ GUARDAR CAMBIOS';

        document.getElementById('inputQueToco').value = 'Modificar';
        document.getElementById('inputIdOS').value = id;
        document.getElementById('inputNombreOS').value = nombre;
        document.getElementById('inputIdMandatariaHidden').value = idMand;
        document.getElementById('inputMandatariaModal').value = nombreMand;
        document.getElementById('chkEsPrepaga').checked = esPrepaga;
        document.getElementById('chkActiva').checked = activa;

        document.getElementById('inputNombreOS').required = true;
        document.getElementById('inputMandatariaModal').required = true;

        document.getElementById('divFormulario').style.display = 'block';
        document.getElementById('divMensajeEliminar').style.display = 'none';

        getModalOS().show();
    };

    // ABRIR MODAL ELIMINAR
    window.abrirModalEliminar = function(id, nombre) {
        document.getElementById('modalTitulo').textContent = 'üóëÔ∏è ELIMINAR';
        const btn = document.getElementById('btnConfirmarModal');
        btn.className = 'btn btn-danger btn-giant';
        btn.innerHTML = 'üóëÔ∏è CONFIRMAR ELIMINACI√ìN';

        document.getElementById('inputQueToco').value = 'Eliminar';
        document.getElementById('inputIdOS').value = id;
        document.getElementById('spanNombreEliminar').textContent = nombre;

        // No validar campos ocultos
        document.getElementById('inputNombreOS').required = false;
        document.getElementById('inputMandatariaModal').required = false;

        document.getElementById('divFormulario').style.display = 'none';
        document.getElementById('divMensajeEliminar').style.display = 'block';

        getModalOS().show();
    };

    // ABRIR MODAL PLANES
    window.abrirModalPlanes = function(id, nombreOS, codigo, nombrePlan) {
        document.getElementById('inputIdOSPlan').value = id;
        document.getElementById('spanNombreOSPlan').textContent = nombreOS;
        document.getElementById('inputCodigoPlan').value = (codigo == '0') ? '' : codigo;
        document.getElementById('inputNombrePlan').value = nombrePlan;
        
        getModalPlanes().show();
        setTimeout(() => document.getElementById('inputNombrePlan').focus(), 500);
    };
</script>
}