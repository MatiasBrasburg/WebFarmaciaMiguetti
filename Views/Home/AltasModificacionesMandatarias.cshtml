@using System.Text.Json
@using System.Linq
@{
    ViewData["Title"] = "Gesti√≥n de Mandatarias";
    var listaMandatarias = (ViewBag.ListaMandatarias as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    // Ordenar alfab√©ticamente por RazonSocial
    if (listaMandatarias.Any())
    {
        listaMandatarias = listaMandatarias.OrderBy(m => m.RazonSocial).ToList();
    }
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<style>
    /* ========== DISE√ëO RESPONSIVO PARA 85 A√ëOS ========== */
    body {
        font-family: 'Roboto', 'Open Sans', Arial, sans-serif;
        font-size: clamp(16px, 2vw, 18px);
        line-height: 1.6;
        background-color: #f8f9fa;
    }

    h1 {
        font-size: clamp(2rem, 5vw, 2.8rem);
        font-weight: bold;
        color: #000000;
        margin-bottom: 2rem;
    }

    .container {
        width: 95%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
    }

    /* Tabla con alto contraste - RESPONSIVA */
    .table {
        font-size: clamp(1rem, 1.5vw, 1.2rem);
        border: 3px solid #000000;
        width: 100%;
    }

    .table th {
        background-color: #343a40;
        color: #ffffff;
        font-weight: bold;
        font-size: clamp(1.1rem, 1.8vw, 1.3rem);
        padding: clamp(0.5rem, 1vw, 0.7rem);
        border: 2px solid #000000;
    }

    .table td {
        padding: clamp(0.5rem, 1vw, 0.7rem);
        border: 2px solid #dee2e6;
        color: #000000;
        background-color: #ffffff;
        vertical-align: middle;
        word-wrap: break-word;
    }

    /* Buscador arriba a la derecha */
    .buscador-container {
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 1rem;
    }

    .input-buscador {
        font-size: clamp(1.1rem, 1.8vw, 1.3rem);
        padding: clamp(0.6rem, 1vw, 0.8rem);
        border: 3px solid #0d6efd;
        font-weight: bold;
        width: 100%;
        max-width: 400px;
    }

    .input-buscador:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.4rem rgba(13, 110, 253, 0.3);
    }

    /* Botones GIGANTES - RESPONSIVOS */
    .btn-giant {
        font-size: clamp(1rem, 2vw, 1.4rem);
        padding: clamp(0.8rem, 1.5vw, 1rem) clamp(1rem, 2vw, 2rem);
        font-weight: bold;
        border: 3px solid;
        margin: 0.3rem;
        white-space: nowrap;
    }

    .btn-success {
        background-color: #198754;
        border-color: #198754;
        color: #ffffff;
    }

    .btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #000000;
    }

    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
        color: #ffffff;
    }

    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: #ffffff;
    }

    /* Inputs de formulario con bordes gruesos */
    .form-control {
        font-size: clamp(1.1rem, 2vw, 1.3rem);
        padding: clamp(0.8rem, 1.5vw, 1rem);
        border: 3px solid #6c757d;
    }

    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.3rem rgba(13, 110, 253, 0.5);
        outline: none;
    }

    .form-label {
        font-size: clamp(1.1rem, 2vw, 1.3rem);
        font-weight: bold;
        color: #000000;
        margin-bottom: 0.5rem;
    }

    /* Alertas GRANDES para feedback visual */
    .alert {
        font-size: clamp(1.2rem, 2vw, 1.4rem);
        padding: 1.5rem;
        border: 3px solid;
        font-weight: bold;
    }

    .alert-success {
        background-color: #d1e7dd;
        border-color: #198754;
        color: #000000;
    }

    .alert-danger {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #000000;
    }

    /* Modal con contraste alto */
    .modal-header {
        background-color: #343a40;
        color: #ffffff;
        border-bottom: 3px solid #000000;
    }

    .modal-title {
        font-size: clamp(1.4rem, 3vw, 1.8rem);
        font-weight: bold;
    }

    .modal-body {
        font-size: clamp(1rem, 2vw, 1.2rem);
        padding: clamp(1rem, 2vw, 2rem);
    }

    .modal-footer {
        border-top: 3px solid #dee2e6;
        padding: 1.5rem;
    }

    .mb-3 {
        margin-bottom: 1.5rem;
    }

    .form-text {
        font-size: clamp(0.9rem, 1.5vw, 1.1rem);
        color: #6c757d;
    }

    /* Ocultar filas que no coinciden con la b√∫squeda */
    .hidden-row {
        display: none !important;
    }

    /* FORZAR que las filas se muestren por defecto */
    .fila-mandataria {
        display: table-row !important;
    }

    /* ========== MEDIA QUERIES PARA M√ìVIL ========== */
    @@media (max-width: 768px) {
        h1 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .container {
            padding: 0.5rem;
        }

        .buscador-container {
            flex-direction: column;
            align-items: stretch;
        }

        .input-buscador {
            max-width: 100%;
        }

        /* Tabla en m√≥vil: Convertir a cards */
        .table thead {
            display: none;
        }

        .table, .table tbody, .table tr, .table td {
            display: block;
            width: 100%;
        }

        .table tr {
            margin-bottom: 1rem;
            border: 3px solid #000000;
            background-color: #ffffff;
            padding: 1rem;
        }

        .table td {
            text-align: left;
            padding: 0.5rem;
            border: none;
            border-bottom: 1px solid #dee2e6;
            position: relative;
            padding-left: 45%;
        }

        .table td:last-child {
            border-bottom: none;
        }

        .table td::before {
            content: attr(data-label);
            position: absolute;
            left: 0.5rem;
            font-weight: bold;
            color: #343a40;
            width: 40%;
        }

        .btn-giant {
            width: 100%;
            margin: 0.5rem 0;
            font-size: 1.2rem;
            padding: 1rem;
        }

        .modal-dialog {
            margin: 0.5rem;
        }
    }

    /* ========== MEDIA QUERIES PARA TABLET ========== */
    @@media (min-width: 769px) and (max-width: 1024px) {
        .btn-giant {
            font-size: 1.1rem;
            padding: 0.8rem 1rem;
            min-width: 140px;
        }

        .table {
            font-size: 1rem;
        }

        .table th {
            font-size: 1.1rem;
        }
    }

    /* ========== MEDIA QUERIES PARA DESKTOP GRANDE ========== */
    @@media (min-width: 1400px) {
        .container {
            max-width: 1600px;
        }

        .btn-giant {
            font-size: 1.5rem;
            padding: 1.2rem 2.5rem;
        }

        .table {
            font-size: 1.3rem;
        }
    }
</style>

<div class="container mt-5">
    <h1>üìã GESTI√ìN DE MANDATARIAS</h1>

    <!-- MENSAJES DE FEEDBACK -->
    @if (ViewBag.MensajeExito != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @ViewBag.MensajeExito
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
    }

    @if (TempData["MensajeError"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["MensajeError"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
    }

    <!-- BOT√ìN AGREGAR NUEVA MANDATARIA -->
    <div class="mb-4">
        <button type="button" class="btn btn-success btn-giant" onclick="abrirModalAgregar()">
            ‚ûï AGREGAR NUEVA
        </button>
    </div>

    <!-- BUSCADOR ARRIBA A LA DERECHA DE LA TABLA -->
    <div class="buscador-container">
        <label for="inputBuscador" style="font-size: clamp(1.1rem, 2vw, 1.3rem); font-weight: bold; white-space: nowrap;">üîç BUSCAR:</label>
        <input type="text" 
               class="form-control input-buscador" 
               id="inputBuscador" 
               placeholder="Escriba para filtrar..." 
               onkeyup="filtrarTabla()"
               oninput="filtrarTabla()"
               onchange="filtrarTabla()">
    </div>

    <!-- TABLA DE MANDATARIAS (ORDENADA ALFAB√âTICAMENTE) -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover" id="tablaMandatarias">
            <thead>
                <tr>
                    <th style="width: 8%;">ID</th>
                    <th style="width: 25%;">RAZ√ìN SOCIAL</th>
                    <th style="width: 15%;">CUIT</th>
                    <th style="width: 20%;">DESCRIPCI√ìN</th>
                    <th style="width: 17%;">DIRECCI√ìN</th>
                    <th style="width: 15%;">ACCIONES</th>
                </tr>
            </thead>
            <tbody id="tbodyMandatarias">
                @if (listaMandatarias != null && listaMandatarias.Count > 0)
                {
                    @foreach (var mandataria in listaMandatarias)
                    {
                        <tr class="fila-mandataria" style="display: table-row;">
                            <td data-label="ID">@mandataria.IdMandatarias</td>
                            <td data-label="RAZ√ìN SOCIAL">@mandataria.RazonSocial</td>
                            <td data-label="CUIT">@(mandataria.Cuit > 0 ? mandataria.Cuit.ToString() : "-")</td>
                            <td data-label="DESCRIPCI√ìN">@(string.IsNullOrEmpty(mandataria.Descripcion) ? "-" : mandataria.Descripcion)</td>
                            <td data-label="DIRECCI√ìN">@(string.IsNullOrEmpty(mandataria.Direccion) ? "-" : mandataria.Direccion)</td>
                            <td data-label="ACCIONES">
                                <button type="button" class="btn btn-warning btn-giant" 
                                        onclick='abrirModalModificar(@mandataria.IdMandatarias, "@Html.Raw(System.Web.HttpUtility.JavaScriptStringEncode(mandataria.RazonSocial))", @(mandataria.Cuit), "@Html.Raw(System.Web.HttpUtility.JavaScriptStringEncode(mandataria.Descripcion ?? ""))", "@Html.Raw(System.Web.HttpUtility.JavaScriptStringEncode(mandataria.Direccion ?? ""))")'>
                                    ‚úèÔ∏è MODIFICAR
                                </button>
                                <button type="button" class="btn btn-danger btn-giant" 
                                        onclick='abrirModalEliminar(@mandataria.IdMandatarias, "@Html.Raw(System.Web.HttpUtility.JavaScriptStringEncode(mandataria.RazonSocial))")'>
                                    üóëÔ∏è ELIMINAR
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr style="display: table-row;">
                        <td colspan="6" class="text-center">No hay mandatarias registradas.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL REUTILIZABLE (UN SOLO MODAL PARA TODO) -->
<div class="modal fade" id="modalMandataria" tabindex="-1" aria-labelledby="modalTitulo" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-controller="Home" asp-action="ModificarMandataria">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">T√çTULO DEL MODAL</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <!-- Campo oculto para el ID (solo para Modificar/Eliminar) -->
                    <input type="hidden" name="IdMandataria" id="inputIdMandataria" value="0">
                    
                    <!-- Campo oculto para saber qu√© acci√≥n ejecutar -->
                    <input type="hidden" name="QueToco" id="inputQueToco" value="">

                    <!-- Formulario de Agregar/Modificar -->
                    <div id="divFormulario">
                        <!-- Campo 1: Raz√≥n Social (OBLIGATORIO) -->
                        <div class="mb-3">
                            <label for="inputNombreMandataria" class="form-label">üìù RAZ√ìN SOCIAL: *</label>
                            <input type="text" class="form-control" name="NombreMandataria" id="inputNombreMandataria" 
                                   placeholder="Escriba la raz√≥n social..." maxlength="200" required>
                        </div>

                        <!-- Campo 2: CUIT (OPCIONAL) -->
                        <div class="mb-3">
                            <label for="inputCuit" class="form-label">üî¢ CUIT:</label>
                            <input type="number" class="form-control" name="Cuit" id="inputCuit" 
                                   placeholder="Escriba el CUIT (solo n√∫meros)..." min="0" max="99999999999">
                            <small class="form-text">Campo opcional. Deje vac√≠o o en cero si no aplica.</small>
                        </div>

                        <!-- Campo 3: Descripci√≥n (OPCIONAL) -->
                        <div class="mb-3">
                            <label for="inputDescripcion" class="form-label">üìÑ DESCRIPCI√ìN:</label>
                            <textarea class="form-control" name="Descripcion" id="inputDescripcion" 
                                      placeholder="Escriba una descripci√≥n..." rows="3" maxlength="500"></textarea>
                            <small class="form-text">Campo opcional. Puede dejarlo vac√≠o.</small>
                        </div>

                        <!-- Campo 4: Direcci√≥n (OPCIONAL) -->
                        <div class="mb-3">
                            <label for="inputDireccion" class="form-label">üìç DIRECCI√ìN:</label>
                            <input type="text" class="form-control" name="Direccion" id="inputDireccion" 
                                   placeholder="Escriba la direcci√≥n..." maxlength="300">
                            <small class="form-text">Campo opcional. Puede dejarlo vac√≠o.</small>
                        </div>
                    </div>

                    <!-- Mensaje de confirmaci√≥n (visible solo en Eliminar) -->
                    <div id="divMensajeEliminar" style="display: none;">
                        <p style="font-size: clamp(1.2rem, 2vw, 1.4rem); color: #dc3545; font-weight: bold;">
                            ‚ö†Ô∏è ¬øEst√° seguro que desea eliminar la mandataria <strong id="spanNombreEliminar"></strong>?
                        </p>
                        <p style="font-size: clamp(1rem, 1.8vw, 1.2rem);">Esta acci√≥n no se puede deshacer.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-giant" data-bs-dismiss="modal">
                        ‚ùå CANCELAR
                    </button>
                    <button type="submit" class="btn btn-giant" id="btnConfirmarModal">
                        CONFIRMAR
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

@section Scripts {
<script>
    console.log('Script cargado correctamente');

    // ========== FILTRAR TABLA EN TIEMPO REAL (ESTILO SPOTIFY) ==========
    function filtrarTabla() {
        console.log('filtrarTabla ejecut√°ndose...');
        
        // Obtener el valor del input y convertir a min√∫sculas
        var input = document.getElementById('inputBuscador');
        
        if (!input) {
            console.error('NO SE ENCONTR√ì EL INPUT CON ID inputBuscador');
            return;
        }
        
        var filtro = input.value.toLowerCase();
        console.log('Texto buscado: "' + filtro + '"');
        
        // Obtener todas las filas con clase 'fila-mandataria'
        var filas = document.querySelectorAll('.fila-mandataria');
        console.log('Total de filas encontradas: ' + filas.length);
        
        // Si el input est√° vac√≠o, mostrar TODAS las filas
        if (filtro === '') {
            console.log('Input vac√≠o - mostrando todas las filas');
            filas.forEach(function(fila) {
                fila.style.display = 'table-row';
            });
            return;
        }
        
        var filasVisibles = 0;
        var filasOcultas = 0;
        
        // Recorrer cada fila y buscar coincidencias
        filas.forEach(function(fila) {
            // Obtener todo el texto de la fila (todas las celdas)
            var textoCompleto = fila.textContent.toLowerCase();
            
            // Si el texto de la fila incluye lo que estoy buscando, mostrarla
            if (textoCompleto.indexOf(filtro) !== -1) {
                fila.style.display = 'table-row';
                filasVisibles++;
            } else {
                fila.style.display = 'none';
                filasOcultas++;
            }
        });
        
        console.log('Filas visibles: ' + filasVisibles + ' | Filas ocultas: ' + filasOcultas);
    }

    // Verificar que el input existe cuando carga la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        var input = document.getElementById('inputBuscador');
        if (input) {
            console.log('‚úÖ Input del buscador encontrado correctamente');
            // Agregar listener por si acaso
            input.addEventListener('input', filtrarTabla);
        } else {
            console.error('‚ùå NO SE ENCONTR√ì EL INPUT DEL BUSCADOR');
        }
    });


    // REFERENCIAS AL MODAL Y SUS ELEMENTOS
    const modal = new bootstrap.Modal(document.getElementById('modalMandataria'));
    const modalTitulo = document.getElementById('modalTitulo');
    const inputIdMandataria = document.getElementById('inputIdMandataria');
    const inputQueToco = document.getElementById('inputQueToco');
    const inputNombreMandataria = document.getElementById('inputNombreMandataria');
    const inputCuit = document.getElementById('inputCuit');
    const inputDescripcion = document.getElementById('inputDescripcion');
    const inputDireccion = document.getElementById('inputDireccion');
    const divFormulario = document.getElementById('divFormulario');
    const divMensajeEliminar = document.getElementById('divMensajeEliminar');
    const spanNombreEliminar = document.getElementById('spanNombreEliminar');
    const btnConfirmarModal = document.getElementById('btnConfirmarModal');

    // FUNCI√ìN 1: ABRIR MODAL PARA AGREGAR (todos los campos vac√≠os)
    function abrirModalAgregar() {
        modalTitulo.textContent = '‚ûï AGREGAR NUEVA MANDATARIA';
        btnConfirmarModal.textContent = 'üíæ GUARDAR';
        btnConfirmarModal.className = 'btn btn-success btn-giant';

        inputQueToco.value = 'Agregar';
        inputIdMandataria.value = '0';
        inputNombreMandataria.value = '';
        inputCuit.value = '';
        inputDescripcion.value = '';
        inputDireccion.value = '';
        inputNombreMandataria.required = true;

        divFormulario.style.display = 'block';
        divMensajeEliminar.style.display = 'none';

        modal.show();
    }

    // FUNCI√ìN 2: ABRIR MODAL PARA MODIFICAR (TODOS los campos pre-llenados con datos actuales)
    function abrirModalModificar(id, nombreActual, cuitActual, descripcionActual, direccionActual) {
        modalTitulo.textContent = '‚úèÔ∏è MODIFICAR MANDATARIA';
        btnConfirmarModal.textContent = 'üíæ GUARDAR CAMBIOS';
        btnConfirmarModal.className = 'btn btn-warning btn-giant';

        inputQueToco.value = 'Modificar';
        inputIdMandataria.value = id;
        inputNombreMandataria.value = nombreActual;
        inputCuit.value = (cuitActual > 0) ? cuitActual : '';
        inputDescripcion.value = descripcionActual === '-' ? '' : descripcionActual || '';
        inputDireccion.value = direccionActual === '-' ? '' : direccionActual || '';
        inputNombreMandataria.required = true;

        divFormulario.style.display = 'block';
        divMensajeEliminar.style.display = 'none';

        modal.show();
    }

    // FUNCI√ìN 3: ABRIR MODAL PARA ELIMINAR (sin formulario, solo confirmaci√≥n)
    function abrirModalEliminar(id, nombre) {
        modalTitulo.textContent = 'üóëÔ∏è ELIMINAR MANDATARIA';
        btnConfirmarModal.textContent = 'üóëÔ∏è S√ç, ELIMINAR';
        btnConfirmarModal.className = 'btn btn-danger btn-giant';

        inputQueToco.value = 'Eliminar';
        inputIdMandataria.value = id;
        inputNombreMandataria.required = false;
        spanNombreEliminar.textContent = nombre;

        divFormulario.style.display = 'none';
        divMensajeEliminar.style.display = 'block';

        modal.show();
    }
</script>
}